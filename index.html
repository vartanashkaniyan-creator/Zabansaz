<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="ÿßŸæŸÑ€å⁄©€åÿ¥ŸÜ ÿ¢ŸÖŸàÿ≤ÿ¥ €±€≤ ÿ≤ÿ®ÿßŸÜ HyperLang - €åÿßÿØ⁄Ø€åÿ±€å ŸáŸàÿ¥ŸÖŸÜÿØÿå ÿ™ŸÖÿ±€åŸÜ ÿ™ÿπÿßŸÖŸÑ€åÿå Ÿæ€åÿ¥ÿ±ŸÅÿ™ ÿ¥ÿÆÿµ€å">
    <title>HyperLang - ÿ¢ŸÖŸàÿ≤ÿ¥ €±€≤ ÿ≤ÿ®ÿßŸÜ</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#1a237e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="./manifest.json" crossorigin="use-credentials">
    <link rel="icon" type="image/svg+xml" href="./assets/icon.svg">
    <link rel="apple-touch-icon" href="./assets/icon-192.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vazirmatn@33.003/font.css">
    
    <!-- Preload Critical Assets -->
    <link rel="preload" href="./CORE_db.js" as="script">
    <link rel="preload" href="./style.css" as="style">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="app-loading" class="app-loading">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text">
                <span id="loader-step">ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å Ÿáÿ≥ÿ™Ÿá...</span>
                <div class="loader-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="loader-progress"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error Boundary -->
    <div id="app-error" class="app-error" style="display: none;">
        <div class="error-content">
            <h2>ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ®ÿ±ŸÜÿßŸÖŸá</h2>
            <p id="error-message"></p>
            <div class="error-actions">
                <button id="retry-btn" class="btn btn-primary">ÿ™ŸÑÿßÿ¥ ŸÖÿ¨ÿØÿØ</button>
                <button id="reset-btn" class="btn btn-outline">ÿ®ÿßÿ≤ŸÜÿ¥ÿßŸÜ€å ⁄©ÿ¥</button>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="app-root" class="app-root" style="display: none;">
        <!-- Content injected by JavaScript -->
    </div>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.warn('SW registration failed:', err));
            });
        }
    </script>
    
    <!-- Main Application Script -->
    <script type="module">
        // ==================== HyperLang Bootloader v2.0 ====================
        // Enterprise-grade Application Loader with Error Handling & Performance Monitoring
        
        class AppBootloader {
            constructor() {
                this.version = '2.0.0';
                this.loadSteps = [
                    { id: 'core', name: 'ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å Ÿáÿ≥ÿ™Ÿá...', weight: 30 },
                    { id: 'modules', name: 'ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖÿß⁄òŸàŸÑ‚ÄåŸáÿß...', weight: 40 },
                    { id: 'ui', name: 'ÿ±ÿßŸá‚ÄåÿßŸÜÿØÿßÿ≤€å ÿ±ÿßÿ®ÿ∑ ⁄©ÿßÿ±ÿ®ÿ±€å...', weight: 20 },
                    { id: 'init', name: 'ÿ¢ŸÖÿßÿØŸá‚Äåÿ≥ÿßÿ≤€å ÿ®ÿ±ŸÜÿßŸÖŸá...', weight: 10 }
                ];
                
                this.performance = {
                    startTime: performance.now(),
                    marks: {}
                };
                
                this.state = {
                    loaded: false,
                    error: null,
                    progress: 0
                };
                
                this.modules = new Map();
                this.core = new Map();
                this.services = new Map();
                
                this.bindMethods();
            }
            
            bindMethods() {
                this.start = this.start.bind(this);
                this.loadCore = this.loadCore.bind(this);
                this.loadModules = this.loadModules.bind(this);
                this.loadUI = this.loadUI.bind(this);
                this.handleError = this.handleError.bind(this);
                this.updateProgress = this.updateProgress.bind(this);
            }
            
            // ==================== CORE LOADING ====================
            async loadCore() {
                this.performance.marks.coreStart = performance.now();
                this.updateProgress('core');
                
                const coreFiles = [
                    { name: 'state', file: 'CORE_state.js', required: true },
                    { name: 'db', file: 'CORE_db.js', required: true },
                    { name: 'router', file: 'CORE_router.js', required: true },
                    { name: 'config', file: 'CORE_config.js', required: false },
                    { name: 'auth', file: 'CORE_auth.js', required: false },
                    { name: 'cache', file: 'CORE_cache.js', required: false }
                ];
                
                for (const { name, file, required } of coreFiles) {
                    try {
                        const module = await this.importWithRetry(`./${file}`, 2);
                        this.core.set(name, module.default || module);
                        console.log(`‚úÖ [Bootloader] Core "${name}" loaded`);
                        
                        // Initialize if init method exists
                        if (typeof this.core.get(name)?.init === 'function') {
                            await this.core.get(name).init();
                        }
                    } catch (error) {
                        if (required) {
                            throw new Error(`Failed to load required core module: ${name}`);
                        }
                        console.warn(`‚ö†Ô∏è [Bootloader] Optional core module "${name}" skipped:`, error.message);
                    }
                }
                
                this.performance.marks.coreEnd = performance.now();
            }
            
            // ==================== MODULES LOADING ====================
            async loadModules() {
                this.performance.marks.modulesStart = performance.now();
                this.updateProgress('modules');
                
                // Dynamic module discovery
                const modulePatterns = [
                    { pattern: 'MODULES_', path: './' },
                    { pattern: 'SERVICES_', path: './services/' },
                    { pattern: 'UTILS_', path: './utils/' }
                ];
                
                // Core required modules
                const requiredModules = [
                    'MODULES_auth.js',
                    'MODULES_lesson_engine.js',
                    'MODULES_payment.js'
                ];
                
                // Load required modules first
                for (const file of requiredModules) {
                    try {
                        const module = await this.importWithRetry(`./${file}`, 2);
                        const name = this.extractModuleName(file);
                        this.modules.set(name, module.default || module);
                        console.log(`‚úÖ [Bootloader] Module "${name}" loaded`);
                        
                        // Initialize with dependencies
                        await this.initializeModule(name);
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è [Bootloader] Module "${file}" failed:`, error.message);
                    }
                }
                
                // Try to discover and load other modules
                await this.discoverAndLoadModules();
                
                this.performance.marks.modulesEnd = performance.now();
            }
            
            // ==================== UI LOADING ====================
            async loadUI() {
                this.performance.marks.uiStart = performance.now();
                this.updateProgress('ui');
                
                const root = document.getElementById('app-root');
                if (!root) throw new Error('Root element not found');
                
                // Check authentication first
                const auth = this.modules.get('auth') || this.core.get('auth');
                if (auth && typeof auth.isAuthenticated === 'function') {
                    if (!auth.isAuthenticated()) {
                        await this.loadPage('page_login.js', root);
                        this.performance.marks.uiEnd = performance.now();
                        return;
                    }
                }
                
                // Load home page by default
                await this.loadPage('page_home.js', root);
                
                // Initialize router if available
                const router = this.core.get('router');
                if (router && typeof router.init === 'function') {
                    await router.init({
                        container: root,
                        modules: this.modules,
                        core: this.core
                    });
                }
                
                this.performance.marks.uiEnd = performance.now();
            }
            
            // ==================== PAGE LOADING ====================
            async loadPage(pageFile, container) {
                try {
                    const PageModule = await this.importWithRetry(`./${pageFile}`, 2);
                    const page = PageModule.default || PageModule;
                    
                    if (typeof page.render === 'function') {
                        container.innerHTML = page.render();
                        
                        // Initialize page if method exists
                        if (typeof page.init === 'function') {
                            await page.init({
                                container,
                                modules: this.modules,
                                core: this.core
                            });
                        }
                        
                        console.log(`‚úÖ [Bootloader] Page "${pageFile}" loaded`);
                    } else {
                        container.innerHTML = '<div class="page-placeholder"><p>ÿµŸÅÿ≠Ÿá ÿØÿ± ÿ≠ÿßŸÑ ÿ¢ŸÖÿßÿØŸá‚Äåÿ≥ÿßÿ≤€å ÿßÿ≥ÿ™...</p></div>';
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è [Bootloader] Page "${pageFile}" failed:`, error.message);
                    container.innerHTML = `
                        <div class="page-error">
                            <h3>ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿµŸÅÿ≠Ÿá</h3>
                            <p>${error.message}</p>
                            <button onclick="location.reload()" class="btn btn-primary">ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖÿ¨ÿØÿØ</button>
                        </div>
                    `;
                }
            }
            
            // ==================== INITIALIZATION ====================
            async initialize() {
                this.updateProgress('init');
                
                // Initialize all loaded modules
                for (const [name, module] of this.modules) {
                    if (typeof module.initialize === 'function') {
                        try {
                            await module.initialize({
                                modules: this.modules,
                                core: this.core
                            });
                            console.log(`‚úÖ [Bootloader] Module "${name}" initialized`);
                        } catch (error) {
                            console.warn(`‚ö†Ô∏è [Bootloader] Module "${name}" initialization failed:`, error.message);
                        }
                    }
                }
                
                // Start background services
                await this.startBackgroundServices();
                
                // Hide loading, show app
                document.getElementById('app-loading').style.display = 'none';
                document.getElementById('app-root').style.display = 'block';
                
                // Dispatch app ready event
                window.dispatchEvent(new CustomEvent('app:ready', {
                    detail: {
                        version: this.version,
                        loadTime: performance.now() - this.performance.startTime,
                        modules: Array.from(this.modules.keys()),
                        core: Array.from(this.core.keys())
                    }
                }));
                
                console.log(`üéâ [Bootloader] HyperLang v${this.version} ready in ${(performance.now() - this.performance.startTime).toFixed(0)}ms`);
            }
            
            // ==================== UTILITY METHODS ====================
            async importWithRetry(path, retries = 2, delay = 1000) {
                for (let i = 0; i <= retries; i++) {
                    try {
                        return await import(`${path}?v=${this.version}&attempt=${i}`);
                    } catch (error) {
                        if (i === retries) throw error;
                        console.log(`Retrying import ${path} (attempt ${i + 1}/${retries})...`);
                        await this.sleep(delay);
                    }
                }
            }
            
            extractModuleName(filename) {
                return filename
                    .replace(/\.js$/, '')
                    .replace(/^(MODULES_|SERVICES_|UTILS_|CORE_|page_|ui_)/, '')
                    .replace(/_/g, ' ');
            }
            
            async initializeModule(name) {
                const module = this.modules.get(name);
                if (!module) return;
                
                // Inject dependencies
                const dependencies = {};
                if (module.dependencies) {
                    for (const dep of module.dependencies) {
                        dependencies[dep] = this.modules.get(dep) || this.core.get(dep);
                    }
                }
                
                if (typeof module.init === 'function') {
                    await module.init(dependencies);
                }
            }
            
            async discoverAndLoadModules() {
                // In production, this would fetch a manifest file
                // For now, we'll load based on naming patterns
                const patterns = ['MODULES_', 'SERVICES_', 'UTILS_'];
                
                // Simulated module discovery
                const discoveredModules = [
                    'MODULES_gamification.js',
                    'MODULES_analytics.js',
                    'SERVICES_notification.js',
                    'UTILS_formatters.js'
                ];
                
                for (const file of discoveredModules) {
                    try {
                        const module = await import(`./${file}`).catch(() => null);
                        if (module) {
                            const name = this.extractModuleName(file);
                            this.modules.set(name, module.default || module);
                            console.log(`‚úÖ [Bootloader] Discovered module "${name}"`);
                        }
                    } catch (error) {
                        // Silent fail for discovered modules
                    }
                }
            }
            
            async startBackgroundServices() {
                // Start any background services
                const services = [
                    { name: 'sync', module: this.modules.get('sync') },
                    { name: 'cache', module: this.core.get('cache') },
                    { name: 'analytics', module: this.modules.get('analytics') }
                ];
                
                for (const { name, module } of services) {
                    if (module && typeof module.start === 'function') {
                        try {
                            await module.start();
                            console.log(`‚úÖ [Bootloader] Service "${name}" started`);
                        } catch (error) {
                            console.warn(`‚ö†Ô∏è [Bootloader] Service "${name}" failed to start:`, error.message);
                        }
                    }
                }
            }
            
            updateProgress(stepId) {
                const step = this.loadSteps.find(s => s.id === stepId);
                if (!step) return;
                
                const stepIndex = this.loadSteps.findIndex(s => s.id === stepId);
                let progress = 0;
                
                // Calculate progress based on completed steps
                for (let i = 0; i <= stepIndex; i++) {
                    progress += this.loadSteps[i].weight;
                }
                
                this.state.progress = progress;
                
                // Update UI
                const progressBar = document.getElementById('loader-progress');
                const stepText = document.getElementById('loader-step');
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                
                if (stepText) {
                    stepText.textContent = step.name;
                }
            }
            
            handleError(error) {
                console.error('üî• [Bootloader] Critical error:', error);
                this.state.error = error;
                
                // Show error screen
                document.getElementById('app-loading').style.display = 'none';
                const errorScreen = document.getElementById('app-error');
                document.getElementById('error-message').textContent = error.message;
                errorScreen.style.display = 'flex';
                
                // Setup retry button
                document.getElementById('retry-btn').onclick = () => {
                    errorScreen.style.display = 'none';
                    this.start();
                };
                
                // Setup reset button
                document.getElementById('reset-btn').onclick = () => {
                    if (confirm('ÿ¢€åÿß ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ⁄©ÿ¥ ÿ®ÿ±ŸÜÿßŸÖŸá Ÿæÿß⁄© ÿ¥ŸàÿØÿü')) {
                        localStorage.clear();
                        sessionStorage.clear();
                        location.reload();
                    }
                };
            }
            
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // ==================== PUBLIC API ====================
            async start() {
                try {
                    this.performance.startTime = performance.now();
                    
                    // Reset state
                    document.getElementById('app-loading').style.display = 'flex';
                    document.getElementById('app-error').style.display = 'none';
                    document.getElementById('app-root').style.display = 'none';
                    
                    console.log(`üöÄ [Bootloader] Starting HyperLang v${this.version}...`);
                    
                    // Load sequence
                    await this.loadCore();
                    await this.loadModules();
                    await this.loadUI();
                    await this.initialize();
                    
                    this.state.loaded = true;
                    
                } catch (error) {
                    this.handleError(error);
                }
            }
            
            getModule(name) {
                return this.modules.get(name) || this.core.get(name);
            }
            
            getPerformanceMetrics() {
                const total = performance.now() - this.performance.startTime;
                return {
                    total,
                    core: this.performance.marks.coreEnd - this.performance.marks.coreStart,
                    modules: this.performance.marks.modulesEnd - this.performance.marks.modulesStart,
                    ui: this.performance.marks.uiEnd - this.performance.marks.uiStart,
                    state: this.state
                };
            }
        }
        
        // ==================== APPLICATION START ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Create and start bootloader
            window.HyperLang = new AppBootloader();
            
            // Start application
            setTimeout(() => {
                window.HyperLang.start();
            }, 100);
            
            // Global error handler
            window.addEventListener('error', (event) => {
                console.error('Global error:', event.error);
            });
            
            window.addEventListener('unhandledrejection', (event) => {
                console.error('Unhandled promise rejection:', event.reason);
            });
        });
        
        // Expose for debugging
        window.debugApp = () => {
            return {
                bootloader: window.HyperLang,
                metrics: window.HyperLang?.getPerformanceMetrics(),
                modules: window.HyperLang?.modules,
                core: window.HyperLang?.core
            };
        };
    </script>
</body>
</html>
