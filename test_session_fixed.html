<!DOCTYPE html>
<html>
<head>
    <title>ØªØ³Øª SessionManager Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡</title>
    <style>
        body { font-family: Tahoma; padding: 20px; }
        button { padding: 12px 25px; font-size: 16px; background: #9C27B0; color: white; 
                 border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
        button:hover { background: #7B1FA2; }
        #result { margin: 20px; padding: 20px; border: 2px solid #ddd; border-radius: 10px; 
                  min-height: 150px; font-family: monospace; text-align: left; background: #f9f9f9; 
                  max-height: 400px; overflow-y: auto; }
        .step { margin: 8px 0; padding: 8px; border-left: 4px solid #9C27B0; background: white; }
        .success-step { border-left-color: #4CAF50; }
        .error-step { border-left-color: #f44336; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª SessionManager (Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)</h1>
    
    <button onclick="testSessionManager()">Ø´Ø±ÙˆØ¹ ØªØ³Øª SessionManager</button>
    
    <div id="result">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ ØªØ³Øª...</div>

    <script>
        // ==================== Û±. EventBus ====================
        class EventBus {
            constructor() { this.listeners = {}; }
            on(eventName, callback) {
                if (!this.listeners[eventName]) this.listeners[eventName] = [];
                this.listeners[eventName].push(callback);
                return () => this.off(eventName, callback);
            }
            off(eventName, callback) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName] = this.listeners[eventName].filter(cb => cb !== callback);
                }
            }
            emit(eventName, data) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName].forEach(callback => {
                        try { callback(data); } catch (error) { console.error('Listener error:', error); }
                    });
                }
            }
        }
        
        // ==================== Û². StateManager ====================
        class StateManager {
            constructor(initialState = {}) {
                this.state = { ...initialState };
                this.eventBus = new EventBus();
            }
            getState() { return { ...this.state }; }
            dispatch(action) {
                const oldState = { ...this.state };
                switch (action.type) {
                    case 'SET_USER': 
                        this.state.user = action.payload; 
                        break;
                    case 'CLEAR_USER': 
                        this.state.user = null; 
                        break;
                }
                this.eventBus.emit('state.changed', { type: action.type, oldState, newState: this.state });
            }
        }
        
        // ==================== Û³. SessionManager COMPLETE WITH login() ====================
        class SessionManager {
            constructor(eventBus, stateManager, config = {}) {
                this.eventBus = eventBus;
                this.stateManager = stateManager;
                this.config = {
                    accessTokenTTL: 5000,
                    sessionTimeout: 10000,
                    ...config
                };
                this.currentSession = null;
                log("âœ… SessionManager Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯");
            }
            
            // ğŸŸ¢ Ù…ØªØ¯ login Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡
            async login(credentials) {
                try {
                    log(`ğŸ” ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ†: ${credentials.email}`);
                    
                    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
                    if (!credentials.email || !credentials.email.includes('@')) {
                        throw new Error('Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
                    }
                    
                    // Ø³Ø§Ø®Øª Ø³Ø´Ù†
                    this.currentSession = {
                        userId: `user_${Date.now()}`,
                        email: credentials.email,
                        accessToken: `token_${Math.random().toString(36).substr(2, 9)}`,
                        refreshToken: `refresh_${Math.random().toString(36).substr(2, 9)}`,
                        expiresAt: Date.now() + this.config.accessTokenTTL,
                        createdAt: Date.now(),
                        lastActivityAt: Date.now()
                    };
                    
                    // Ø¢Ù¾Ø¯ÛŒØª state
                    this.stateManager.dispatch({
                        type: 'SET_USER',
                        payload: {
                            id: this.currentSession.userId,
                            email: credentials.email,
                            name: credentials.email.split('@')[0]
                        }
                    });
                    
                    // Ø§Ù†ØªØ´Ø§Ø± event
                    this.eventBus.emit('user.login', this.currentSession);
                    this.eventBus.emit('session.created', this.currentSession);
                    
                    log(`âœ… Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚: ${this.currentSession.userId}`, 'success');
                    return this.currentSession;
                    
                } catch (error) {
                    log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„Ø§Ú¯ÛŒÙ†: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            async logout() {
                if (!this.currentSession) return;
                
                log(`ğŸ‘‹ Ù„Ø§Ú¯Ø§ÙˆØª Ú©Ø§Ø±Ø¨Ø±: ${this.currentSession.userId}`);
                this.stateManager.dispatch({ type: 'CLEAR_USER' });
                this.eventBus.emit('user.logout', this.currentSession);
                this.currentSession = null;
                log("âœ… Ù„Ø§Ú¯Ø§ÙˆØª Ù…ÙˆÙÙ‚");
            }
            
            isAuthenticated() {
                return !!this.currentSession && Date.now() < this.currentSession.expiresAt;
            }
            
            getAccessToken() {
                return this.currentSession?.accessToken || null;
            }
        }
        
        // ==================== Û´. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
        function log(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const stepClass = type === 'success' ? 'success-step' : 
                            type === 'error' ? 'error-step' : 'step';
            
            resultDiv.innerHTML += `
                <div class="${stepClass}">
                    <strong>[${new Date().toLocaleTimeString()}]</strong> ${message}
                </div>
            `;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        // ==================== Ûµ. ØªØ³Øª Ø§ØµÙ„ÛŒ ====================
        function testSessionManager() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div>ğŸ¬ Ø´Ø±ÙˆØ¹ ØªØ³Øª SessionManager...</div>';
            
            setTimeout(async () => {
                try {
                    // Û±. Ø³Ø§Ø®Øª EventBus Ùˆ StateManager
                    const eventBus = new EventBus();
                    const stateManager = new StateManager();
                    
                    // Û². Ø³Ø§Ø®Øª SessionManager
                    const sessionManager = new SessionManager(eventBus, stateManager, {
                        accessTokenTTL: 3000
                    });
                    
                    // Û³. ØªØ³Øª Ù„Ø§Ú¯ÛŒÙ†
                    log("ğŸ”„ ØªØ³Øª Ù„Ø§Ú¯ÛŒÙ†...");
                    const session = await sessionManager.login({
                        email: 'user@vakamova.com',
                        password: 'password123'
                    });
                    
                    log(`âœ… Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚: ${session.email}`, 'success');
                    log(`ğŸ”‘ ØªÙˆÚ©Ù†: ${session.accessToken}`);
                    log(`ğŸ‘¤ User ID: ${session.userId}`);
                    
                    // Û´. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø²
                    log("ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø²...");
                    const isAuth = sessionManager.isAuthenticated();
                    log(`ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø²: ${isAuth ? 'âœ… Ù…Ø¹ØªØ¨Ø±' : 'âŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}`);
                    
                    // Ûµ. Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù†
                    const token = sessionManager.getAccessToken();
                    log(`ğŸ”‘ ØªÙˆÚ©Ù† ÙØ¹Ù„ÛŒ: ${token ? token.substring(0, 20) + '...' : 'null'}`);
                    
                    // Û¶. ØªØ³Øª Ù„Ø§Ú¯Ø§ÙˆØª
                    setTimeout(async () => {
                        log("ğŸ‘‹ ØªØ³Øª Ù„Ø§Ú¯Ø§ÙˆØª...");
                        await sessionManager.logout();
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ state Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯Ø§ÙˆØª
                        const state = stateManager.getState();
                        log(`ğŸ“Š State Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯Ø§ÙˆØª: ${state.user ? 'Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ¬ÙˆØ¯' : 'Ú©Ø§Ø±Ø¨Ø± null'}`);
                        
                        log("ğŸ‰ ØªØ³Øª SessionManager Ú©Ø§Ù…Ù„ Ø´Ø¯!", 'success');
                    }, 1000);
                    
                } catch (error) {
                    log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª: ${error.message}`, 'error');
                }
            }, 500);
        }
    </script>
</body>
</html>
