<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª End-to-End Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø±Ø¨Ø± - Vakamova</title>
    <style>
        body { font-family: Tahoma; max-width: 1000px; margin: 20px auto; padding: 20px; background: #f5f7fa; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .step { background: #e3f2fd; padding: 15px; margin: 15px 0; border-radius: 8px; border-right: 5px solid #2196f3; }
        .success { color: #1b5e20; background: #e8f5e9; padding: 10px; margin: 8px 0; border-right: 4px solid #4caf50; border-radius: 4px; }
        .exercise-ui { background: #fff3e0; padding: 15px; margin: 15px 0; border-radius: 8px; border: 2px solid #ff9800; }
        button { background: linear-gradient(to left, #2196f3, #4caf50); color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; margin: 5px; }
        button:hover { opacity: 0.9; }
        .user-action { background: #bbdefb; padding: 10px; margin: 10px 0; border-radius: 6px; }
        .progress-bar { height: 10px; background: #e0e0e0; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(to right, #4caf50, #8bc34a); width: 0%; transition: width 0.5s; }
        .final-report { background: #f1f8e9; padding: 20px; border-radius: 8px; border: 2px dashed #7cb342; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ ØªØ³Øª End-to-End Ú¯Ø±Ø¯Ø´ Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±</h1>
        <p>Ø§ÛŒÙ† ØªØ³Øª Ú©Ù„ ÙØ±Ø¢ÛŒÙ†Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø±Ø§ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯:</p>
        <div class="progress-bar"><div class="progress-fill" id="globalProgress"></div></div>
        
        <div id="testFlow"></div>
        <button onclick="startE2ETest()">Ø´Ø±ÙˆØ¹ ØªØ³Øª Ú¯Ø±Ø¯Ø´ Ú©Ø§Ù…Ù„</button>
        <div id="results"></div>
    </div>

    <script>
        // ==================== Ø³ÛŒØ³ØªÙ… Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ====================
        class UserSimulator {
            constructor() {
                this.user = { id: 'user_001', name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª', language: null, level: 'beginner' };
                this.selectedLesson = null;
                this.score = 0;
                this.completedExercises = [];
                this.log = [];
            }

            selectLanguage(lang) {
                this.user.language = lang;
                this.addLog(`ğŸŒ Ø²Ø¨Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯: <strong>${lang}</strong>`);
                return this;
            }

            selectLesson(lesson) {
                this.selectedLesson = lesson;
                this.addLog(`ğŸ“˜ Ø¯Ø±Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯: <strong>${lesson.title}</strong> (Ø³Ø·Ø­: ${lesson.level})`);
                return this;
            }

            completeExercise(exercise, isCorrect, earnedPoints) {
                this.completedExercises.push({ exercise, isCorrect, earnedPoints });
                this.score += earnedPoints;
                this.addLog(`ğŸ“ ØªÙ…Ø±ÛŒÙ† Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯: ${exercise.type} â†’ ${isCorrect ? 'âœ… ØµØ­ÛŒØ­' : 'âŒ Ù†Ø§Ø¯Ø±Ø³Øª'} (+${earnedPoints} Ø§Ù…ØªÛŒØ§Ø²)`);
                return this;
            }

            addLog(message) {
                this.log.push({ time: new Date().toLocaleTimeString('fa-IR'), message });
            }

            getReport() {
                return {
                    user: this.user,
                    lesson: this.selectedLesson,
                    totalScore: this.score,
                    completedCount: this.completedExercises.length,
                    correctCount: this.completedExercises.filter(e => e.isCorrect).length,
                    log: this.log
                };
            }
        }

        // ==================== Ø³ÛŒØ³ØªÙ… ØªÙ…Ø±ÛŒÙ† ====================
        class ExerciseSystem {
            constructor() {
                this.exercises = [
                    {
                        id: 'ex1',
                        type: 'multipleChoice',
                        question: 'ØªØ±Ø¬Ù…Ù‡ "Ú©ØªØ§Ø¨" Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ú†ÛŒØ³ØªØŸ',
                        options: ['Book', 'Pen', 'Desk', 'Chair'],
                        correctAnswer: 'Book',
                        points: 20
                    },
                    {
                        id: 'ex2',
                        type: 'fillBlank',
                        sentence: 'I ___ to school every day.',
                        blankPosition: 1,
                        correctAnswer: 'go',
                        points: 30
                    },
                    {
                        id: 'ex3',
                        type: 'matching',
                        leftItems: ['Ø³ÛŒØ¨', 'Ù…ÛŒØ²', 'Ø®ÙˆØ±Ø´ÛŒØ¯'],
                        rightItems: ['Apple', 'Table', 'Sun'],
                        correctPairs: [['Ø³ÛŒØ¨','Apple'], ['Ù…ÛŒØ²','Table'], ['Ø®ÙˆØ±Ø´ÛŒØ¯','Sun']],
                        points: 50
                    }
                ];
            }

            getExercise(type = null) {
                if (type) {
                    return this.exercises.find(e => e.type === type) || this.exercises[0];
                }
                return this.exercises[Math.floor(Math.random() * this.exercises.length)];
            }

            evaluateAnswer(exercise, userAnswer) {
                let isCorrect = false;
                let feedback = '';

                switch (exercise.type) {
                    case 'multipleChoice':
                        isCorrect = userAnswer === exercise.correctAnswer;
                        feedback = isCorrect ? 'Ø¹Ø§Ù„ÛŒ! Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø§Ø³Øª.' : `Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­: ${exercise.correctAnswer}`;
                        break;
                    case 'fillBlank':
                        isCorrect = userAnswer.toLowerCase() === exercise.correctAnswer.toLowerCase();
                        feedback = isCorrect ? 'Ø¯Ø±Ø³Øª Ù¾Ø± Ú©Ø±Ø¯ÛŒØ¯!' : `Ú©Ù„Ù…Ù‡ ØµØ­ÛŒØ­: ${exercise.correctAnswer}`;
                        break;
                    case 'matching':
                        // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¯Ù‡
                        isCorrect = Math.random() > 0.3; // 70% Ø´Ø§Ù†Ø³ ØµØ­ÛŒØ­
                        feedback = isCorrect ? 'Ù‡Ù…Ù‡ Ù…ÙˆØ§Ø±Ø¯ Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØµÙ„ Ú©Ø±Ø¯ÛŒØ¯!' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ…Ø±ÛŒÙ† Ø¨ÛŒØ´ØªØ± Ø¯Ø§Ø±ÛŒØ¯.';
                        break;
                }

                return { isCorrect, feedback, points: isCorrect ? exercise.points : 10 };
            }
        }

        // ==================== UI Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² ====================
        class SimulatorUI {
            constructor() {
                this.flowElement = document.getElementById('testFlow');
                this.resultsElement = document.getElementById('results');
                this.progressBar = document.getElementById('globalProgress');
            }

            showStep(stepNumber, title, content) {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step';
                stepDiv.innerHTML = `
                    <h3>Ù…Ø±Ø­Ù„Ù‡ ${stepNumber}: ${title}</h3>
                    <div>${content}</div>
                `;
                this.flowElement.appendChild(stepDiv);
                this.updateProgress(stepNumber * 20);
            }

            showExerciseUI(exercise, onAnswer) {
                const uiDiv = document.createElement('div');
                uiDiv.className = 'exercise-ui';
                
                let interactionHTML = '';
                switch (exercise.type) {
                    case 'multipleChoice':
                        interactionHTML = `
                            <p><strong>Ø³ÙˆØ§Ù„:</strong> ${exercise.question}</p>
                            <div class="user-action">
                                ${exercise.options.map((opt, i) => `
                                    <button onclick="handleAnswer('${opt}')">${opt}</button>
                                `).join('')}
                            </div>
                        `;
                        break;
                    case 'fillBlank':
                        interactionHTML = `
                            <p><strong>Ø¬Ù…Ù„Ù‡:</strong> ${exercise.sentence}</p>
                            <div class="user-action">
                                <input type="text" id="blankAnswer" placeholder="Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                                <button onclick="handleAnswer(document.getElementById('blankAnswer').value)">Ø«Ø¨Øª Ù¾Ø§Ø³Ø®</button>
                            </div>
                        `;
                        break;
                    case 'matching':
                        interactionHTML = `
                            <p><strong>Ø¬ÙØªâ€ŒÙ‡Ø§ÛŒ ØµØ­ÛŒØ­ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</strong></p>
                            <div class="user-action">
                                <p>${exercise.leftItems.join(' â†” ')}</p>
                                <button onclick="handleAnswer('matched')">Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯Ù…</button>
                            </div>
                        `;
                        break;
                }

                uiDiv.innerHTML = interactionHTML;
                this.flowElement.appendChild(uiDiv);
                
                window.handleAnswer = (answer) => {
                    onAnswer(answer);
                    uiDiv.style.opacity = '0.7';
                };
            }

            showResult(message, isSuccess) {
                const div = document.createElement('div');
                div.className = isSuccess ? 'success' : 'error';
                div.innerHTML = message;
                this.resultsElement.appendChild(div);
            }

            showFinalReport(report) {
                const reportDiv = document.createElement('div');
                reportDiv.className = 'final-report';
                reportDiv.innerHTML = `
                    <h2>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø±Ø¨Ø±</h2>
                    <p><strong>ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±:</strong> ${report.user.name}</p>
                    <p><strong>ğŸŒ Ø²Ø¨Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ:</strong> ${report.user.language}</p>
                    <p><strong>ğŸ“˜ Ø¯Ø±Ø³ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡:</strong> ${report.lesson.title}</p>
                    <p><strong>ğŸ¯ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ Ú©Ø³Ø¨ Ø´Ø¯Ù‡:</strong> ${report.totalScore} Ø§Ø² Û±Û°Û°</p>
                    <p><strong>âœ… ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ ØµØ­ÛŒØ­:</strong> ${report.correctCount} Ø§Ø² ${report.completedCount}</p>
                    <p><strong>ğŸ“ˆ Ø¯Ø±ØµØ¯ Ù…ÙˆÙÙ‚ÛŒØª:</strong> ${Math.round((report.correctCount/report.completedCount)*100)}%</p>
                    <hr>
                    <h4>ğŸ“ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ¹Ø§Ù„ÛŒØª:</h4>
                    <ul>${report.log.map(item => `<li>[${item.time}] ${item.message}</li>`).join('')}</ul>
                `;
                this.resultsElement.appendChild(reportDiv);
            }

            updateProgress(percent) {
                this.progressBar.style.width = percent + '%';
            }

            clear() {
                this.flowElement.innerHTML = '';
                this.resultsElement.innerHTML = '';
                this.updateProgress(0);
            }
        }

        // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª ====================
        const simulator = new UserSimulator();
        const exerciseSystem = new ExerciseSystem();
        const ui = new SimulatorUI();
        let currentStep = 0;

        async function startE2ETest() {
            ui.clear();
            currentStep = 0;
            
            try {
                // Ù…Ø±Ø­Ù„Ù‡ 1: ÙˆØ±ÙˆØ¯ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ø¨Ø§Ù†
                ui.showStep(++currentStep, 'ÙˆØ±ÙˆØ¯ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ø¨Ø§Ù†', 
                    'Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');
                
                await delay(1000);
                simulator.selectLanguage('Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ');
                ui.showResult('âœ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯ Ùˆ Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯.', true);
                
                // Ù…Ø±Ø­Ù„Ù‡ 2: Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±Ø³
                ui.showStep(++currentStep, 'Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±Ø³', 
                    'Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¨ÛŒÙ† Ø¯Ø±ÙˆØ³ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¯Ø±Ø³ "Ù…Ú©Ø§Ù„Ù…Ù‡ Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ" Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');
                
                await delay(1200);
                const lesson = { id: 'lesson1', title: 'Ù…Ú©Ø§Ù„Ù…Ù‡ Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ', level: 'A1', duration: 'Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡' };
                simulator.selectLesson(lesson);
                ui.showResult(`âœ… Ø¯Ø±Ø³ "<strong>${lesson.title}</strong>" Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.`, true);
                
                // Ù…Ø±Ø­Ù„Ù‡ 3: Ø§Ù†Ø¬Ø§Ù… ØªÙ…Ø±ÛŒÙ† Ø§ÙˆÙ„ (Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ)
                ui.showStep(++currentStep, 'ØªÙ…Ø±ÛŒÙ† Ø§ÙˆÙ„: Ø³ÙˆØ§Ù„ Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ', 
                    'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø³ÙˆØ§Ù„ Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ù¾Ø§Ø³Ø® Ø¯Ù‡Ø¯.');
                
                const ex1 = exerciseSystem.getExercise('multipleChoice');
                await new Promise(resolve => {
                    ui.showExerciseUI(ex1, (userAnswer) => {
                        const result = exerciseSystem.evaluateAnswer(ex1, userAnswer);
                        simulator.completeExercise(ex1, result.isCorrect, result.points);
                        ui.showResult(`ğŸ“ <strong>Ù†ØªÛŒØ¬Ù‡ ØªÙ…Ø±ÛŒÙ†:</strong> ${result.feedback} (Ø§Ù…ØªÛŒØ§Ø²: +${result.points})`, result.isCorrect);
                        resolve();
                    });
                });
                
                // Ù…Ø±Ø­Ù„Ù‡ 4: Ø§Ù†Ø¬Ø§Ù… ØªÙ…Ø±ÛŒÙ† Ø¯ÙˆÙ… (Ù¾Ø±Ú©Ø±Ø¯Ù† Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ)
                ui.showStep(++currentStep, 'ØªÙ…Ø±ÛŒÙ† Ø¯ÙˆÙ…: Ù¾Ø±Ú©Ø±Ø¯Ù† Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ', 
                    'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø¯Ø± Ø¬Ù…Ù„Ù‡ Ø±Ø§ Ù¾Ø± Ú©Ù†Ø¯.');
                
                await delay(800);
                const ex2 = exerciseSystem.getExercise('fillBlank');
                const result2 = exerciseSystem.evaluateAnswer(ex2, 'go'); // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±
                simulator.completeExercise(ex2, result2.isCorrect, result2.points);
                ui.showResult(`ğŸ“ <strong>Ù†ØªÛŒØ¬Ù‡ ØªÙ…Ø±ÛŒÙ†:</strong> ${result2.feedback} (Ø§Ù…ØªÛŒØ§Ø²: +${result2.points})`, result2.isCorrect);
                
                // Ù…Ø±Ø­Ù„Ù‡ 5: Ø§Ù†Ø¬Ø§Ù… ØªÙ…Ø±ÛŒÙ† Ø³ÙˆÙ… (Ø¬ÙˆØ±Ú†ÛŒÙ†)
                ui.showStep(++currentStep, 'ØªÙ…Ø±ÛŒÙ† Ø³ÙˆÙ…: Ø¬ÙˆØ±Ú†ÛŒÙ† Ú©Ù„Ù…Ø§Øª', 
                    'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ú©Ù„Ù…Ø§Øª ÙØ§Ø±Ø³ÛŒ Ùˆ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø±Ø§ Ø¨Ù‡ Ù‡Ù… ÙˆØµÙ„ Ú©Ù†Ø¯.');
                
                await delay(1000);
                const ex3 = exerciseSystem.getExercise('matching');
                const result3 = exerciseSystem.evaluateAnswer(ex3, 'matched');
                simulator.completeExercise(ex3, result3.isCorrect, result3.points);
                ui.showResult(`ğŸ“ <strong>Ù†ØªÛŒØ¬Ù‡ ØªÙ…Ø±ÛŒÙ†:</strong> ${result3.feedback} (Ø§Ù…ØªÛŒØ§Ø²: +${result3.points})`, result3.isCorrect);
                
                // Ù…Ø±Ø­Ù„Ù‡ 6: Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
                ui.showStep(++currentStep, 'Ù†ØªÛŒØ¬Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ú¯Ø²Ø§Ø±Ø´', 
                    'Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø«Ø¨Øª Ø¯Ø± Ø³ÛŒØ³ØªÙ….');
                
                await delay(800);
                const report = simulator.getReport();
                ui.showFinalReport(report);
                ui.showResult('ğŸ‰ <strong>ØªØ³Øª Ú¯Ø±Ø¯Ø´ Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯!</strong>', true);
                ui.updateProgress(100);
                
            } catch (error) {
                ui.showResult(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª: ${error.message}`, false);
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
