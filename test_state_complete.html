<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª - Vakamova</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #0284c7 0%, #1d4ed8 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        .state-badge {
            background: #f59e0b;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }
        .test-container {
            padding: 25px;
        }
        .test-section {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
        }
        .test-section h2 {
            color: #0284c7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #e2e8f0;
            transition: all 0.3s;
        }
        .test-item.passed {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .test-item.failed {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .test-item.performance {
            border-left-color: #f59e0b;
            background: #fefce8;
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-title {
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }
        .test-performance {
            font-size: 0.8rem;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 10px;
        }
        .test-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .status-passed {
            background: #d1fae5;
            color: #065f46;
        }
        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }
        .test-output {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-output.success {
            background: #0f766e;
        }
        .test-output.error {
            background: #7f1d1d;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 25px;
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        #run-tests {
            background: linear-gradient(135deg, #0284c7 0%, #1d4ed8 100%);
            color: white;
        }
        #run-tests:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(2, 132, 199, 0.4);
        }
        #run-tests:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #clear-results, #export-results, #run-performance {
            background: #6b7280;
            color: white;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            padding: 20px;
            background: #f1f5f9;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        @media (max-width: 992px) {
            .stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 576px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .stat-box {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
        }
        .success { color: #10b981; }
        .failure { color: #ef4444; }
        .pending { color: #f59e0b; }
        .performance-color { color: #f59e0b; }
        
        .state-simulator {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .state-simulator {
                grid-template-columns: 1fr;
            }
        }
        .state-simulator h3 {
            color: #1d4ed8;
            margin-bottom: 15px;
            grid-column: 1 / -1;
        }
        .sim-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sim-controls button {
            padding: 10px;
            font-size: 0.9rem;
            justify-content: flex-start;
        }
        .state-visualizer {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow: auto;
            max-height: 300px;
        }
        .state-key {
            color: #60a5fa;
        }
        .state-value {
            color: #34d399;
        }
        .state-type {
            color: #fbbf24;
        }
        
        .undo-redo-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .undo-redo-controls button {
            flex: 1;
            padding: 8px;
            font-size: 0.8rem;
        }
        
        @media (max-width: 768px) {
            .test-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .controls {
                flex-direction: column;
            }
            button {
                width: 100%;
                justify-content: center;
            }
        }
        
        .performance-chart {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .chart-bar {
            height: 20px;
            background: linear-gradient(90deg, #0284c7, #0ea5e9);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: width 0.5s ease;
        }
        
        .chart-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”„ ØªØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª - Vakamova</h1>
            <p>Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø§Ù…Ø¹ State ManagementØŒ Undo/RedoØŒ Persistence Ùˆ Performance</p>
            <div class="state-badge">Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ú©Ù†Ø´â€ŒÙ¾Ø°ÛŒØ±</div>
        </header>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-value success" id="passed-count">0</div>
                <div class="stat-label">Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-box">
                <div class="stat-value failure" id="failed-count">0</div>
                <div class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-box">
                <div class="stat-value performance-color" id="performance-count">0</div>
                <div class="stat-label">ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="state-count">0</div>
                <div class="stat-label">ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="stat-box">
                <div class="stat-value pending" id="pending-count">0</div>
                <div class="stat-label">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
            </div>
        </div>
        
        <div class="state-simulator">
            <h3>ğŸ® Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª</h3>
            <div class="sim-controls">
                <button onclick="simulateSetState()" style="background: #10b981;">
                    <span>â•</span> Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª
                </button>
                <button onclick="simulateUpdateState()" style="background: #3b82f6;">
                    <span>âœï¸</span> Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
                </button>
                <button onclick="simulateDeleteState()" style="background: #ef4444;">
                    <span>ğŸ—‘ï¸</span> Ø­Ø°Ù ÙˆØ¶Ø¹ÛŒØª
                </button>
                <button onclick="simulateNestedState()" style="background: #8b5cf6;">
                    <span>ğŸ“</span> ÙˆØ¶Ø¹ÛŒØª ØªÙˆØ¯Ø±ØªÙˆ
                </button>
                
                <div class="undo-redo-controls">
                    <button onclick="simulateUndo()" style="background: #f59e0b;">
                        <span>â†©ï¸</span> Undo
                    </button>
                    <button onclick="simulateRedo()" style="background: #f59e0b;">
                        <span>â†ªï¸</span> Redo
                    </button>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                    <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 5px;">ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ:</div>
                    <div id="current-action" style="font-family: monospace; color: #1d4ed8;">Ù‡ÛŒÚ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡</div>
                </div>
            </div>
            
            <div class="state-visualizer" id="state-visualizer">
                // ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
                {
                  "system": "state-simulator",
                  "status": "ready"
                }
            </div>
        </div>
        
        <div class="test-container" id="test-container">
            <!-- ØªØ³Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        
        <div class="controls">
            <button id="run-tests">
                <span>ğŸš€</span>
                Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§
            </button>
            <button id="run-performance">
                <span>âš¡</span>
                ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯
            </button>
            <button id="export-results">
                <span>ğŸ’¾</span>
                Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬
            </button>
            <button id="clear-results">
                <span>ğŸ”„</span>
                Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬
            </button>
        </div>
    </div>

    <script>
        // ============ Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª Ù„Ø§Ú¯ ============
        class StateLogger {
            constructor() {
                this.logs = [];
                this.stateHistory = [];
                this.maxHistory = 50;
            }
            
            log(message, data = null) {
                const entry = {
                    time: new Date().toISOString(),
                    message,
                    data: this.sanitizeData(data),
                    type: 'info'
                };
                
                this.logs.push(entry);
                console.log(`[State Test] ${message}`, data || '');
                return entry;
            }
            
            stateChange(action, previousState, newState) {
                const entry = {
                    time: new Date().toISOString(),
                    action,
                    previousState: this.sanitizeData(previousState),
                    newState: this.sanitizeData(newState),
                    type: 'state_change'
                };
                
                this.logs.push(entry);
                
                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø±Ø§ÛŒ undo/redo
                this.stateHistory.push({
                    time: entry.time,
                    action,
                    state: this.sanitizeData(newState)
                });
                
                if (this.stateHistory.length > this.maxHistory) {
                    this.stateHistory.shift();
                }
                
                console.log(`[State Change] ${action}`, newState);
                return entry;
            }
            
            performanceLog(operation, duration, dataSize = 0) {
                const entry = {
                    time: new Date().toISOString(),
                    operation,
                    duration,
                    dataSize,
                    type: 'performance'
                };
                
                this.logs.push(entry);
                console.log(`[State Performance] ${operation}: ${duration.toFixed(2)}ms (${dataSize} items)`);
                return entry;
            }
            
            error(message, error) {
                const entry = {
                    time: new Date().toISOString(),
                    message,
                    error: error?.message || error,
                    stack: error?.stack,
                    type: 'error'
                };
                
                this.logs.push(entry);
                console.error(`[State Test] ${message}:`, error);
                return entry;
            }
            
            sanitizeData(data) {
                if (!data || typeof data !== 'object') return data;
                
                try {
                    return JSON.parse(JSON.stringify(data));
                } catch (e) {
                    return { error: 'Data could not be serialized' };
                }
            }
            
            getStats() {
                const performanceLogs = this.logs.filter(l => l.type === 'performance');
                const avgDuration = performanceLogs.length > 0 
                    ? performanceLogs.reduce((sum, l) => sum + l.duration, 0) / performanceLogs.length
                    : 0;
                    
                return {
                    totalLogs: this.logs.length,
                    stateChanges: this.logs.filter(l => l.type === 'state_change').length,
                    performanceTests: performanceLogs.length,
                    avgPerformance: avgDuration,
                    errors: this.logs.filter(l => l.type === 'error').length
                };
            }
        }

        // ============ Mock Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª ============
        class MockStateManager {
            constructor() {
                this.state = new Map();
                this.listeners = new Set();
                this.history = [];
                this.future = [];
                this.maxHistory = 100;
                this.validationRules = new Map();
                this.middlewares = [];
                this.persistenceEnabled = false;
                this.persistenceKey = 'vakamova_state';
                
                this.initializeDefaultState();
            }
            
            initializeDefaultState() {
                this.state.set('system', {
                    initialized: true,
                    version: '1.0.0',
                    timestamp: new Date().toISOString()
                });
                
                this.state.set('user', {
                    isLoggedIn: false,
                    preferences: {
                        language: 'fa',
                        theme: 'light',
                        notifications: true
                    }
                });
                
                this.state.set('ui', {
                    loading: false,
                    currentPage: 'home',
                    modalOpen: false
                });
            }
            
            // ============ Ø¹Ù…Ù„ÛŒØ§Øª Ø§ØµÙ„ÛŒ ============
            
            set(key, value, description = '') {
                const previousValue = this.state.get(key);
                const change = {
                    type: 'set',
                    key,
                    previousValue,
                    newValue: value,
                    timestamp: Date.now(),
                    description
                };
                
                // Ø§Ø¬Ø±Ø§ÛŒ middlewareÙ‡Ø§
                if (!this.runMiddlewares('beforeSet', change)) {
                    throw new Error('Middleware blocked set operation');
                }
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                if (this.validationRules.has(key)) {
                    const isValid = this.validationRules.get(key)(value);
                    if (!isValid) {
                        throw new Error(`Validation failed for key: ${key}`);
                    }
                }
                
                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
                this.addToHistory(change);
                
                // Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±
                this.state.set(key, value);
                
                // Ø§Ø¬Ø±Ø§ÛŒ middlewareÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ
                this.runMiddlewares('afterSet', change);
                
                // Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ listeners
                this.notifyListeners(key, value, previousValue);
                
                // Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯
                if (this.persistenceEnabled) {
                    this.saveToStorage();
                }
                
                return change;
            }
            
            get(key, defaultValue = null) {
                if (!this.state.has(key)) {
                    return defaultValue;
                }
                return this.state.get(key);
            }
            
            update(key, updater, description = '') {
                const currentValue = this.get(key);
                if (currentValue === undefined) {
                    throw new Error(`Key not found: ${key}`);
                }
                
                const newValue = typeof updater === 'function' 
                    ? updater(currentValue)
                    : { ...currentValue, ...updater };
                
                return this.set(key, newValue, description);
            }
            
            delete(key, description = '') {
                const previousValue = this.state.get(key);
                if (!this.state.has(key)) {
                    return null;
                }
                
                const change = {
                    type: 'delete',
                    key,
                    previousValue,
                    newValue: undefined,
                    timestamp: Date.now(),
                    description
                };
                
                if (!this.runMiddlewares('beforeDelete', change)) {
                    throw new Error('Middleware blocked delete operation');
                }
                
                this.addToHistory(change);
                this.state.delete(key);
                
                this.runMiddlewares('afterDelete', change);
                this.notifyListeners(key, undefined, previousValue);
                
                if (this.persistenceEnabled) {
                    this.saveToStorage();
                }
                
                return change;
            }
            
            has(key) {
                return this.state.has(key);
            }
            
            clear(description = 'Clear all state') {
                const previousState = new Map(this.state);
                const change = {
                    type: 'clear',
                    previousState,
                    newState: new Map(),
                    timestamp: Date.now(),
                    description
                };
                
                if (!this.runMiddlewares('beforeClear', change)) {
                    throw new Error('Middleware blocked clear operation');
                }
                
                this.addToHistory(change);
                this.state.clear();
                this.initializeDefaultState();
                
                this.runMiddlewares('afterClear', change);
                this.notifyListeners('*', undefined, previousState);
                
                if (this.persistenceEnabled) {
                    this.saveToStorage();
                }
                
                return change;
            }
            
            // ============ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ============
            
            addToHistory(change) {
                this.history.push(change);
                this.future = []; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† future Ù‡Ù†Ú¯Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª Ø¬Ø¯ÛŒØ¯
                
                if (this.history.length > this.maxHistory) {
                    this.history.shift();
                }
            }
            
            undo() {
                if (this.history.length === 0) {
                    return null;
                }
                
                const lastChange = this.history.pop();
                this.future.push(lastChange);
                
                // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ù‡ Ø­Ø§Ù„Øª Ù‚Ø¨Ù„ÛŒ
                switch (lastChange.type) {
                    case 'set':
                    case 'update':
                        if (lastChange.previousValue === undefined) {
                            this.state.delete(lastChange.key);
                        } else {
                            this.state.set(lastChange.key, lastChange.previousValue);
                        }
                        break;
                    case 'delete':
                        this.state.set(lastChange.key, lastChange.previousValue);
                        break;
                    case 'clear':
                        this.state = lastChange.previousState;
                        break;
                }
                
                this.notifyListeners('undo', lastChange);
                return lastChange;
            }
            
            redo() {
                if (this.future.length === 0) {
                    return null;
                }
                
                const nextChange = this.future.pop();
                this.history.push(nextChange);
                
                // Ø§Ø¹Ù…Ø§Ù„ Ù…Ø¬Ø¯Ø¯ ØªØºÛŒÛŒØ±
                switch (nextChange.type) {
                    case 'set':
                    case 'update':
                        this.state.set(nextChange.key, nextChange.newValue);
                        break;
                    case 'delete':
                        this.state.delete(nextChange.key);
                        break;
                    case 'clear':
                        this.state = nextChange.newState;
                        break;
                }
                
                this.notifyListeners('redo', nextChange);
                return nextChange;
            }
            
            // ============ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ============
            
            addValidation(key, validator) {
                this.validationRules.set(key, validator);
                return () => this.validationRules.delete(key);
            }
            
            validateAll() {
                const errors = [];
                
                for (const [key, value] of this.state.entries()) {
                    if (this.validationRules.has(key)) {
                        const isValid = this.validationRules.get(key)(value);
                        if (!isValid) {
                            errors.push({ key, value });
                        }
                    }
                }
                
                return {
                    valid: errors.length === 0,
                    errors
                };
            }
            
            // ============ Middleware ============
            
            use(middleware) {
                this.middlewares.push(middleware);
                return () => {
                    const index = this.middlewares.indexOf(middleware);
                    if (index > -1) {
                        this.middlewares.splice(index, 1);
                    }
                };
            }
            
            runMiddlewares(phase, data) {
                for (const middleware of this.middlewares) {
                    if (middleware[phase]) {
                        try {
                            const result = middleware[phase](data);
                            if (result === false) {
                                return false;
                            }
                        } catch (error) {
                            console.error(`Middleware error in ${phase}:`, error);
                            return false;
                        }
                    }
                }
                return true;
            }
            
            // ============ Persistence ============
            
            enablePersistence(key = null) {
                this.persistenceEnabled = true;
                if (key) {
                    this.persistenceKey = key;
                }
                
                try {
                    const saved = localStorage.getItem(this.persistenceKey);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        for (const [key, value] of Object.entries(parsed)) {
                            this.state.set(key, value);
                        }
                    }
                } catch (error) {
                    console.error('Error loading persisted state:', error);
                }
                
                return this;
            }
            
            disablePersistence() {
                this.persistenceEnabled = false;
                return this;
            }
            
            saveToStorage() {
                if (!this.persistenceEnabled) return;
                
                try {
                    const serializable = {};
                    for (const [key, value] of this.state.entries()) {
                        try {
                            JSON.stringify(value); // ØªØ³Øª Ø³Ø±ÛŒØ§Ù„â€ŒÙ¾Ø°ÛŒØ±ÛŒ
                            serializable[key] = value;
                        } catch (e) {
                            console.warn(`Cannot serialize key "${key}" for persistence`);
                        }
                    }
                    
                    localStorage.setItem(this.persistenceKey, JSON.stringify(serializable));
                } catch (error) {
                    console.error('Error saving state to storage:', error);
                }
            }
            
            // ============ Listeners Ùˆ Reactivity ============
            
            subscribe(listener) {
                this.listeners.add(listener);
                return () => this.listeners.delete(listener);
            }
            
            notifyListeners(key, newValue, oldValue) {
                for (const listener of this.listeners) {
                    try {
                        listener(key, newValue, oldValue);
                    } catch (error) {
                        console.error('Listener error:', error);
                    }
                }
            }
            
            // ============ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ============
            
            getAll() {
                const result = {};
                for (const [key, value] of this.state.entries()) {
                    result[key] = value;
                }
                return result;
            }
            
            getHistory() {
                return [...this.history];
            }
            
            getFuture() {
                return [...this.future];
            }
            
            getSnapshot() {
                return {
                    state: this.getAll(),
                    history: this.getHistory(),
                    future: this.getFuture(),
                    timestamp: new Date().toISOString()
                };
            }
            
            size() {
                return this.state.size;
            }
            
            keys() {
                return Array.from(this.state.keys());
            }
            
            values() {
                return Array.from(this.state.values());
            }
            
            entries() {
                return Array.from(this.state.entries());
            }
        }

        // ============ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª ============
        const STATE_TEST_SUITES = [
            {
                id: 'state-core',
                name: 'Ù‡Ø³ØªÙ‡ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª',
                icon: 'ğŸ”§',
                tests: [
                    {
                        id: 'state-set-get',
                        name: 'ØªÙ†Ø¸ÛŒÙ… Ùˆ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø§ÛŒÙ‡ set Ùˆ get',
                        performance: false,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            
                            // ØªØ³Øª set
                            stateManager.set('testKey', 'testValue');
                            stateManager.set('nested', { level1: { level2: 'value' } });
                            
                            // ØªØ³Øª get
                            const value1 = stateManager.get('testKey');
                            const value2 = stateManager.get('nested');
                            
                            if (value1 !== 'testValue') throw new Error('Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯');
                            if (value2.level1.level2 !== 'value') throw new Error('Ù…Ù‚Ø¯Ø§Ø± ØªÙˆØ¯Ø±ØªÙˆ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯');
                            
                            // ØªØ³Øª has
                            if (!stateManager.has('testKey')) throw new Error('has Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                            
                            return `âœ… ${stateManager.size()} ÙˆØ¶Ø¹ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`;
                        }
                    },
                    {
                        id: 'state-update',
                        name: 'Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯',
                        performance: false,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            
                            stateManager.set('counter', 0);
                            stateManager.update('counter', prev => prev + 1);
                            stateManager.update('counter', prev => prev + 1);
                            
                            const counter = stateManager.get('counter');
                            if (counter !== 2) throw new Error('Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                            
                            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ object
                            stateManager.set('user', { name: 'Ø¹Ù„ÛŒ', age: 25 });
                            stateManager.update('user', prev => ({ ...prev, age: 26 }));
                            
                            const user = stateManager.get('user');
                            if (user.age !== 26) throw new Error('Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ object Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                            
                            return `âœ… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚. counter: ${counter}, user.age: ${user.age}`;
                        }
                    },
                    {
                        id: 'state-delete-clear',
                        name: 'Ø­Ø°Ù ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø­Ø°Ù ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ ÙØ±Ø¯ÛŒ Ùˆ Ú©Ù„ÛŒ',
                        performance: false,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            
                            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú†Ù†Ø¯ ÙˆØ¶Ø¹ÛŒØª
                            stateManager.set('key1', 'value1');
                            stateManager.set('key2', 'value2');
                            stateManager.set('key3', 'value3');
                            
                            const initialSize = stateManager.size();
                            
                            // Ø­Ø°Ù ÙØ±Ø¯ÛŒ
                            stateManager.delete('key2');
                            if (stateManager.has('key2')) throw new Error('Ø­Ø°Ù ÙØ±Ø¯ÛŒ Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                            
                            // Ø­Ø°Ù Ú©Ù„ÛŒ
                            stateManager.clear();
                            if (stateManager.size() <= 0) throw new Error('Ø­Ø°Ù Ú©Ù„ÛŒ Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                            
                            // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
                            const defaultKeys = stateManager.keys();
                            
                            return `âœ… Ø­Ø°Ù Ù…ÙˆÙÙ‚. ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${defaultKeys.join(', ')}`;
                        }
                    }
                ]
            },
            {
                id: 'state-advanced',
                name: 'ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡',
                icon: 'ğŸš€',
                tests: [
                    {
                        id: 'state-undo-redo',
                        name: 'Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ (Undo/Redo)',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ undo Ùˆ redo',
                        performance: false,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            
                            // Ø§ÛŒØ¬Ø§Ø¯ ØªØºÛŒÛŒØ±Ø§Øª
                            stateManager.set('step1', 'value1', 'Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„');
                            stateManager.set('step2', 'value2', 'Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…');
                            stateManager.set('step3', 'value3', 'Ù…Ø±Ø­Ù„Ù‡ Ø³ÙˆÙ…');
                            
                            const initial = stateManager.get('step3');
                            
                            // undo Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡
                            stateManager.undo(); // Ø­Ø°Ù step3
                            stateManager.undo(); // Ø­Ø°Ù step2
                            
                            if (stateManager.has('step3')) throw new Error('Undo Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                            
                            // redo ÛŒÚ© Ù…Ø±Ø­Ù„Ù‡
                            stateManager.redo(); // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ step2
                            
                            if (!stateManager.has('step2')) throw new Error('Redo Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                            
                            const history = stateManager.getHistory();
                            const future = stateManager.getFuture();
                            
                            return `âœ… Undo/Redo ÙØ¹Ø§Ù„. ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${history.length}, Ø¢ÛŒÙ†Ø¯Ù‡: ${future.length}`;
                        }
                    },
                    {
                        id: 'state-validation',
                        name: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ validation rules Ø¨Ø±Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§',
                        performance: false,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            
                            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† rule Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                            const removeValidation = stateManager.addValidation('age', value => {
                                return typeof value === 'number' && value >= 0 && value <= 120;
                            });
                            
                            // ØªØ³Øª Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù…ÙˆÙÙ‚
                            stateManager.set('age', 25);
                            
                            // ØªØ³Øª Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚
                            let validationError = false;
                            try {
                                stateManager.set('age', 150); // Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø¯Ù‡Ø¯
                            } catch (error) {
                                validationError = true;
                            }
                            
                            if (!validationError) throw new Error('Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ rule Ù†Ù‚Ø¶ Ø´Ø¯');
                            
                            // Ø­Ø°Ù rule Ùˆ ØªØ³Øª Ù…Ø¬Ø¯Ø¯
                            removeValidation();
                            stateManager.set('age', 200); // Ø­Ø§Ù„Ø§ Ø¨Ø§ÛŒØ¯ Ú©Ø§Ø± Ú©Ù†Ø¯
                            
                            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ù„ÛŒ
                            const validationResult = stateManager.validateAll();
                            
                            return `âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ¹Ø§Ù„. Ù†ØªÛŒØ¬Ù‡: ${validationResult.valid ? 'Ù…Ø¹ØªØ¨Ø±' : 'Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}`;
                        }
                    },
                    {
                        id: 'state-middleware',
                        name: 'Ø³ÛŒØ³ØªÙ… Middleware',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ middleware Ø¨Ø±Ø§ÛŒ intercept Ú©Ø±Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª',
                        performance: false,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            let middlewareCalled = false;
                            let blockedOperation = false;
                            
                            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† middleware
                            const removeMiddleware = stateManager.use({
                                beforeSet: (change) => {
                                    middlewareCalled = true;
                                    console.log('Middleware: beforeSet', change);
                                    
                                    // Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø±Ø§ÛŒ keyÙ‡Ø§ÛŒ Ø®Ø§Øµ
                                    if (change.key === 'blockedKey') {
                                        return false;
                                    }
                                    return true;
                                },
                                
                                afterSet: (change) => {
                                    console.log('Middleware: afterSet', change);
                                }
                            });
                            
                            // ØªØ³Øª middleware Ø¹Ø§Ø¯ÛŒ
                            stateManager.set('allowedKey', 'value');
                            if (!middlewareCalled) throw new Error('Middleware ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù†Ø´Ø¯');
                            
                            // ØªØ³Øª middleware Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†Ù†Ø¯Ù‡
                            try {
                                stateManager.set('blockedKey', 'value');
                            } catch (error) {
                                blockedOperation = true;
                            }
                            
                            if (!blockedOperation) throw new Error('Middleware Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†Ù†Ø¯Ù‡ Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                            
                            // Ø­Ø°Ù middleware
                            removeMiddleware();
                            
                            return 'âœ… Ø³ÛŒØ³ØªÙ… Middleware Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯';
                        }
                    },
                    {
                        id: 'state-persistence',
                        name: 'Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§ÛŒØ¯Ø§Ø±',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø² localStorage',
                        performance: false,
                        run: async () => {
                            const testKey = 'vakamova_state_test';
                            const stateManager = new MockStateManager();
                            
                            // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† persistence
                            stateManager.enablePersistence(testKey);
                            
                            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Øª
                            stateManager.set('persistedData', {
                                timestamp: new Date().toISOString(),
                                value: 'Ø§ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯'
                            });
                            
                            // Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ
                            stateManager.saveToStorage();
                            
                            // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© state manager Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
                            const newStateManager = new MockStateManager();
                            newStateManager.enablePersistence(testKey);
                            
                            // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø§Ø¯Ù‡
                            const restoredData = newStateManager.get('persistedData');
                            if (!restoredData || restoredData.value !== 'Ø§ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯') {
                                throw new Error('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø´Ø¯Ù†Ø¯');
                            }
                            
                            // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
                            localStorage.removeItem(testKey);
                            stateManager.disablePersistence();
                            newStateManager.disablePersistence();
                            
                            return 'âœ… Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯';
                        }
                    }
                ]
            },
            {
                id: 'state-performance',
                name: 'ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯',
                icon: 'âš¡',
                tests: [
                    {
                        id: 'state-bulk-operations',
                        name: 'Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø§ Û±Û°Û°Û° Ø¹Ù…Ù„ÛŒØ§Øª set',
                        performance: true,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            const startTime = performance.now();
                            const operations = 1000;
                            
                            for (let i = 0; i < operations; i++) {
                                stateManager.set(`key_${i}`, {
                                    index: i,
                                    data: 'x'.repeat(100), // Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ Ø³Ø§ÛŒØ² Ù…ØªÙˆØ³Ø·
                                    timestamp: Date.now()
                                });
                            }
                            
                            const endTime = performance.now();
                            const duration = endTime - startTime;
                            const opsPerSecond = (operations / duration) * 1000;
                            
                            if (stateManager.size() < operations) {
                                throw new Error(`ØªÙ†Ù‡Ø§ ${stateManager.size()} Ø§Ø² ${operations} Ø¹Ù…Ù„ÛŒØ§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`);
                            }
                            
                            return `â±ï¸ ${operations} Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± ${duration.toFixed(2)}ms (${opsPerSecond.toFixed(0)} ops/sec)`;
                        }
                    },
                    {
                        id: 'state-memory-usage',
                        name: 'Ù…ØµØ±Ù Ø­Ø§ÙØ¸Ù‡',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø­Ø§ÙØ¸Ù‡ Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø¬ÛŒÙ…',
                        performance: true,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            const initialMemory = performance.memory?.usedJSHeapSize || 0;
                            
                            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø¬ÛŒÙ…
                            const largeData = [];
                            for (let i = 0; i < 1000; i++) {
                                largeData.push({
                                    id: i,
                                    content: 'Ù…Ø­ØªÙˆØ§'.repeat(100),
                                    metadata: {
                                        created: new Date().toISOString(),
                                        tags: ['test', 'performance', 'large-data']
                                    }
                                });
                            }
                            
                            stateManager.set('largeDataset', largeData);
                            
                            const finalMemory = performance.memory?.usedJSHeapSize || initialMemory + 10000000;
                            const memoryIncrease = finalMemory - initialMemory;
                            
                            // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù†Ø´Øª Ø­Ø§ÙØ¸Ù‡
                            stateManager.delete('largeDataset');
                            
                            if (memoryIncrease < 5000000) { // Ú©Ù…ØªØ± Ø§Ø² 5MB
                                return `âœ… Ù…ØµØ±Ù Ø­Ø§ÙØ¸Ù‡ Ù…Ù†Ø§Ø³Ø¨: ${(memoryIncrease / 1024 / 1024).toFixed(2)}MB`;
                            } else if (memoryIncrease < 10000000) { // Ú©Ù…ØªØ± Ø§Ø² 10MB
                                return `âš ï¸ Ù…ØµØ±Ù Ø­Ø§ÙØ¸Ù‡ Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„: ${(memoryIncrease / 1024 / 1024).toFixed(2)}MB`;
                            } else {
                                throw new Error(`ğŸ’¥ Ù…ØµØ±Ù Ø­Ø§ÙØ¸Ù‡ Ø²ÛŒØ§Ø¯: ${(memoryIncrease / 1024 / 1024).toFixed(2)}MB`);
                            }
                        }
                    },
                    {
                        id: 'state-concurrent-updates',
                        name: 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø§ Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†',
                        performance: true,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            const startTime = performance.now();
                            const concurrentOperations = 100;
                            
                            // Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†
                            const promises = [];
                            for (let i = 0; i < concurrentOperations; i++) {
                                promises.push(
                                    new Promise(resolve => {
                                        setTimeout(() => {
                                            stateManager.set(`concurrent_${i}`, {
                                                thread: i,
                                                timestamp: Date.now()
                                            });
                                            resolve(i);
                                        }, Math.random() * 10);
                                    })
                                );
                            }
                            
                            await Promise.all(promises);
                            const endTime = performance.now();
                            const duration = endTime - startTime;
                            
                            // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ‡
                            let lostData = 0;
                            for (let i = 0; i < concurrentOperations; i++) {
                                if (!stateManager.has(`concurrent_${i}`)) {
                                    lostData++;
                                }
                            }
                            
                            if (lostData > 0) {
                                throw new Error(`${lostData} Ø§Ø² ${concurrentOperations} Ø¹Ù…Ù„ÛŒØ§Øª Ù‡Ù…Ø²Ù…Ø§Ù† Ø§Ø² Ø¯Ø³Øª Ø±ÙØª`);
                            }
                            
                            return `âœ… ${concurrentOperations} Ø¹Ù…Ù„ÛŒØ§Øª Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ø± ${duration.toFixed(2)}ms`;
                        }
                    }
                ]
            },
            {
                id: 'state-integration',
                name: 'ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ',
                icon: 'ğŸ”—',
                tests: [
                    {
                        id: 'state-reactivity',
                        name: 'ÙˆØ§Ú©Ù†Ø´â€ŒÙ¾Ø°ÛŒØ±ÛŒ',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ listeners',
                        performance: false,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            let listenerCalled = false;
                            let receivedKey = null;
                            let receivedValue = null;
                            
                            // Ø«Ø¨Øª listener
                            const unsubscribe = stateManager.subscribe((key, newValue, oldValue) => {
                                listenerCalled = true;
                                receivedKey = key;
                                receivedValue = newValue;
                                console.log(`Listener: ${key} =`, newValue);
                            });
                            
                            // Ø§ÛŒØ¬Ø§Ø¯ ØªØºÛŒÛŒØ±
                            stateManager.set('reactiveKey', 'reactiveValue');
                            
                            if (!listenerCalled) throw new Error('Listener ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù†Ø´Ø¯');
                            if (receivedKey !== 'reactiveKey') throw new Error('Key Ù†Ø§Ø¯Ø±Ø³Øª Ø¨Ù‡ listener Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
                            if (receivedValue !== 'reactiveValue') throw new Error('Value Ù†Ø§Ø¯Ø±Ø³Øª Ø¨Ù‡ listener Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
                            
                            // Ù„ØºÙˆ subscription
                            unsubscribe();
                            listenerCalled = false;
                            
                            // ØªØºÛŒÛŒØ± Ø¯ÛŒÚ¯Ø± (Ø¨Ø§ÛŒØ¯ listener ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù†Ø´ÙˆØ¯)
                            stateManager.set('anotherKey', 'anotherValue');
                            if (listenerCalled) throw new Error('Listener Ù¾Ø³ Ø§Ø² unsubscribe Ù‡Ù…Ú†Ù†Ø§Ù† ÙØ¹Ø§Ù„ Ø§Ø³Øª');
                            
                            return 'âœ… Ø³ÛŒØ³ØªÙ… ÙˆØ§Ú©Ù†Ø´â€ŒÙ¾Ø°ÛŒØ±ÛŒ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯';
                        }
                    },
                    {
                        id: 'state-snapshot',
                        name: 'Snapshot Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØª snapshot Ú¯Ø±ÙØªÙ† Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ',
                        performance: false,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            
                            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Øª
                            stateManager.set('app', { name: 'Vakamova', version: '1.0.0' });
                            stateManager.set('user', { id: 123, name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª' });
                            stateManager.set('settings', { theme: 'dark', language: 'fa' });
                            
                            // Ú¯Ø±ÙØªÙ† snapshot
                            const snapshot = stateManager.getSnapshot();
                            
                            // Ø§ÛŒØ¬Ø§Ø¯ state manager Ø¬Ø¯ÛŒØ¯
                            const restoredManager = new MockStateManager();
                            
                            // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² snapshot (Ø¯Ø± MockStateManager Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø´Ø¯Ù‡ØŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…)
                            // Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø¨Ø§ÛŒØ¯ Ù…ØªØ¯ restoreFromSnapshot ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                            for (const [key, value] of Object.entries(snapshot.state)) {
                                restoredManager.set(key, value);
                            }
                            
                            // Ù…Ù‚Ø§ÛŒØ³Ù‡
                            const originalState = stateManager.getAll();
                            const restoredState = restoredManager.getAll();
                            
                            let matches = true;
                            for (const key in originalState) {
                                if (JSON.stringify(originalState[key]) !== JSON.stringify(restoredState[key])) {
                                    matches = false;
                                    break;
                                }
                            }
                            
                            if (!matches) throw new Error('Snapshot Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø´Ø¯');
                            
                            return `âœ… Snapshot Ø¨Ø§ ${Object.keys(originalState).length} ÙˆØ¶Ø¹ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯`;
                        }
                    },
                    {
                        id: 'state-complex-structures',
                        name: 'Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ØŒ Ø§Ø´ÛŒØ§Ø¡ ØªÙˆØ¯Ø±ØªÙˆ Ùˆ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆÛŒÚ˜Ù‡',
                        performance: false,
                        run: async () => {
                            const stateManager = new MockStateManager();
                            
                            // ØªØ³Øª Ø§Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„Ù Ø¯Ø§Ø¯Ù‡
                            const complexData = {
                                array: [1, 2, 3, { nested: true }],
                                nestedObject: {
                                    level1: {
                                        level2: {
                                            level3: 'Ø¹Ù…ÛŒÙ‚'
                                        }
                                    }
                                },
                                specialValues: {
                                    nullValue: null,
                                    undefinedValue: undefined,
                                    date: new Date(),
                                    regex: /test/gi,
                                    function: () => console.log('test'),
                                    infinity: Infinity,
                                    nan: NaN
                                },
                                map: new Map([['key', 'value']]),
                                set: new Set([1, 2, 3])
                            };
                            
                            stateManager.set('complex', complexData);
                            const retrieved = stateManager.get('complex');
                            
                            // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ (Ø¨Ø¹Ø¶ÛŒ Ù…ÙˆØ§Ø±Ø¯ Ù…Ø§Ù†Ù†Ø¯ function Ùˆ Map/Set Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± JSON Ø§Ø² Ø¨ÛŒÙ† Ø¨Ø±ÙˆÙ†Ø¯)
                            if (!retrieved.array || retrieved.array.length !== 4) {
                                throw new Error('Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯');
                            }
                            
                            if (!retrieved.nestedObject || retrieved.nestedObject.level1.level2.level3 !== 'Ø¹Ù…ÛŒÙ‚') {
                                throw new Error('Ø§Ø´ÛŒØ§ ØªÙˆØ¯Ø±ØªÙˆ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù†Ø¯');
                            }
                            
                            return 'âœ… Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯';
                        }
                    }
                ]
            }
        ];

        // ============ Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ØªØ³Øªâ€ŒÙ‡Ø§ ============
        class StateTestManager {
            constructor() {
                this.logger = new StateLogger();
                this.stateManager = new MockStateManager();
                this.results = new Map();
                this.totalTests = 0;
                this.completedTests = 0;
                this.performanceTests = 0;
                this.stateCount = 0;
                
                this.calculateStats();
                this.renderTests();
                this.setupEventListeners();
                this.updateDisplay();
                this.initializeSimulator();
            }
            
            calculateStats() {
                this.totalTests = STATE_TEST_SUITES.reduce(
                    (sum, suite) => sum + suite.tests.length, 0
                );
                this.performanceTests = STATE_TEST_SUITES.reduce(
                    (sum, suite) => sum + suite.tests.filter(t => t.performance).length, 0
                );
            }
            
            renderTests() {
                const container = document.getElementById('test-container');
                container.innerHTML = '';
                
                STATE_TEST_SUITES.forEach(suite => {
                    const section = document.createElement('div');
                    section.className = 'test-section';
                    section.innerHTML = `
                        <h2><span>${suite.icon}</span> ${suite.name}</h2>
                        <div id="suite-${suite.id}">
                            ${suite.tests.map(test => `
                                <div class="test-item ${test.performance ? 'performance' : ''}" id="test-${test.id}">
                                    <div class="test-header">
                                        <div class="test-title">
                                            ${test.name}
                                            ${test.performance ? '<span class="test-performance">Ø¹Ù…Ù„Ú©Ø±Ø¯</span>' : ''}
                                        </div>
                                        <div class="test-status status-pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 8px;">
                                        ${test.description}
                                    </div>
                                    <div class="test-output" id="output-${test.id}" style="display: none;"></div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                });
            }
            
            setupEventListeners() {
                document.getElementById('run-tests').addEventListener('click', () => {
                    this.runAllTests();
                });
                
                document.getElementById('run-performance').addEventListener('click', () => {
                    this.runPerformanceTests();
                });
                
                document.getElementById('clear-results').addEventListener('click', () => {
                    if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                        this.clearResults();
                    }
                });
                
                document.getElementById('export-results').addEventListener('click', () => {
                    this.exportResults();
                });
            }
            
            async runAllTests() {
                const runButton = document.getElementById('run-tests');
                runButton.disabled = true;
                runButton.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
                
                this.logger.log('Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª');
                
                for (const suite of STATE_TEST_SUITES) {
                    this.logger.log(`Ø´Ø±ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ${suite.name}`);
                    for (const test of suite.tests) {
                        await this.runSingleTest(test);
                    }
                }
                
                runButton.disabled = false;
                runButton.innerHTML = '<span>ğŸš€</span> Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§';
                
                this.showSummary();
            }
            
            async runPerformanceTests() {
                const performanceButton = document.getElementById('run-performance');
                performanceButton.disabled = true;
                performanceButton.innerHTML = '<span class="loading"></span> ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯...';
                
                this.logger.log('Ø´Ø±ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙˆÛŒÚ˜Ù‡');
                
                for (const suite of STATE_TEST_SUITES) {
                    for (const test of suite.tests.filter(t => t.performance)) {
                        await this.runSingleTest(test);
                    }
                }
                
                performanceButton.disabled = false;
                performanceButton.innerHTML = '<span>âš¡</span> ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯';
                
                this.showPerformanceChart();
            }
            
            async runSingleTest(test) {
                const testElement = document.getElementById(`test-${test.id}`);
                const statusElement = testElement.querySelector('.test-status');
                const outputElement = document.getElementById(`output-${test.id}`);
                
                // Ø±ÛŒØ³Øª ÙˆØ¶Ø¹ÛŒØª
                testElement.className = `test-item ${test.performance ? 'performance' : ''}`;
                statusElement.className = 'test-status status-pending';
                statusElement.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
                outputElement.style.display = 'none';
                
                try {
                    const startTime = performance.now();
                    const result = await test.run();
                    const duration = performance.now() - startTime;
                    
                    // Ù…ÙˆÙÙ‚
                    testElement.classList.add('passed');
                    statusElement.className = 'test-status status-passed';
                    statusElement.textContent = `Ù…ÙˆÙÙ‚ (${duration.toFixed(0)}ms)`;
                    outputElement.textContent = result;
                    outputElement.className = 'test-output success';
                    outputElement.style.display = 'block';
                    
                    this.results.set(test.id, { 
                        success: true, 
                        result,
                        duration,
                        performance: test.performance 
                    });
                    
                    if (test.performance) {
                        this.logger.performanceLog(`ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ "${test.name}"`, duration);
                    } else {
                        this.logger.log(`ØªØ³Øª "${test.name}" Ù…ÙˆÙÙ‚`, { duration: `${duration.toFixed(0)}ms` });
                    }
                    
                } catch (error) {
                    // Ø´Ú©Ø³Øª
                    testElement.classList.add('failed');
                    statusElement.className = 'test-status status-failed';
                    statusElement.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
                    outputElement.textContent = `Ø®Ø·Ø§: ${error.message}\n${error.stack || ''}`;
                    outputElement.className = 'test-output error';
                    outputElement.style.display = 'block';
                    
                    this.results.set(test.id, { 
                        success: false, 
                        error: error.message,
                        performance: test.performance 
                    });
                    
                    this.logger.error(`ØªØ³Øª "${test.name}" Ù†Ø§Ù…ÙˆÙÙ‚`, error);
                }
                
                this.completedTests++;
                this.updateDisplay();
            }
            
            updateDisplay() {
                const passed = Array.from(this.results.values()).filter(r => r.success).length;
                const failed = Array.from(this.results.values()).filter(r => !r.success).length;
                const performancePassed = Array.from(this.results.values())
                    .filter(r => r.performance && r.success).length;
                const pending = this.totalTests - this.completedTests;
                
                document.getElementById('passed-count').textContent = passed;
                document.getElementById('failed-count').textContent = failed;
                document.getElementById('performance-count').textContent = performancePassed;
                document.getElementById('state-count').textContent = this.stateManager.size();
                document.getElementById('pending-count').textContent = pending;
            }
            
            clearResults() {
                this.results.clear();
                this.completedTests = 0;
                this.renderTests();
                this.updateDisplay();
                this.logger.log('Ù†ØªØ§ÛŒØ¬ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
                
                // Ø±ÛŒØ³Øª state manager
                this.stateManager = new MockStateManager();
                this.updateStateVisualizer();
            }
            
            exportResults() {
                const results = {
                    timestamp: new Date().toISOString(),
                    system: 'State Management System',
                    totalTests: this.totalTests,
                    completedTests: this.completedTests,
                    performanceTests: this.performanceTests,
                    results: Object.fromEntries(this.results),
                    logs: this.logger.logs,
                    stats: this.logger.getStats(),
                    currentState: this.stateManager.getAll()
                };
                
                const dataStr = JSON.stringify(results, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `vakamova-state-test-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                this.logger.log('Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
            }
            
            showSummary() {
                const passed = Array.from(this.results.values()).filter(r => r.success).length;
                const failed = this.completedTests - passed;
                const performancePassed = Array.from(this.results.values())
                    .filter(r => r.performance && r.success).length;
                const successRate = ((passed / this.totalTests) * 100).toFixed(1);
                
                const performanceLogs = this.logger.logs.filter(l => l.type === 'performance');
                const avgPerformance = performanceLogs.length > 0 
                    ? (performanceLogs.reduce((sum, l) => sum + l.duration, 0) / performanceLogs.length).toFixed(2)
                    : 0;
                
                const summary = `
ğŸ¯ Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬ ØªØ³Øª Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª:
âœ… Ù…ÙˆÙÙ‚: ${passed} Ø§Ø² ${this.totalTests}
âŒ Ù†Ø§Ù…ÙˆÙÙ‚: ${failed}
âš¡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯: ${performancePassed} Ø§Ø² ${this.performanceTests}
ğŸ“Š Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª: ${successRate}%
â±ï¸ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§: ${avgPerformance}ms
ğŸ—ƒï¸ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ: ${this.stateManager.size()}
                `.trim();
                
                this.logger.log(summary);
                
                // Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ù„Ø§Ù†
                if (failed === 0 && performancePassed === this.performanceTests) {
                    alert(`ğŸ‰ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ø§Ù…Ù„!\n${summary}`);
                } else if (failed > 0) {
                    alert(`âš ï¸ ${failed} ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¯Ø§Ø´ØªÛŒÙ….\n${summary}`);
                }
            }
            
            showPerformanceChart() {
                const performanceResults = Array.from(this.results.values())
                    .filter(r => r.performance && r.duration)
                    .slice(-5); // Ûµ ØªØ³Øª Ø¢Ø®Ø±
                
                if (performanceResults.length === 0) return;
                
                const maxDuration = Math.max(...performanceResults.map(r => r.duration));
                
                let chartHTML = '<div class="performance-chart"><h4>ğŸ“Š Ù†Ù…ÙˆØ¯Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯</h4>';
                
                performanceResults.forEach((result, index) => {
                    const width = (result.duration / maxDuration) * 100;
                    chartHTML += `
                        <div class="chart-label">
                            <span>ØªØ³Øª ${index + 1}</span>
                            <span>${result.duration.toFixed(2)}ms</span>
                        </div>
                        <div class="chart-bar" style="width: ${width}%"></div>
                    `;
                });
                
                chartHTML += '</div>';
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø§ÙˆÙ„ÛŒÙ† ØªØ³Øª performance
                const firstPerfTest = document.querySelector('.test-item.performance');
                if (firstPerfTest) {
                    const existingChart = firstPerfTest.querySelector('.performance-chart');
                    if (existingChart) existingChart.remove();
                    firstPerfTest.insertAdjacentHTML('beforeend', chartHTML);
                }
            }
            
            // ============ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² ============
            
            initializeSimulator() {
                this.simulatorState = new MockStateManager();
                this.updateStateVisualizer();
            }
            
            updateStateVisualizer() {
                const visualizer = document.getElementById('state-visualizer');
                const state = this.simulatorState.getAll();
                
                const formatValue = (value, indent = 0) => {
                    const spaces = '  '.repeat(indent);
                    
                    if (value === null) return '<span class="state-value">null</span>';
                    if (value === undefined) return '<span class="state-value">undefined</span>';
                    
                    if (Array.isArray(value)) {
                        return `[<br>${value.map(v => spaces + '  ' + formatValue(v, indent + 1)).join(',<br>')}<br>${spaces}]`;
                    }
                    
                    if (typeof value === 'object' && value !== null) {
                        const entries = Object.entries(value);
                        if (entries.length === 0) return '{}';
                        
                        return `{<br>${entries.map(([k, v]) => 
                            spaces + '  <span class="state-key">"' + k + '"</span>: ' + formatValue(v, indent + 1)
                        ).join(',<br>')}<br>${spaces}}`;
                    }
                    
                    if (typeof value === 'string') {
                        return `<span class="state-value">"${value}"</span>`;
                    }
                    
                    if (typeof value === 'number') {
                        return `<span class="state-value">${value}</span>`;
                    }
                    
                    if (typeof value === 'boolean') {
                        return `<span class="state-value">${value}</span>`;
                    }
                    
                    return `<span class="state-type">${typeof value}</span>`;
                };
                
                visualizer.innerHTML = formatValue(state);
            }
            
            simulateSetState() {
                const key = `key_${Date.now()}`;
                const value = {
                    type: 'simulated',
                    timestamp: new Date().toISOString(),
                    random: Math.random()
                };
                
                this.simulatorState.set(key, value, 'Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯');
                this.updateStateVisualizer();
                
                document.getElementById('current-action').textContent = 
                    `Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: ${key} = ${JSON.stringify(value).substring(0, 50)}...`;
                
                this.logger.stateChange('simulator_set', null, { [key]: value });
                this.stateCount = this.simulatorState.size();
                this.updateDisplay();
            }
            
            simulateUpdateState() {
                const keys = this.simulatorState.keys().filter(k => !k.startsWith('system'));
                if (keys.length === 0) {
                    alert('Ø§Ø¨ØªØ¯Ø§ ÙˆØ¶Ø¹ÛŒØªÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯');
                    return;
                }
                
                const randomKey = keys[Math.floor(Math.random() * keys.length)];
                const currentValue = this.simulatorState.get(randomKey);
                
                if (typeof currentValue === 'object' && currentValue !== null) {
                    const updatedValue = {
                        ...currentValue,
                        updated: true,
                        updateCount: (currentValue.updateCount || 0) + 1,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    this.simulatorState.set(randomKey, updatedValue, 'Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª');
                    this.updateStateVisualizer();
                    
                    document.getElementById('current-action').textContent = 
                        `Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${randomKey} (${currentValue.updateCount || 0} â†’ ${updatedValue.updateCount})`;
                } else {
                    this.simulatorState.set(randomKey, 'UPDATED', 'Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø³Ø§Ø¯Ù‡');
                    this.updateStateVisualizer();
                    
                    document.getElementById('current-action').textContent = 
                        `Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${randomKey} = "UPDATED"`;
                }
                
                this.logger.stateChange('simulator_update', { [randomKey]: currentValue }, 
                    { [randomKey]: this.simulatorState.get(randomKey) });
            }
            
            simulateDeleteState() {
                const keys = this.simulatorState.keys().filter(k => !k.startsWith('system'));
                if (keys.length === 0) {
                    alert('Ø§Ø¨ØªØ¯Ø§ ÙˆØ¶Ø¹ÛŒØªÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯');
                    return;
                }
                
                const randomKey = keys[Math.floor(Math.random() * keys.length)];
                const currentValue = this.simulatorState.get(randomKey);
                
                this.simulatorState.delete(randomKey, 'Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ: Ø­Ø°Ù ÙˆØ¶Ø¹ÛŒØª');
                this.updateStateVisualizer();
                
                document.getElementById('current-action').textContent = 
                    `Ø­Ø°Ù Ø´Ø¯: ${randomKey}`;
                
                this.logger.stateChange('simulator_delete', { [randomKey]: currentValue }, null);
                this.stateCount = this.simulatorState.size();
                this.updateDisplay();
            }
            
            simulateNestedState() {
                const key = `nested_${Date.now()}`;
                const value = {
                    level1: {
                        level2: {
                            level3: {
                                message: 'Ø§ÛŒÙ† ÛŒÚ© Ø³Ø§Ø®ØªØ§Ø± ØªÙˆØ¯Ø±ØªÙˆ Ø§Ø³Øª',
                                depth: 3,
                                items: ['Ø¢ÛŒØªÙ… Û±', 'Ø¢ÛŒØªÙ… Û²', 'Ø¢ÛŒØªÙ… Û³'],
                                metadata: {
                                    created: new Date().toISOString(),
                                    type: 'nested'
                                }
                            }
                        }
                    }
                };
                
                this.simulatorState.set(key, value, 'Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ø§Ø®ØªØ§Ø± ØªÙˆØ¯Ø±ØªÙˆ');
                this.updateStateVisualizer();
                
                document.getElementById('current-action').textContent = 
                    `Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: Ø³Ø§Ø®ØªØ§Ø± ØªÙˆØ¯Ø±ØªÙˆ (${key})`;
                
                this.logger.stateChange('simulator_nested', null, { [key]: value });
                this.stateCount = this.simulatorState.size();
                this.updateDisplay();
            }
            
            simulateUndo() {
                const change = this.simulatorState.undo();
                if (change) {
                    this.updateStateVisualizer();
                    document.getElementById('current-action').textContent = 
                        `Undo: ${change.description || change.type} (${change.key})`;
                    this.stateCount = this.simulatorState.size();
                    this.updateDisplay();
                } else {
                    document.getElementById('current-action').textContent = 'Ù‡ÛŒÚ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Undo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯';
                }
            }
            
            simulateRedo() {
                const change = this.simulatorState.redo();
                if (change) {
                    this.updateStateVisualizer();
                    document.getElementById('current-action').textContent = 
                        `Redo: ${change.description || change.type} (${change.key})`;
                    this.stateCount = this.simulatorState.size();
                    this.updateDisplay();
                } else {
                    document.getElementById('current-action').textContent = 'Ù‡ÛŒÚ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Redo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯';
                }
            }
        }

        // ============ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ùˆ ØªÙˆØ§Ø¨Ø¹ Ø¹Ù…ÙˆÙ…ÛŒ ============
        let stateTestManager;

        document.addEventListener('DOMContentLoaded', () => {
            stateTestManager = new StateTestManager();
            console.log('âœ… Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª Vakamova Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª');
        });

        // ØªÙˆØ§Ø¨Ø¹ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ HTML
        window.simulateSetState = () => stateTestManager.simulateSetState();
        window.simulateUpdateState = () => stateTestManager.simulateUpdateState();
        window.simulateDeleteState = () => stateTestManager.simulateDeleteState();
        window.simulateNestedState = () => stateTestManager.simulateNestedState();
        window.simulateUndo = () => stateTestManager.simulateUndo();
        window.simulateRedo = () => stateTestManager.simulateRedo();
    </script>
</body>
  </html>
