<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vakamova Core Modules Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            line-height: 1.6;
            direction: rtl;
            text-align: right;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        .test-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #2980b9; }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .log-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            text-align: left;
            direction: ltr;
        }
        .step {
            margin: 15px 0;
            padding: 10px;
            border-right: 4px solid #3498db;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Vakamova Core Modules Test</h1>
        <p>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù‡Ø³ØªÙ‡ Ù¾Ø±ÙˆÚ˜Ù‡</p>
        
        <!-- ØªØ³Øª EventBus -->
        <div class="test-section">
            <h2 class="test-title">1. ØªØ³Øª EventBus</h2>
            <div class="step">
                <p><strong>Ù‡Ø¯Ù:</strong> Ø¨Ø±Ø±Ø³ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ù†ØªØ´Ø§Ø±/Ø§Ø´ØªØ±Ø§Ú© Ø±ÙˆÛŒØ¯Ø§Ø¯</p>
                <button onclick="testEventBus()">Ø´Ø±ÙˆØ¹ ØªØ³Øª EventBus</button>
                <div id="eventbus-result" class="test-result"></div>
                <div id="eventbus-log" class="log-output"></div>
            </div>
        </div>

        <!-- ØªØ³Øª StateManager + EventBus -->
        <div class="test-section">
            <h2 class="test-title">2. ØªØ³Øª StateManager Ø¨Ø§ EventBus</h2>
            <div class="step">
                <p><strong>Ù‡Ø¯Ù:</strong> Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ StateManager Ùˆ EventBus</p>
                <button onclick="testStateManager()" id="state-btn" disabled>Ø´Ø±ÙˆØ¹ ØªØ³Øª StateManager</button>
                <div id="statemanager-result" class="test-result"></div>
                <div id="statemanager-log" class="log-output"></div>
            </div>
        </div>

        <!-- ØªØ³Øª SessionManager -->
        <div class="test-section">
            <h2 class="test-title">3. ØªØ³Øª SessionManager</h2>
            <div class="step">
                <p><strong>Ù‡Ø¯Ù:</strong> Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø´Ù† Ú©Ø§Ø±Ø¨Ø±</p>
                <button onclick="testSessionManager()" id="session-btn" disabled>Ø´Ø±ÙˆØ¹ ØªØ³Øª SessionManager</button>
                <div id="session-result" class="test-result"></div>
                <div id="session-log" class="log-output"></div>
            </div>
        </div>

        <!-- ØªØ³Øª OfflineQueue -->
        <div class="test-section">
            <h2 class="test-title">4. ØªØ³Øª OfflineQueue</h2>
            <div class="step">
                <p><strong>Ù‡Ø¯Ù:</strong> Ø¨Ø±Ø±Ø³ÛŒ ØµÙ Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ÙÙ„Ø§ÛŒÙ†</p>
                <button onclick="testOfflineQueue()" id="queue-btn" disabled>Ø´Ø±ÙˆØ¹ ØªØ³Øª OfflineQueue</button>
                <div id="queue-result" class="test-result"></div>
                <div id="queue-log" class="log-output"></div>
            </div>
        </div>

        <!-- ØªØ³Øª RealTimeSync -->
        <div class="test-section">
            <h2 class="test-title">5. ØªØ³Øª RealTimeSync</h2>
            <div class="step">
                <p><strong>Ù‡Ø¯Ù:</strong> Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ù„Ø§Ø¯Ø±Ù†Ú¯</p>
                <button onclick="testRealTimeSync()" id="sync-btn" disabled>Ø´Ø±ÙˆØ¹ ØªØ³Øª RealTimeSync</button>
                <div id="sync-result" class="test-result"></div>
                <div id="sync-log" class="log-output"></div>
            </div>
        </div>

        <!-- ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ¯ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</h2>
            <div class="step">
                <p><strong>Ù‡Ø¯Ù:</strong> ØªØ³Øª ØªØ¹Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ Ø¨Ø§ Ù‡Ù…</p>
                <button onclick="runFullIntegrationTest()" id="full-test-btn" disabled>Ø´Ø±ÙˆØ¹ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡</button>
                <div id="full-result" class="test-result"></div>
                <div id="full-log" class="log-output"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ - ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ø³ÛŒØ± Ø¯Ø±Ø³Øª Ù‡Ø³ØªÙ†Ø¯
        import { createEventBus } from './core/event-bus.js';
        import { createWebSessionManager } from './core/session-manager.js';
        import { createWebOfflineQueue } from './core/offline-queue.js';
        // StateManager Ùˆ RealTimeSync Ø±Ø§ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ³Øª
        let eventBus = null;
        let sessionManager = null;
        let offlineQueue = null;
        let stateManager = null;
        let realTimeSync = null;

        // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯
        function logTo(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `<div class="${type}">[${timestamp}] ${message}</div>`;
            element.innerHTML += logEntry;
            element.scrollTop = element.scrollHeight;
        }

        // 1. ØªØ³Øª EventBus
        window.testEventBus = async function() {
            const resultEl = document.getElementById('eventbus-result');
            const logEl = 'eventbus-log';
            
            resultEl.innerHTML = '';
            resultEl.className = 'test-result info';
            resultEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª EventBus...';
            
            try {
                logTo(logEl, 'ğŸ”§ Ø³Ø§Ø®Øª EventBus...', 'info');
                eventBus = createEventBus({ enableLogging: true });
                
                // ØªØ³Øª Listener
                class TestListener {
                    async handleEvent(eventType, eventData) {
                        logTo(logEl, `ğŸ“¢ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: ${eventType}`, 'success');
                        return true;
                    }
                }
                
                // Subscribe
                logTo(logEl, 'ğŸ“ Ø«Ø¨Øª Listener Ø¨Ø±Ø§ÛŒ test.event...', 'info');
                const unsubscribe = eventBus.subscribe('test.event', new TestListener());
                
                // Publish
                logTo(logEl, 'ğŸš€ Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯ test.event...', 'info');
                await eventBus.publish('test.event', { test: 'data' }, { source: 'test' });
                
                // Unsubscribe
                unsubscribe();
                logTo(logEl, 'âœ… Ù„ØºÙˆ subscription...', 'info');
                
                // ØªØ³Øª Ø®Ø·Ø§
                logTo(logEl, 'ğŸ§ª ØªØ³Øª Ø®Ø·Ø§Ù‡Ø§...', 'info');
                try {
                    await eventBus.publish('', {});
                } catch (e) {
                    logTo(logEl, `âœ… Ø®Ø·Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: ${e.message}`, 'success');
                }
                
                resultEl.className = 'test-result success';
                resultEl.textContent = 'âœ… EventBus Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ³Øª Ø´Ø¯!';
                
                // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯
                document.getElementById('state-btn').disabled = false;
                logTo(logEl, 'ğŸ‰ EventBus Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª!', 'success');
                
            } catch (error) {
                resultEl.className = 'test-result error';
                resultEl.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± EventBus: ${error.message}`;
                logTo(logEl, `âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
                console.error('EventBus error:', error);
            }
        };

        // 2. ØªØ³Øª StateManager
        window.testStateManager = async function() {
            const resultEl = document.getElementById('statemanager-result');
            const logEl = 'statemanager-log';
            
            resultEl.innerHTML = '';
            resultEl.className = 'test-result info';
            resultEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª StateManager...';
            
            try {
                logTo(logEl, 'ğŸ“¦ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª StateManager...', 'info');
                
                // ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… StateManager Ø¨Ù‡ Ø§ÛŒÙ† ØµÙˆØ±Øª export Ø´Ø¯Ù‡
                const { StateManager } = await import('./core/state-manager.js');
                
                logTo(logEl, 'ğŸ”§ Ø³Ø§Ø®Øª StateManager Ø¨Ø§ EventBus...', 'info');
                stateManager = new StateManager({
                    eventBus,
                    initialState: {
                        user: null,
                        lessons: [],
                        settings: { theme: 'light', language: 'fa' },
                        offlineQueue: []
                    }
                });
                
                // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª state
                eventBus.subscribe('state.changed', {
                    async handleEvent(eventType, eventData) {
                        logTo(logEl, `ğŸ”„ State ØªØºÛŒÛŒØ± Ú©Ø±Ø¯: ${eventData.type}`, 'info');
                    }
                });
                
                // ØªØ³Øª ØªØºÛŒÛŒØ± state
                logTo(logEl, 'ğŸ§ª ØªØ³Øª ØªØºÛŒÛŒØ± state...', 'info');
                stateManager.dispatch({
                    type: 'UPDATE_SETTINGS',
                    payload: { theme: 'dark' }
                });
                
                // Ø¨Ø±Ø±Ø³ÛŒ state Ø¬Ø¯ÛŒØ¯
                const state = stateManager.getState();
                logTo(logEl, `âœ… State ÙØ¹Ù„ÛŒ: theme = ${state.settings.theme}`, 'success');
                
                // ØªØ³Øª persistence (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
                if (stateManager.save) {
                    logTo(logEl, 'ğŸ’¾ ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ state...', 'info');
                    await stateManager.save();
                    logTo(logEl, 'âœ… Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆÙÙ‚', 'success');
                }
                
                resultEl.className = 'test-result success';
                resultEl.textContent = 'âœ… StateManager Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ³Øª Ø´Ø¯!';
                
                // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ
                document.getElementById('session-btn').disabled = false;
                document.getElementById('queue-btn').disabled = false;
                logTo(logEl, 'ğŸ‰ StateManager Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª!', 'success');
                
            } catch (error) {
                resultEl.className = 'test-result error';
                resultEl.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± StateManager: ${error.message}`;
                logTo(logEl, `âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
                console.error('StateManager error:', error);
            }
        };

        // 3. ØªØ³Øª SessionManager
        window.testSessionManager = async function() {
            const resultEl = document.getElementById('session-result');
            const logEl = 'session-log';
            
            resultEl.innerHTML = '';
            resultEl.className = 'test-result info';
            resultEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª SessionManager...';
            
            try {
                logTo(logEl, 'ğŸ”§ Ø³Ø§Ø®Øª SessionManager...', 'info');
                sessionManager = createWebSessionManager(eventBus, {
                    accessTokenTTL: 10000, // 10 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª
                    sessionTimeout: 20000
                });
                
                // Initialize
                logTo(logEl, 'ğŸ”„ Initialize SessionManager...', 'info');
                await sessionManager.initialize();
                
                // ØªØ³Øª Login (mock)
                logTo(logEl, 'ğŸ” ØªØ³Øª Login...', 'info');
                const session = await sessionManager.login({
                    email: 'test@vakamova.com',
                    password: 'test123'
                });
                
                logTo(logEl, `âœ… Login Ù…ÙˆÙÙ‚: Ú©Ø§Ø±Ø¨Ø± ${session.userId}`, 'success');
                logTo(logEl, `ğŸ”‘ ØªÙˆÚ©Ù†: ${session.accessToken.substring(0, 20)}...`, 'info');
                
                // Ø¨Ø±Ø±Ø³ÛŒ authentication
                logTo(logEl, 'ğŸ§ª Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø²...', 'info');
                const isAuth = sessionManager.isAuthenticated();
                logTo(logEl, `âœ… ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø²: ${isAuth}`, 'success');
                
                // ØªØ³Øª auto-refresh
                logTo(logEl, 'â° ØªØ³Øª auto-refresh (10 Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†)...', 'warning');
                
                setTimeout(async () => {
                    try {
                        const newSession = await sessionManager.refreshAccessToken();
                        logTo(logEl, 'âœ… ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª refresh Ø´Ø¯!', 'success');
                    } catch (refreshError) {
                        logTo(logEl, `âš ï¸ Ø®Ø·Ø§ Ø¯Ø± refresh: ${refreshError.message}`, 'warning');
                    }
                }, 11000);
                
                // ØªØ³Øª Logout
                setTimeout(async () => {
                    logTo(logEl, 'ğŸ‘‹ ØªØ³Øª Logout...', 'info');
                    await sessionManager.logout();
                    logTo(logEl, 'âœ… Logout Ù…ÙˆÙÙ‚', 'success');
                    logTo(logEl, `ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù¾Ø³ Ø§Ø² logout: ${sessionManager.isAuthenticated()}`, 'info');
                }, 15000);
                
                resultEl.className = 'test-result success';
                resultEl.textContent = 'âœ… SessionManager Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ³Øª Ø´Ø¯!';
                
                // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ø¹Ø¯ÛŒ
                document.getElementById('sync-btn').disabled = false;
                logTo(logEl, 'ğŸ‰ SessionManager Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª!', 'success');
                
            } catch (error) {
                resultEl.className = 'test-result error';
                resultEl.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± SessionManager: ${error.message}`;
                logTo(logEl, `âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
                console.error('SessionManager error:', error);
            }
        };

        // 4. ØªØ³Øª OfflineQueue
        window.testOfflineQueue = async function() {
            const resultEl = document.getElementById('queue-result');
            const logEl = 'queue-log';
            
            resultEl.innerHTML = '';
            resultEl.className = 'test-result info';
            resultEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª OfflineQueue...';
            
            try {
                logTo(logEl, 'ğŸ”§ Ø³Ø§Ø®Øª OfflineQueue...', 'info');
                offlineQueue = createWebOfflineQueue(eventBus, {
                    maxQueueSize: 10,
                    processInterval: 3000
                });
                
                // Ø³Ø§Ø®Øª mock processor
                class TestProcessor {
                    canProcess(operationType) {
                        return operationType === 'TEST_OPERATION';
                    }
                    
                    async process(operation) {
                        logTo(logEl, `ğŸ”§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¹Ù…Ù„ÛŒØ§Øª: ${operation.id}`, 'info');
                        return { success: true, result: 'processed' };
                    }
                }
                
                // Ø«Ø¨Øª processor
                offlineQueue.registerProcessor(new TestProcessor());
                
                // Initialize
                logTo(logEl, 'ğŸ”„ Initialize OfflineQueue...', 'info');
                await offlineQueue.initialize();
                
                // Enqueue Ø¹Ù…Ù„ÛŒØ§Øª
                logTo(logEl, 'ğŸ“ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ù‡ ØµÙ...', 'info');
                const op1 = await offlineQueue.enqueue('TEST_OPERATION', 
                    { data: 'test1' }, 
                    { priority: 1 }
                );
                const op2 = await offlineQueue.enqueue('TEST_OPERATION', 
                    { data: 'test2' }, 
                    { priority: 2 }
                );
                
                logTo(logEl, `âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: ${op1.id}, ${op2.id}`, 'success');
                
                // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±
                const stats = offlineQueue.getStats();
                logTo(logEl, `ğŸ“Š Ø¢Ù…Ø§Ø± ØµÙ: ${JSON.stringify(stats)}`, 'info');
                
                // Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´
                logTo(logEl, 'ğŸš€ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙ...', 'info');
                offlineQueue.startProcessing();
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² 5 Ø«Ø§Ù†ÛŒÙ‡
                setTimeout(() => {
                    const newStats = offlineQueue.getStats();
                    logTo(logEl, `ğŸ“Š Ø¢Ù…Ø§Ø± Ù¾Ø³ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø²Ø´: ${JSON.stringify(newStats)}`, 'info');
                    
                    // ØªÙˆÙ‚Ù Ù¾Ø±Ø¯Ø§Ø²Ø´
                    offlineQueue.stopProcessing();
                    logTo(logEl, 'â¹ï¸ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ØªÙˆÙ‚Ù Ø´Ø¯', 'info');
                }, 5000);
                
                resultEl.className = 'test-result success';
                resultEl.textContent = 'âœ… OfflineQueue Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ³Øª Ø´Ø¯!';
                logTo(logEl, 'ğŸ‰ OfflineQueue Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª!', 'success');
                
            } catch (error) {
                resultEl.className = 'test-result error';
                resultEl.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± OfflineQueue: ${error.message}`;
                logTo(logEl, `âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
                console.error('OfflineQueue error:', error);
            }
        };

        // 5. ØªØ³Øª RealTimeSync
        window.testRealTimeSync = async function() {
            const resultEl = document.getElementById('sync-result');
            const logEl = 'sync-log';
            
            resultEl.innerHTML = '';
            resultEl.className = 'test-result info';
            resultEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª RealTimeSync...';
            
            try {
                logTo(logEl, 'ğŸ“¦ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª RealTimeSync...', 'info');
                
                // ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… RealTimeSync Ø¨Ù‡ Ø§ÛŒÙ† ØµÙˆØ±Øª export Ø´Ø¯Ù‡
                const { createRealTimeSync } = await import('./core/real-time-sync.js');
                
                logTo(logEl, 'ğŸ”§ Ø³Ø§Ø®Øª RealTimeSync...', 'info');
                realTimeSync = createRealTimeSync({
                    eventBus,
                    stateManager,
                    offlineQueue
                }, {
                    syncInterval: 10000,
                    autoSyncOnOnline: true
                });
                
                // Initialize
                logTo(logEl, 'ğŸ”„ Initialize RealTimeSync...', 'info');
                await realTimeSync.initialize();
                
                // Ø´Ø±ÙˆØ¹ auto-sync
                logTo(logEl, 'ğŸš€ Ø´Ø±ÙˆØ¹ auto-sync...', 'info');
                realTimeSync.startAutoSync();
                
                // ØªØ³Øª sync Ø¯Ø³ØªÛŒ
                logTo(logEl, 'ğŸ§ª ØªØ³Øª sync Ø¯Ø³ØªÛŒ...', 'info');
                try {
                    const result = await realTimeSync.syncEntity('user', 'test_user');
                    logTo(logEl, `âœ… Ù†ØªÛŒØ¬Ù‡ sync: ${result.status}`, 'success');
                } catch (syncError) {
                    logTo(logEl, `âš ï¸ Ø®Ø·Ø§ Ø¯Ø± sync: ${syncError.message}`, 'warning');
                }
                
                // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± sync
                setTimeout(() => {
                    logTo(logEl, 'ğŸ“Š ÙˆØ¶Ø¹ÛŒØª sync Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡...', 'info');
                    // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¢Ù…Ø§Ø± Ø¨ÛŒØ´ØªØ±ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯
                }, 3000);
                
                resultEl.className = 'test-result success';
                resultEl.textContent = 'âœ… RealTimeSync Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ³Øª Ø´Ø¯!';
                
                // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡
                document.getElementById('full-test-btn').disabled = false;
                logTo(logEl, 'ğŸ‰ RealTimeSync Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª!', 'success');
                
            } catch (error) {
                resultEl.className = 'test-result error';
                resultEl.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± RealTimeSync: ${error.message}`;
                logTo(logEl, `âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
                console.error('RealTimeSync error:', error);
            }
        };

        // 6. ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
        window.runFullIntegrationTest = async function() {
            const resultEl = document.getElementById('full-result');
            const logEl = 'full-log';
            
            resultEl.innerHTML = '';
            resultEl.className = 'test-result info';
            resultEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡...';
            
            logTo(logEl, 'ğŸ¯ Ø´Ø±ÙˆØ¹ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ ØªÙ…Ø§Ù… Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§', 'info');
            logTo(logEl, '='.repeat(50), 'info');
            
            // Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ ØªØ³Øª: Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ ØªØºÛŒÛŒØ±Ø§ØªÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯
            try {
                // 1. Ù„Ø§Ú¯ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±
                logTo(logEl, '1. ğŸ” Ù„Ø§Ú¯ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±...', 'info');
                if (!sessionManager) {
                    throw new Error('SessionManager Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                }
                
                // 2. ØªØºÛŒÛŒØ± state (Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯)
                logTo(logEl, '2. ğŸ“ ØªØºÛŒÛŒØ± state - Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³...', 'info');
                if (stateManager) {
                    stateManager.dispatch({
                        type: 'ADD_LESSON',
                        payload: {
                            id: 'lesson_1',
                            title: 'Ø¯Ø±Ø³ ØªØ³Øª',
                            progress: 0
                        }
                    });
                    logTo(logEl, 'âœ… Ø¯Ø±Ø³ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
                }
                
                // 3. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ù‡ offline queue
                logTo(logEl, '3. ğŸ“¦ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª sync Ø¨Ù‡ ØµÙ Ø¢ÙÙ„Ø§ÛŒÙ†...', 'info');
                if (offlineQueue) {
                    await offlineQueue.enqueue('SYNC_LESSON_PROGRESS', {
                        lessonId: 'lesson_1',
                        progress: 50
                    });
                    logTo(logEl, 'âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ù‡ ØµÙ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
                }
                
                // 4. Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ†
                logTo(logEl, '4. ğŸŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡...', 'info');
                await eventBus.publish('network.status', { isOnline: false }, { source: 'test' });
                logTo(logEl, 'ğŸ“¶ ÙˆØ¶Ø¹ÛŒØª: Ø¢ÙÙ„Ø§ÛŒÙ†', 'warning');
                
                setTimeout(async () => {
                    await eventBus.publish('network.status', { isOnline: true }, { source: 'test' });
                    logTo(logEl, 'ğŸ“¶ ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù†Ù„Ø§ÛŒÙ†', 'success');
                    logTo(logEl, 'ğŸ”„ Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ø§ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´ÙˆÙ†Ø¯...', 'info');
                }, 2000);
                
                // 5. ØªØ³Øª sync
                logTo(logEl, '5. ğŸ”„ ØªØ³Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ...', 'info');
                if (realTimeSync) {
                    setTimeout(async () => {
                        try {
                            const results = await realTimeSync.syncAll({ background: true });
                            logTo(logEl, `âœ… Ù†ØªØ§ÛŒØ¬ sync: ${results.length} Ø¹Ù…Ù„ÛŒØ§Øª`, 'success');
                        } catch (syncError) {
                            logTo(logEl, `âš ï¸ Ø®Ø·Ø§ Ø¯Ø± sync: ${syncError.message}`, 'warning');
                        }
                    }, 3000);
                }
                
                // 6. Ù„Ø§Ú¯Ø§ÙˆØª
                logTo(logEl, '6. ğŸ‘‹ Ù„Ø§Ú¯Ø§ÙˆØª Ú©Ø§Ø±Ø¨Ø±...', 'info');
                setTimeout(async () => {
                    try {
                        await sessionManager.logout();
                        logTo(logEl, 'âœ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„Ø§Ú¯Ø§ÙˆØª Ø´Ø¯', 'success');
                        
                        // Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
                        setTimeout(() => {
                            resultEl.className = 'test-result success';
                            resultEl.textContent = 'ğŸ‰ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!';
                            logTo(logEl, '='.repeat(50), 'info');
                            logTo(logEl, 'âœ… ØªÙ…Ø§Ù…ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø¨Ø§ Ù‡Ù… Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯!', 'success');
                        }, 1000);
                    } catch (logoutError) {
                        logTo(logEl, `âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„Ø§Ú¯Ø§ÙˆØª: ${logoutError.message}`, 'error');
                    }
                }, 5000);
                
            } catch (error) {
                resultEl.className = 'test-result error';
                resultEl.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡: ${error.message}`;
                logTo(logEl, `âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
                console.error('Integration test error:', error);
            }
        };

        // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÙˆÙ„ÛŒÙ† Ø¯Ú©Ù…Ù‡
        document.addEventListener('DOMContentLoaded', () => {
            logTo('eventbus-log', 'ğŸ“± Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ø±ÙˆÛŒ "Ø´Ø±ÙˆØ¹ ØªØ³Øª EventBus" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.', 'info');
        });
    </script>
</body>
</html>
