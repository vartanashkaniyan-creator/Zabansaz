name: ðŸš€ Deploy Vakamova to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    
    steps:
      # 1. Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 2. Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯
      - name: ðŸ“‹ List All Files
        run: |
          echo "ðŸ“ Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡ Vakamova:"
          find . -type f -name "*.js" -o -name "*.html" -o -name "*.json" | sort
          echo ""
          echo "ðŸ“¦ Ø­Ø¬Ù… Ù¾ÙˆØ´Ù‡ core:"
          du -sh core/ || echo "Ù¾ÙˆØ´Ù‡ core ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
          echo "ðŸ“¦ Ø­Ø¬Ù… Ù¾ÙˆØ´Ù‡ modules:"
          du -sh modules/ || echo "Ù¾ÙˆØ´Ù‡ modules ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
          echo "ðŸ“¦ Ø­Ø¬Ù… Ù¾ÙˆØ´Ù‡ pages:"
          du -sh pages/ || echo "Ù¾ÙˆØ´Ù‡ pages ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
          
      # 3. Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ .nojekyll (Ù…Ù‡Ù…!)
      - name: ðŸ›¡ï¸ Create .nojekyll File
        run: |
          touch .nojekyll
          echo "ÙØ§ÛŒÙ„ .nojekyll Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
          
      # 4. Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ CNAME (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
      - name: ðŸŒ Create CNAME File
        run: |
          echo "vartanashkaniyan-creator.github.io" > CNAME
          
      # 5. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ JS
      - name: ðŸ” Validate JavaScript Files
        run: |
          echo "Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ:"
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ core
          if [ -f "core/event_bus.js" ]; then
            echo "âœ… core/event_bus.js Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
            head -5 core/event_bus.js
          else
            echo "âŒ core/event_bus.js ÛŒØ§ÙØª Ù†Ø´Ø¯!"
            exit 1
          fi
          
          if [ -f "modules/auth/auth_manager.js" ]; then
            echo "âœ… modules/auth/auth_manager.js Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
          else
            echo "âš ï¸ modules/auth/auth_manager.js ÛŒØ§ÙØª Ù†Ø´Ø¯"
          fi
          
      # 6. Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Git
      - name: âš™ï¸ Setup Git Configuration
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      # 7. Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ GitHub Pages
      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./  # Ú©Ù„ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ ÙØ¹Ù„ÛŒ
          publish_branch: gh-pages  # Ø´Ø§Ø®Ù‡ Ù‡Ø¯Ù
          force_orphan: true  # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‚Ø¨Ù„ÛŒ
          enable_jekyll: false  # ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Jekyll
          cname: vartanashkaniyan-creator.github.io
          
      # 8. ØªØ£ÛŒÛŒØ¯ Ø¢Ù¾Ù„ÙˆØ¯
      - name: âœ… Verify Deployment
        run: |
          echo "ðŸŽ‰ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ú©Ø§Ù…Ù„ Ø´Ø¯!"
          echo "ðŸŒ Ø¢Ø¯Ø±Ø³ Ù¾Ø±ÙˆÚ˜Ù‡: https://vartanashkaniyan-creator.github.io/Zabansaz/"
          echo ""
          echo "ðŸ“‚ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡:"
          echo "- https://vartanashkaniyan-creator.github.io/Zabansaz/index.html"
          echo "- https://vartanashkaniyan-creator.github.io/Zabansaz/core/event_bus.js"
          echo "- https://vartanashkaniyan-creator.github.io/Zabansaz/modules/auth/auth_manager.js"
          echo "- https://vartanashkaniyan-creator.github.io/Zabansaz/integration_test.html"
          
      # 9. Ø®Ø±ÙˆØ¬ÛŒ URL
      - name: ðŸ“¤ Set Deployment URL
        id: deployment
        run: |
          echo "page_url=https://vartanashkaniyan-creator.github.io/Zabansaz/" >> $GITHUB_OUTPUT
