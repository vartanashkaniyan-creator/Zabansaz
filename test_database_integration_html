<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Database Integration - Vakamova</title>
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§... (Ù‡Ù…Ø§Ù† Ú©Ø¯ CSS Ù‚Ø¨Ù„ÛŒ) */
        *{box-sizing:border-box;margin:0;padding:0}body{font-family:'Segoe UI',Tahoma,sans-serif;line-height:1.6;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:#333;padding:20px;min-height:100vh}.container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,0.98);border-radius:20px;box-shadow:0 25px 70px rgba(0,0,0,0.3);overflow:hidden}header{background:linear-gradient(135deg,#1a237e 0%,#283593 100%);color:#fff;padding:30px;text-align:center}header h1{font-size:2.3rem;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:15px}.badge{background:#4caf50;color:#fff;padding:5px 15px;border-radius:20px;font-size:.9rem;font-weight:bold}.test-sections{display:flex;flex-direction:column;gap:30px;padding:30px}.section{background:#fff;border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.08);border:2px solid #e3f2fd}.section-title{font-size:1.4rem;font-weight:bold;margin-bottom:20px;color:#1a237e;padding-bottom:10px;border-bottom:3px solid #e3f2fd;display:flex;justify-content:space-between;align-items:center}.test-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px;margin-top:20px}.test-item{background:#f8f9fa;border-radius:10px;padding:20px;border-left:4px solid #7986cb;transition:all .3s ease}.test-item:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(121,134,203,0.1)}.test-item.passed{border-left-color:#4caf50;background:#f1f8e9}.test-item.failed{border-left-color:#f44336;background:#ffebee}.test-item.running{border-left-color:#ff9800;background:#fff3e0}.test-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.test-name{font-weight:bold;color:#37474f}.test-status{padding:4px 12px;border-radius:15px;font-size:.85rem;font-weight:bold}.status-passed{background:#c8e6c9;color:#2e7d32}.status-failed{background:#ffcdd2;color:#c62828}.status-pending{background:#fff9c4;color:#f57c00}.status-running{background:#bbdefb;color:#1565c0}.test-details{margin-top:10px;font-size:.9rem;color:#546e7a}.test-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}.stat-box{background:#fff;border-radius:10px;padding:15px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.05);border:2px solid #e3f2fd}.stat-value{font-size:1.8rem;font-weight:bold;margin-bottom:5px}.stat-label{font-size:.9rem;color:#78909c}.action-bar{display:flex;justify-content:center;gap:20px;padding:30px;border-top:2px solid #e3f2fd}button{background:linear-gradient(135deg,#1a237e 0%,#283593 100%);color:#fff;border:none;padding:14px 35px;border-radius:10px;font-size:1rem;font-weight:bold;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:10px;min-width:200px}button:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(26,35,126,0.3)}button:active{transform:translateY(0)}button.secondary{background:linear-gradient(135deg,#546e7a 0%,#78909c 100%)}.progress-bar{width:100%;height:8px;background:#e0e0e0;border-radius:4px;margin:20px 0;overflow:hidden}.progress-fill{height:100%;background:linear-gradient(90deg,#4caf50,#8bc34a);width:0;transition:width .5s ease}.console{background:#263238;color:#eceff1;padding:20px;border-radius:10px;font-family:'Courier New',monospace;font-size:.9rem;max-height:300px;overflow-y:auto;margin-top:20px;direction:ltr;text-align:left}.console-line{margin-bottom:8px;padding:5px 10px;border-radius:4px;background:rgba(255,255,255,0.05)}.log-info{color:#80cbc4}.log-success{color:#c5e1a5}.log-error{color:#ef9a9a}.log-warning{color:#fff59d}.loading{display:inline-block;width:20px;height:20px;border:3px solid #e3f2fd;border-top-color:#1a237e;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}@media (max-width:768px){.test-grid{grid-template-columns:1fr}.action-bar{flex-direction:column;align-items:center}button{width:100%;max-width:300px}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span>ğŸ—ƒï¸ ØªØ³Øª Database Integration</span><span class="badge">Vakamova</span></h1>
            <p>ØªØ³Øª Ú©Ø§Ù…Ù„ CRUD + Migration + ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡</p>
        </header>
        <div class="test-sections">
            <div class="section">
                <div class="section-title"><span>ğŸ“Š Ø¢Ù…Ø§Ø± ØªØ³Øª</span><span id="overall-status" class="status-pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span></div>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                <div class="test-stats">
                    <div class="stat-box"><div class="stat-value" id="passed-count">0</div><div class="stat-label">Ù…ÙˆÙÙ‚</div></div>
                    <div class="stat-box"><div class="stat-value" id="failed-count">0</div><div class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</div></div>
                    <div class="stat-box"><div class="stat-value" id="total-count">12</div><div class="stat-label">Ú©Ù„ ØªØ³Øªâ€ŒÙ‡Ø§</div></div>
                    <div class="stat-box"><div class="stat-value" id="coverage">0%</div><div class="stat-label">Ù¾ÙˆØ´Ø´</div></div>
                </div>
            </div>
            <div class="section">
                <div class="section-title"><span>ğŸ”„ ØªØ³Øª Migration</span><span style="background:#fff3e0;color:#ef6c00;padding:3px 10px;border-radius:12px;font-size:.8rem;font-weight:bold">v1 â†’ v3</span></div>
                <div class="test-grid" id="migration-tests"></div>
            </div>
            <div class="section">
                <div class="section-title"><span>ğŸ§ª ØªØ³Øª CRUD Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§</span><div><span style="background:#e3f2fd;color:#1565c0;padding:3px 10px;border-radius:12px;font-size:.8rem;font-weight:bold;margin-left:8px">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</span><span style="background:#f3e5f5;color:#7b1fa2;padding:3px 10px;border-radius:12px;font-size:.8rem;font-weight:bold;margin-left:8px">Ø¯Ø±Ø³â€ŒÙ‡Ø§</span><span style="background:#e8f5e8;color:#2e7d32;padding:3px 10px;border-radius:12px;font-size:.8rem;font-weight:bold;margin-left:8px">Ù¾ÛŒØ´Ø±ÙØª</span><span style="background:#fff3e0;color:#ef6c00;padding:3px 10px;border-radius:12px;font-size:.8rem;font-weight:bold;margin-left:8px">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</span></div></div>
                <div class="test-grid" id="crud-tests"></div>
            </div>
            <div class="section">
                <div class="section-title"><span>âš¡ ØªØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡</span><span style="background:#fff3e0;color:#ef6c00;padding:3px 10px;border-radius:12px;font-size:.8rem;font-weight:bold">Atomic</span></div>
                <div class="test-grid" id="transaction-tests"></div>
            </div>
            <div class="section">
                <div class="section-title"><span>ğŸš€ ØªØ³Øª Performance</span><span style="background:#e3f2fd;color:#1565c0;padding:3px 10px;border-radius:12px;font-size:.8rem;font-weight:bold">100+ Ø±Ú©ÙˆØ±Ø¯</span></div>
                <div class="test-grid" id="performance-tests"></div>
                <div class="console" id="performance-data"></div>
            </div>
            <div class="section">
                <div class="section-title"><span>ğŸ“ Ú©Ù†Ø³ÙˆÙ„ Ù„Ø§Ú¯</span><button onclick="TestManager.clearConsole()" style="padding:8px 15px;font-size:.8rem">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button></div>
                <div class="console" id="console-output"><div class="console-line log-info">[System] ØªØ³Øª Database Integration Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª</div></div>
            </div>
        </div>
        <div class="action-bar">
            <button id="run-all-btn">ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button id="clear-db-btn" class="secondary">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ØªØ³Øª</button>
        </div>
    </div>

<script>
// ==================== Ø³ÛŒØ³ØªÙ… Ø§ØµÙ„ÛŒ ====================
const TestManager = (() => {
    const db = {
        users: new Map(), lessons: new Map(), progress: new Map(), transactions: new Map(),
        version: 1, nextId: {users:1,lessons:1,transactions:1}, transactionInProgress: false,
        async migrateTo(v) {
            log(`Ø´Ø±ÙˆØ¹ migration Ø§Ø² v${this.version} Ø¨Ù‡ v${v}`,'info');
            if(v >= 2 && this.version < 2) {
                for(let u of this.users.values()) u.level = u.level || 1;
                this.version = 2; log('Migration Ø¨Ù‡ v2 Ù…ÙˆÙÙ‚','success');
            }
            if(v >= 3 && this.version < 3) {
                for(let u of this.users.values()) u.coins = u.coins || 100;
                for(let l of this.lessons.values()) l.price = l.price || 50;
                this.version = 3; log('Migration Ø¨Ù‡ v3 Ù…ÙˆÙÙ‚','success');
            }
            return true;
        },
        async rollback() {
            if(this.version === 3) { this.version = 2; log('Rollback Ø¨Ù‡ v2','warning'); }
            return true;
        },
        async createUser(email,name) {
            const id = this.nextId.users++;
            const user = {id,email,name,level:1,coins:100,created_at:new Date().toISOString()};
            this.users.set(id,user); log(`Ú©Ø§Ø±Ø¨Ø± ${email} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`,'info'); return user;
        },
        async createLesson(title,lang,diff='beginner') {
            const id = this.nextId.lessons++;
            const lesson = {id,title,language:lang,difficulty:diff,
                price: diff==='beginner'?50:diff==='intermediate'?100:200, content:{exercises:[]}};
            this.lessons.set(id,lesson); log(`Ø¯Ø±Ø³ ${title} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`,'info'); return lesson;
        },
        async createProgress(uid,lid,score=0) {
            const key = `${uid}_${lid}`;
            const prog = {user_id:uid,lesson_id:lid,score,completed:score>=80,time_spent:0,updated_at:new Date().toISOString()};
            this.progress.set(key,prog); log(`Ù¾ÛŒØ´Ø±ÙØª Ø¨Ø±Ø§ÛŒ ${uid}/${lid} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`,'info'); return prog;
        },
        async createTransaction(uid,lid,amount,method='zarinpal') {
            const id = this.nextId.transactions++;
            const trx = {id,user_id:uid,lesson_id:lid,amount,status:'completed',payment_method:method,created_at:new Date().toISOString()};
            this.transactions.set(id,trx); log(`ØªØ±Ø§Ú©Ù†Ø´ ${id} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`,'info'); return trx;
        },
        async purchaseLesson(uid,lid) {
            this.transactionInProgress = true;
            try {
                const user = this.users.get(uid), lesson = this.lessons.get(lid);
                if(!user||!lesson) throw new Error('Ú©Ø§Ø±Ø¨Ø±/Ø¯Ø±Ø³ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                if(user.coins < lesson.price) throw new Error('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø§Ú©Ø§ÙÛŒ');
                user.coins -= lesson.price;
                const trx = await this.createTransaction(uid,lid,lesson.price);
                const prog = await this.createProgress(uid,lid,0);
                this.transactionInProgress = false;
                log('Ø®Ø±ÛŒØ¯ Ù…ÙˆÙÙ‚','success');
                return {user,lesson,trx,prog};
            } catch(e) { this.transactionInProgress = false; throw e; }
        },
        async bulkInsert(count) {
            const start = Date.now();
            for(let i=0;i<count;i++) await this.createUser(`user${i}@test.com`,`Ú©Ø§Ø±Ø¨Ø± ${i}`);
            return {count,duration:Date.now()-start};
        },
        clear() {
            this.users.clear();this.lessons.clear();this.progress.clear();this.transactions.clear();
            this.nextId={users:1,lessons:1,transactions:1};this.version=1;
            log('Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù¾Ø§Ú© Ø´Ø¯','info');
        },
        stats() { return {u:this.users.size,l:this.lessons.size,p:this.progress.size,t:this.transactions.size,v:this.version}; }
    };

    const tests = [
        {id:'m1',cat:'migration',title:'Migration v1â†’v2',desc:'Ø§ÙØ²ÙˆØ¯Ù† ÙÛŒÙ„Ø¯ level',
            run:async()=>{db.version=1;await db.migrateTo(2);if(db.version!==2)throw Error('Ù†Ø§Ù…ÙˆÙÙ‚');for(let u of db.users.values())if(!u.level)throw Error('ÙÛŒÙ„Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯');return'Ù…ÙˆÙÙ‚';}},
        {id:'m2',cat:'migration',title:'Migration v2â†’v3',desc:'Ø§ÙØ²ÙˆØ¯Ù† coins Ùˆ price',
            run:async()=>{db.version=2;await db.migrateTo(3);if(db.version!==3)throw Error('Ù†Ø§Ù…ÙˆÙÙ‚');for(let u of db.users.values())if(!u.coins)throw Error('coins Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯');return'Ù…ÙˆÙÙ‚';}},
        {id:'m3',cat:'migration',title:'Rollback v3â†’v2',desc:'Ø¨Ø§Ø²Ú¯Ø´Øª ØªØºÛŒÛŒØ±Ø§Øª',
            run:async()=>{db.version=3;await db.rollback();if(db.version!==2)throw Error('Ù†Ø§Ù…ÙˆÙÙ‚');return'Ù…ÙˆÙÙ‚';}},
        {id:'c1',cat:'crud',title:'CRUD Ú©Ø§Ø±Ø¨Ø±Ø§Ù†',desc:'Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø®ÙˆØ§Ù†Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±',
            run:async()=>{const u=await db.createUser('test@vak.com','ØªØ³Øª');if(!await db.users.get(u.id))throw Error('Ø®ÙˆØ§Ù†Ø¯Ù† Ù†Ø§Ù…ÙˆÙÙ‚');return`Ú©Ø§Ø±Ø¨Ø± ${u.name} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`;}},
        {id:'c2',cat:'crud',title:'CRUD Ø¯Ø±Ø³â€ŒÙ‡Ø§',desc:'Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø±Ø³',
            run:async()=>{const l=await db.createLesson('Ù…Ú©Ø§Ù„Ù…Ù‡','english','beginner');if(!await db.lessons.get(l.id))throw Error('Ø®ÙˆØ§Ù†Ø¯Ù† Ù†Ø§Ù…ÙˆÙÙ‚');return`Ø¯Ø±Ø³ ${l.title} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`;}},
        {id:'c3',cat:'crud',title:'CRUD Ù¾ÛŒØ´Ø±ÙØª',desc:'Ø«Ø¨Øª Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±',
            run:async()=>{const u=await db.createUser('p@t.com','Ù¾ÛŒØ´Ø±ÙØª');const l=await db.createLesson('Ø¯Ø³ØªÙˆØ±','persian');const p=await db.createProgress(u.id,l.id,85);if(!p.completed)throw Error('ØªÚ©Ù…ÛŒÙ„ Ù†Ø´Ø¯');return`Ø§Ù…ØªÛŒØ§Ø² ${p.score} Ø«Ø¨Øª Ø´Ø¯`;}},
        {id:'c4',cat:'crud',title:'CRUD ØªØ±Ø§Ú©Ù†Ø´',desc:'Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ù¾Ø±Ø¯Ø§Ø®Øª',
            run:async()=>{const u=await db.createUser('pay@t.com','Ù¾Ø±Ø¯Ø§Ø®Øª');const l=await db.createLesson('ÙˆØ§Ú˜Ù‡','turkish','advanced');const t=await db.createTransaction(u.id,l.id,200);if(t.status!=='completed')throw Error('ÙˆØ¶Ø¹ÛŒØª Ø§Ø´ØªØ¨Ø§Ù‡');return`ØªØ±Ø§Ú©Ù†Ø´ ${t.id} Ø«Ø¨Øª Ø´Ø¯`;}},
        {id:'t1',cat:'transaction',title:'ØªØ±Ø§Ú©Ù†Ø´ Ø§ØªÙ…ÛŒ Ø®Ø±ÛŒØ¯',desc:'Ú©Ø³Ø± Ú©ÙˆÛŒÙ† + Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ + Ù¾ÛŒØ´Ø±ÙØª',
            run:async()=>{const u=await db.createUser('atom@t.com','Ø§ØªÙ…ÛŒÚ©');const l=await db.createLesson('ØªÙ„ÙØ¸','german','intermediate');const r=await db.purchaseLesson(u.id,l.id);if(!r.trx||!r.prog)throw Error('Ù…Ø±Ø§Ø­Ù„ Ù†Ø§Ù‚Øµ');if(u.coins!==100-l.price)throw Error('Ú©ÙˆÛŒÙ† Ú©Ø³Ø± Ù†Ø´Ø¯');return'Ø®Ø±ÛŒØ¯ Ø§ØªÙ…ÛŒ Ù…ÙˆÙÙ‚';}},
        {id:'t2',cat:'transaction',title:'Rollback ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚',desc:'Ø¨Ø§Ø²Ú¯Ø´Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§',
            run:async()=>{const u=await db.createUser('rb@t.com','Ø±ÙˆÙ„â€ŒØ¨Ú©');const l=await db.createLesson('Ø®ÙˆØ§Ù†Ø¯Ù†','french','advanced');u.coins=10;try{await db.purchaseLesson(u.id,l.id);throw Error('Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ø§Ø¯');}catch(e){if(u.coins!==10)throw Error('Ú©ÙˆÛŒÙ† Ø¨Ø§ÛŒØ¯ Û±Û° Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯');}return'Ø±ÙˆÙ„â€ŒØ¨Ú© Ù…ÙˆÙÙ‚';}},
        {id:'p1',cat:'performance',title:'Ø¯Ø±Ø¬ Ø§Ù†Ø¨ÙˆÙ‡',desc:'Ø§ÛŒØ¬Ø§Ø¯ Û±Û°Û° Ú©Ø§Ø±Ø¨Ø±',
            run:async()=>{const r=await db.bulkInsert(100);if(r.count!==100)throw Error('ØªØ¹Ø¯Ø§Ø¯ Ù†Ø§Ø¯Ø±Ø³Øª');return`${r.count} Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ${r.duration}ms`;}},
        {id:'p2',cat:'performance',title:'Ú©ÙˆØ¦Ø±ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡',desc:'Ø§ØªØµØ§Ù„ Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´',
            run:async()=>{const u=await db.createUser('q@t.com','Ú©ÙˆØ¦Ø±ÛŒ');const l1=await db.createLesson('Û±','english');const l2=await db.createLesson('Û²','english');await db.purchaseLesson(u.id,l1.id);await db.purchaseLesson(u.id,l2.id);const start=Date.now();let count=0;for(let t of db.transactions.values()){const usr=db.users.get(t.user_id);const les=db.lessons.get(t.lesson_id);const prog=db.progress.get(`${t.user_id}_${t.lesson_id}`);if(usr&&les&&prog)count++;}const dur=Date.now()-start;if(count<2)throw Error('Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù‚Øµ');if(dur>1000)throw Error('Ú©Ù†Ø¯');return`${count} Ù†ØªÛŒØ¬Ù‡ Ø¯Ø± ${dur}ms`;}},
        {id:'p3',cat:'performance',title:'ÙÛŒÙ„ØªØ± Ú©Ø§Ø±Ø§',desc:'Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø³Ø·Ø­ Û²',
            run:async()=>{for(let i=0;i<30;i++){const u=await db.createUser(`l${i}@t.com`,`Ø³Ø·Ø­ ${i%3+1}`);u.level=i%3+1;}const start=Date.now();let res=[];for(let u of db.users.values())if(u.level===2)res.push(u);const dur=Date.now()-start;if(res.length<5)throw Error('Ù†ØªØ§ÛŒØ¬ Ú©Ù…');if(dur>200)throw Error('Ú©Ù†Ø¯');return`${res.length} Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ${dur}ms`;}}
    ];

    const state = {results:{},dom:{}};
    
    function log(msg,type='info') {
        const time = new Date().toLocaleTimeString('fa-IR');
        const line = document.createElement('div');
        line.className = `console-line log-${type}`;
        line.innerHTML = `[${time}] ${msg}`;
        const con = document.getElementById('console-output');
        con.appendChild(line); con.scrollTop = con.scrollHeight;
        console.log(`[${type}] ${msg}`);
    }
    
    function updateStats() {
        const passed = Object.values(state.results).filter(r=>r.success).length;
        const total = tests.length;
        document.getElementById('passed-count').textContent = passed;
        document.getElementById('failed-count').textContent = Object.values(state.results).filter(r=>!r.success).length;
        const cov = Math.round((passed/total)*100);
        document.getElementById('coverage').textContent = `${cov}%`;
        document.getElementById('progress-fill').style.width = `${cov}%`;
        document.getElementById('overall-status').textContent = passed===total?'Ù…ÙˆÙÙ‚':passed===0?'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±':'Ù†Ø§Ù…ÙˆÙÙ‚';
        document.getElementById('overall-status').className = passed===total?'status-passed':passed===0?'status-pending':'status-failed';
    }
    
    function renderTests() {
        const cats = {migration:'migration-tests',crud:'crud-tests',transaction:'transaction-tests',performance:'performance-tests'};
        for(const [cat,elId] of Object.entries(cats)) {
            const el = document.getElementById(elId);
            el.innerHTML = tests.filter(t=>t.cat===cat).map(t=>`
                <div class="test-item pending" id="test-${t.id}">
                    <div class="test-header"><div class="test-name">${t.title}</div><div class="test-status status-pending" id="status-${t.id}">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                    <div class="test-details">${t.details||t.desc}</div>
                    <div class="test-details" id="output-${t.id}"></div>
                </div>
            `).join('');
        }
        updateStats();
    }
    
    async function runTest(test) {
        const card = document.getElementById(`test-${test.id}`);
        const status = document.getElementById(`status-${test.id}`);
        const output = document.getElementById(`output-${test.id}`);
        card.className = 'test-item running';
        status.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
        status.className = 'test-status status-running';
        output.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
        try {
            const result = await test.run();
            card.className = 'test-item passed';
            status.textContent = 'Ù…ÙˆÙÙ‚';
            status.className = 'test-status status-passed';
            output.innerHTML = `<strong>âœ…</strong> ${result}`;
            state.results[test.id] = {success:true,result};
            log(`"${test.title}" Ù…ÙˆÙÙ‚`,'success');
            return true;
        } catch(e) {
            card.className = 'test-item failed';
            status.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
            status.className = 'test-status status-failed';
            output.innerHTML = `<strong>âŒ</strong> ${e.message}`;
            state.results[test.id] = {success:false,error:e.message};
            log(`"${test.title}" Ù†Ø§Ù…ÙˆÙÙ‚: ${e.message}`,'error');
            return false;
        } finally { updateStats(); }
    }
    
    async function runAll() {
        const btn = document.getElementById('run-all-btn');
        btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
        log('Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§','info');
        document.getElementById('performance-data').innerHTML = '';
        let passed = 0;
        for(const test of tests) {
            if(await runTest(test)) passed++;
            await new Promise(r=>setTimeout(r,200));
        }
        btn.disabled = false; btn.innerHTML = 'ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§';
        log(`ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯: ${passed}/${tests.length} Ù…ÙˆÙÙ‚`,'info');
        // Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ
        const s = db.stats();
        document.getElementById('performance-data').innerHTML = 
            `<strong>ğŸ“Š Ø¢Ù…Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³:</strong><br>
            ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: ${s.u} | ğŸ“š Ø¯Ø±Ø³â€ŒÙ‡Ø§: ${s.l}<br>
            ğŸ“ˆ Ù¾ÛŒØ´Ø±ÙØª: ${s.p} | ğŸ’³ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§: ${s.t}<br>
            ğŸ·ï¸ Ù†Ø³Ø®Ù‡: ${s.v}<br><br>
            <strong>âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Vakamova Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</strong>`;
    }
    
    function clearDatabase() {
        db.clear();
        state.results = {};
        renderTests();
        document.getElementById('performance-data').innerHTML = '';
        log('Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ØªØ³Øª Ù¾Ø§Ú© Ø´Ø¯','info');
    }
    
    function clearConsole() {
        document.getElementById('console-output').innerHTML = '<div class="console-line log-info">[System] Ú©Ù†Ø³ÙˆÙ„ Ù¾Ø§Ú© Ø´Ø¯</div>';
    }
    
    function init() {
        renderTests();
        document.getElementById('run-all-btn').addEventListener('click', runAll);
        document.getElementById('clear-db-btn').addEventListener('click', clearDatabase);
        log('Ø³ÛŒØ³ØªÙ… ØªØ³Øª Database Integration Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª','info');
    }
    
    return { init, clearConsole, runAll, clearDatabase };
})();

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
document.addEventListener('DOMContentLoaded', TestManager.init);
</script>
</body>
</html>
