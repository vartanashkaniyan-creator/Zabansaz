<!DOCTYPE html>
<html>
<head>
    <title>ØªØ³Øª OfflineQueue</title>
    <style>
        body { font-family: Tahoma; padding: 20px; text-align: center; }
        button { padding: 12px 25px; font-size: 16px; background: #FF9800; color: white; 
                 border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
        button:hover { background: #F57C00; }
        #result { margin: 20px; padding: 20px; border: 2px solid #ddd; border-radius: 10px; 
                  min-height: 150px; font-family: monospace; text-align: left; background: #f9f9f9; 
                  max-height: 400px; overflow-y: auto; }
        .queue-info { background: #FFF3E0; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .step { margin: 8px 0; padding: 8px; border-left: 4px solid #FF9800; background: white; }
        .success-step { border-left-color: #4CAF50; }
        .error-step { border-left-color: #f44336; }
        .queue-item { background: #FFECB3; margin: 5px; padding: 5px; border-radius: 3px; }
        .network-status { padding: 10px; margin: 10px; border-radius: 5px; display: inline-block; }
        .online { background: #C8E6C9; color: #2E7D32; }
        .offline { background: #FFCDD2; color: #C62828; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª OfflineQueue</h1>
    <p>ÙØ§Ø² Û´: Ù…Ø¯ÛŒØ±ÛŒØª ØµÙ Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ÙÙ„Ø§ÛŒÙ† + EventBus</p>
    
    <div>
        <button onclick="testOfflineQueue()">ØªØ³Øª OfflineQueue</button>
        <button onclick="simulateOffline()">Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†</button>
        <button onclick="simulateOnline()">Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
        <button onclick="clearLog()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
    </div>
    
    <div id="networkStatus" class="network-status online">ğŸŒ ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
    
    <div id="result">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ ØªØ³Øª...</div>
    
    <div id="queueInfo" class="queue-info">
        ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ØµÙ: Ù…Ù†ØªØ¸Ø± ØªØ³Øª...
    </div>

    <script>
        // ==================== Û±. EventBus ====================
        class EventBus {
            constructor() { this.listeners = {}; }
            on(eventName, callback) {
                if (!this.listeners[eventName]) this.listeners[eventName] = [];
                this.listeners[eventName].push(callback);
                return () => this.off(eventName, callback);
            }
            off(eventName, callback) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName] = this.listeners[eventName].filter(cb => cb !== callback);
                }
            }
            emit(eventName, data) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName].forEach(callback => {
                        try { callback(data); } catch (error) { console.error('Listener error:', error); }
                    });
                }
            }
        }
        
        // ==================== Û². OfflineQueue ====================
        class OfflineQueue {
            constructor(eventBus, config = {}) {
                this.eventBus = eventBus;
                this.config = {
                    maxQueueSize: 10,
                    processInterval: 2000, // 2 Ø«Ø§Ù†ÛŒÙ‡
                    maxRetries: 3,
                    autoStart: true,
                    ...config
                };
                
                this.queue = [];
                this.isOnline = true;
                this.isProcessing = false;
                this.processingTimer = null;
                this.nextId = 1;
                
                // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡
                this.eventBus.on('network.status', (status) => {
                    this.setOnline(status.isOnline);
                });
                
                log("âœ… OfflineQueue Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯");
                this.updateDisplay();
            }
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ù‡ ØµÙ
            async enqueue(operationType, data, options = {}) {
                if (this.queue.length >= this.config.maxQueueSize) {
                    throw new Error(`ØµÙ Ù¾Ø± Ø§Ø³Øª (Ø­Ø¯Ø§Ú©Ø«Ø±: ${this.config.maxQueueSize})`);
                }
                
                const operation = {
                    id: `op_${this.nextId++}_${Date.now()}`,
                    type: operationType,
                    data: data,
                    priority: options.priority || 0,
                    maxRetries: options.maxRetries || 3,
                    retryCount: 0,
                    state: 'PENDING',
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                this.queue.push(operation);
                this.sortQueue();
                
                log(`ğŸ“ Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ù‡ ØµÙ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: ${operationType} (ID: ${operation.id})`, 'info');
                this.eventBus.emit('operation.enqueued', operation);
                
                // Ø§Ú¯Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† Ù‡Ø³ØªÛŒÙ…ØŒ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†
                if (this.isOnline && this.config.autoStart) {
                    this.processQueue();
                }
                
                this.updateDisplay();
                return operation;
            }
            
            // Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙ
            async processQueue() {
                if (this.isProcessing || !this.isOnline || this.queue.length === 0) {
                    return;
                }
                
                this.isProcessing = true;
                log(`ğŸ”§ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙ (${this.queue.length} Ø¹Ù…Ù„ÛŒØ§Øª)`);
                
                try {
                    // Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø±
                    const pendingOps = this.queue.filter(op => 
                        op.state === 'PENDING' || op.state === 'RETRYING'
                    ).slice(0, 3); // Ø­Ø¯Ø§Ú©Ø«Ø± 3 Ø¹Ù…Ù„ÛŒØ§Øª Ù‡Ù…Ø²Ù…Ø§Ù†
                    
                    for (const operation of pendingOps) {
                        await this.processOperation(operation);
                    }
                } finally {
                    this.isProcessing = false;
                    this.updateDisplay();
                }
            }
            
            // Ù¾Ø±Ø¯Ø§Ø²Ø´ ÛŒÚ© Ø¹Ù…Ù„ÛŒØ§Øª
            async processOperation(operation) {
                operation.state = 'PROCESSING';
                this.updateDisplay();
                
                log(`âš™ï¸ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¹Ù…Ù„ÛŒØ§Øª: ${operation.type} (ID: ${operation.id})`);
                this.eventBus.emit('operation.processing', operation);
                
                try {
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ (Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§ÛŒÙ†Ø¬Ø§ API call Ù…ÛŒâ€ŒØ´Ø¯)
                    await this.simulateProcessing(operation);
                    
                    // Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ²
                    operation.state = 'COMPLETED';
                    log(`âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚: ${operation.type} (ID: ${operation.id})`, 'success');
                    this.eventBus.emit('operation.completed', operation);
                    
                    // Ø­Ø°Ù Ø§Ø² ØµÙ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø®ÛŒØ±
                    setTimeout(() => {
                        this.queue = this.queue.filter(op => op.id !== operation.id);
                        this.updateDisplay();
                    }, 1000);
                    
                } catch (error) {
                    // Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´
                    operation.retryCount++;
                    operation.updatedAt = Date.now();
                    
                    if (operation.retryCount >= operation.maxRetries) {
                        // Ø´Ú©Ø³Øª Ø¯Ø§Ø¦Ù…ÛŒ
                        operation.state = 'FAILED';
                        log(`âŒ Ø¹Ù…Ù„ÛŒØ§Øª Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯ (Ø¯Ø§Ø¦Ù…ÛŒ): ${operation.type}`, 'error');
                        this.eventBus.emit('operation.failed', { operation, error });
                    } else {
                        // Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ retry
                        operation.state = 'RETRYING';
                        const delay = this.calculateRetryDelay(operation.retryCount);
                        log(`ğŸ”„ Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø±Ø§ÛŒ retry Ø¢Ù…Ø§Ø¯Ù‡ (ØªÙ„Ø§Ø´ ${operation.retryCount}/${operation.maxRetries})`, 'warning');
                        
                        // Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ retry
                        setTimeout(() => {
                            if (operation.state === 'RETRYING') {
                                operation.state = 'PENDING';
                                if (this.isOnline) {
                                    this.processQueue();
                                }
                            }
                        }, delay);
                    }
                    
                    this.updateDisplay();
                }
            }
            
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´
            async simulateProcessing(operation) {
                return new Promise((resolve, reject) => {
                    // Ø´Ø§Ù†Ø³ 70% Ø¨Ø±Ø§ÛŒ Ù…ÙˆÙÙ‚ÛŒØªØŒ 30% Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø§
                    const isSuccess = Math.random() > 0.3;
                    
                    setTimeout(() => {
                        if (isSuccess) {
                            resolve({ success: true, data: operation.data });
                        } else {
                            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                            const errors = [
                                'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡',
                                'Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±',
                                'Ø§ØªØµØ§Ù„ timeout Ø´Ø¯',
                                'Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª'
                            ];
                            const error = errors[Math.floor(Math.random() * errors.length)];
                            reject(new Error(error));
                        }
                    }, 1000 + Math.random() * 1000); // ØªØ§Ø®ÛŒØ± 1-2 Ø«Ø§Ù†ÛŒÙ‡
                });
            }
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø®ÛŒØ± retry (exponential backoff)
            calculateRetryDelay(retryCount) {
                const baseDelay = 1000; // 1 Ø«Ø§Ù†ÛŒÙ‡
                return Math.min(baseDelay * Math.pow(2, retryCount - 1), 10000); // Ø­Ø¯Ø§Ú©Ø«Ø± 10 Ø«Ø§Ù†ÛŒÙ‡
            }
            
            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ ØµÙ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ÙˆÙ„ÙˆÛŒØª
            sortQueue() {
                this.queue.sort((a, b) => {
                    // Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ØªØ± Ø§ÙˆÙ„
                    if (b.priority !== a.priority) return b.priority - a.priority;
                    // Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§ÙˆÙ„
                    return a.createdAt - b.createdAt;
                });
            }
            
            // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ†
            setOnline(online) {
                const wasOnline = this.isOnline;
                this.isOnline = online;
                
                // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡
                const statusEl = document.getElementById('networkStatus');
                if (statusEl) {
                    statusEl.className = online ? 'network-status online' : 'network-status offline';
                    statusEl.textContent = online ? 'ğŸŒ ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'ğŸ“´ ÙˆØ¶Ø¹ÛŒØª: Ø¢ÙÙ„Ø§ÛŒÙ†';
                }
                
                if (!wasOnline && online) {
                    log("ğŸ“¶ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯ - Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙ", 'success');
                    this.eventBus.emit('network.online');
                    if (this.config.autoStart) {
                        this.processQueue();
                    }
                } else if (wasOnline && !online) {
                    log("ğŸ“¶ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯ - ØªÙˆÙ‚Ù Ù¾Ø±Ø¯Ø§Ø²Ø´", 'warning');
                    this.eventBus.emit('network.offline');
                }
            }
            
            // Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø®ÙˆØ¯Ú©Ø§Ø±
            startAutoProcessing() {
                if (this.processingTimer) return;
                
                this.processingTimer = setInterval(() => {
                    if (this.isOnline && !this.isProcessing) {
                        this.processQueue();
                    }
                }, this.config.processInterval);
                
                log("â° Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ Ø´Ø¯");
            }
            
            // ØªÙˆÙ‚Ù Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø®ÙˆØ¯Ú©Ø§Ø±
            stopAutoProcessing() {
                if (this.processingTimer) {
                    clearInterval(this.processingTimer);
                    this.processingTimer = null;
                    log("â¹ï¸ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ØªÙˆÙ‚Ù Ø´Ø¯");
                }
            }
            
            // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØµÙ
            getStats() {
                const stats = {
                    total: this.queue.length,
                    byState: {},
                    byType: {}
                };
                
                this.queue.forEach(op => {
                    stats.byState[op.state] = (stats.byState[op.state] || 0) + 1;
                    stats.byType[op.type] = (stats.byType[op.type] || 0) + 1;
                });
                
                return stats;
            }
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØµÙ
            clear() {
                this.queue = [];
                log("ğŸ—‘ï¸ ØµÙ Ù¾Ø§Ú© Ø´Ø¯");
                this.updateDisplay();
            }
            
            // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…Ø§ÛŒØ´
            updateDisplay() {
                const display = document.getElementById('queueInfo');
                if (!display) return;
                
                const stats = this.getStats();
                let html = `
                    <strong>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ØµÙ:</strong><br>
                    ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„: ${stats.total}<br>
                    ğŸ“ˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª:<br>
                `;
                
                Object.entries(stats.byState).forEach(([state, count]) => {
                    const icons = {
                        'PENDING': 'â³',
                        'PROCESSING': 'âš™ï¸',
                        'RETRYING': 'ğŸ”„',
                        'COMPLETED': 'âœ…',
                        'FAILED': 'âŒ'
                    };
                    html += `&nbsp;&nbsp;${icons[state] || 'ğŸ“Œ'} ${state}: ${count}<br>`;
                });
                
                html += `<small>ğŸ”„ Ù¾Ø±Ø¯Ø§Ø²Ø´: ${this.isProcessing ? 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§' : 'Ù…ØªÙˆÙ‚Ù'}</small>`;
                
                if (this.queue.length > 0) {
                    html += `<br><br><strong>ğŸ“‹ Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§:</strong>`;
                    this.queue.slice(0, 5).forEach(op => {
                        html += `
                            <div class="queue-item">
                                ${op.type} (${op.state})<br>
                                <small>Ø§ÙˆÙ„ÙˆÛŒØª: ${op.priority} | ØªÙ„Ø§Ø´: ${op.retryCount}/${op.maxRetries}</small>
                            </div>
                        `;
                    });
                    
                    if (this.queue.length > 5) {
                        html += `<small>+ ${this.queue.length - 5} Ø¹Ù…Ù„ÛŒØ§Øª Ø¯ÛŒÚ¯Ø±...</small>`;
                    }
                }
                
                display.innerHTML = html;
            }
        }
        
        // ==================== Û³. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
        function log(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const stepClass = type === 'success' ? 'success-step' : 
                            type === 'error' ? 'error-step' : 'step';
            
            resultDiv.innerHTML += `
                <div class="${stepClass}">
                    <strong>[${new Date().toLocaleTimeString()}]</strong> ${message}
                </div>
            `;
            resultDiv.scrollTop = resultDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('result').innerHTML = '';
        }
        
        // ==================== Û´. ØªØ³Øª Ø§ØµÙ„ÛŒ ====================
        let offlineQueue = null;
        let eventBus = null;
        
        function testOfflineQueue() {
            clearLog();
            log("ğŸ¬ Ø´Ø±ÙˆØ¹ ØªØ³Øª OfflineQueue...", "success");
            
            try {
                // Û±. Ø³Ø§Ø®Øª EventBus
                log("Ù…Ø±Ø­Ù„Ù‡ Û±: Ø³Ø§Ø®Øª EventBus...");
                eventBus = new EventBus();
                
                // Û². Ø³Ø§Ø®Øª OfflineQueue
                log("Ù…Ø±Ø­Ù„Ù‡ Û²: Ø³Ø§Ø®Øª OfflineQueue...");
                offlineQueue = new OfflineQueue(eventBus, {
                    maxQueueSize: 15,
                    processInterval: 3000,
                    maxRetries: 2
                });
                
                // Û³. Ø«Ø¨Øª listener Ø¨Ø±Ø§ÛŒ events
                log("Ù…Ø±Ø­Ù„Ù‡ Û³: Ø«Ø¨Øª listenerâ€ŒÙ‡Ø§...");
                eventBus.on('operation.enqueued', (op) => {
                    log(`ğŸ“¢ Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ù‡ ØµÙ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: ${op.type}`);
                });
                
                eventBus.on('operation.completed', (op) => {
                    log(`ğŸ“¢ Ø¹Ù…Ù„ÛŒØ§Øª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯: ${op.type}`, 'success');
                });
                
                eventBus.on('operation.failed', ({ operation, error }) => {
                    log(`ğŸ“¢ Ø¹Ù…Ù„ÛŒØ§Øª Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯: ${operation.type} - ${error.message}`, 'error');
                });
                
                eventBus.on('network.online', () => {
                    log("ğŸ“¢ Ø´Ø¨Ú©Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯", 'success');
                });
                
                eventBus.on('network.offline', () => {
                    log("ğŸ“¢ Ø´Ø¨Ú©Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯", 'warning');
                });
                
                // Û´. Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø®ÙˆØ¯Ú©Ø§Ø±
                log("Ù…Ø±Ø­Ù„Ù‡ Û´: Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø®ÙˆØ¯Ú©Ø§Ø±...");
                offlineQueue.startAutoProcessing();
                
                // Ûµ. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                log("Ù…Ø±Ø­Ù„Ù‡ Ûµ: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ ØªØ³Øª...");
                
                setTimeout(() => {
                    // Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§
                    offlineQueue.enqueue('SYNC_LESSON_PROGRESS', {
                        lessonId: 'lesson_1',
                        progress: 85,
                        userId: 'user_123'
                    }, { priority: 10, maxRetries: 3 });
                }, 500);
                
                setTimeout(() => {
                    // Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª Ù…ØªÙˆØ³Ø·
                    offlineQueue.enqueue('SYNC_USER_DATA', {
                        userId: 'user_123',
                        name: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ',
                        email: 'ali@test.com'
                    }, { priority: 5 });
                }, 1000);
                
                setTimeout(() => {
                    // Ø¹Ù…Ù„ÛŒØ§Øª Ø¯ÛŒÚ¯Ø±
                    offlineQueue.enqueue('SYNC_QUIZ_RESULT', {
                        quizId: 'quiz_1',
                        score: 95,
                        answers: [1, 2, 3]
                    }, { priority: 3 });
                }, 1500);
                
                setTimeout(() => {
                    // Ø¹Ù…Ù„ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±
                    offlineQueue.enqueue('UPLOAD_MEDIA', {
                        fileId: 'file_1',
                        type: 'audio',
                        size: 1024
                    }, { priority: 1 });
                    
                    offlineQueue.enqueue('UPDATE_SETTINGS', {
                        theme: 'dark',
                        language: 'fa'
                    }, { priority: 8 });
                }, 2000);
                
                // Û¶. Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯Ù†
                log("Ù…Ø±Ø­Ù„Ù‡ Û¶: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯Ù† (Ø¨Ø¹Ø¯ Ø§Ø² Û´ Ø«Ø§Ù†ÛŒÙ‡)...", 'warning');
                setTimeout(() => {
                    offlineQueue.setOnline(false);
                    
                    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†
                    setTimeout(() => {
                        log("â• Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†...");
                        offlineQueue.enqueue('SYNC_MESSAGES', {
                            count: 5,
                            unread: 2
                        }, { priority: 7 });
                        
                        offlineQueue.enqueue('BACKUP_DATA', {
                            timestamp: Date.now()
                        }, { priority: 2 });
                    }, 1000);
                    
                    // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†
                    setTimeout(() => {
                        log("â†—ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¢Ù†Ù„Ø§ÛŒÙ† (Ø¨Ø¹Ø¯ Ø§Ø² Û³ Ø«Ø§Ù†ÛŒÙ‡)...", 'success');
                        offlineQueue.setOnline(true);
                    }, 3000);
                }, 4000);
                
                // Û·. Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
                log("Ù…Ø±Ø­Ù„Ù‡ Û·: Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ...");
                const statsInterval = setInterval(() => {
                    const stats = offlineQueue.getStats();
                    log(`ğŸ“Š Ø¢Ù…Ø§Ø± ØµÙ: Ú©Ù„=${stats.total}, Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´=${stats.byState.PROCESSING || 0}, Ø§Ù†ØªØ¸Ø§Ø±=${stats.byState.PENDING || 0}`);
                }, 2500);
                
                // Û¸. ØªØ³Øª Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØµÙ
                setTimeout(() => {
                    log("Ù…Ø±Ø­Ù„Ù‡ Û¸: ØªØ³Øª Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØµÙ (Ø¨Ø¹Ø¯ Ø§Ø² Û±Û° Ø«Ø§Ù†ÛŒÙ‡)...");
                    offlineQueue.clear();
                    clearInterval(statsInterval);
                }, 10000);
                
                // Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
                setTimeout(() => {
                    log("=".repeat(50));
                    log("ğŸ‰ ØªØ³Øª OfflineQueue Ú©Ø§Ù…Ù„ Ø´Ø¯!", 'success');
                    log("âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± ØµÙ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯");
                    log("âœ… retry Ø¨Ø§ exponential backoff Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
                    log("âœ… Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ† Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯");
                    log("âœ… Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
                }, 12000);
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª OfflineQueue: ${error.message}`, 'error');
                console.error("OfflineQueue test error:", error);
            }
        }
        
        // ==================== Ûµ. ØªÙˆØ§Ø¨Ø¹ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ====================
        function simulateOffline() {
            if (offlineQueue) {
                offlineQueue.setOnline(false);
                log("ğŸ“´ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†", 'warning');
            } else {
                log("âš ï¸ Ø§Ø¨ØªØ¯Ø§ OfflineQueue Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯", 'error');
            }
        }
        
        function simulateOnline() {
            if (offlineQueue) {
                offlineQueue.setOnline(true);
                log("ğŸŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù„Øª Ø¢Ù†Ù„Ø§ÛŒÙ†", 'success');
            } else {
                log("âš ï¸ Ø§Ø¨ØªØ¯Ø§ OfflineQueue Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯", 'error');
            }
        }
        
        // ==================== Û¶. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡ ====================
        window.onload = function() {
            log("ğŸ“± OfflineQueue Test Ready");
            log("Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'ØªØ³Øª OfflineQueue' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯");
            log("Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ† Ø±Ø§ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯");
        };
    </script>
</body>
</html>
