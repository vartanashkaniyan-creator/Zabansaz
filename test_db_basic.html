<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ù¾Ø§ÛŒÙ‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ - Vakamova</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:tahoma;background:#1a237e;color:#333;padding:20px}.container{max-width:800px;margin:auto;background:#fff;border-radius:10px;overflow:hidden}header{background:#283593;color:#fff;padding:20px;text-align:center}h1{font-size:1.5rem}.test-section{padding:20px}.test-item{background:#f5f5f5;border-radius:8px;padding:15px;margin-bottom:15px;border-right:5px solid #7986cb}.passed{border-right-color:#4caf50;background:#e8f5e9}.failed{border-right-color:#f44336;background:#ffebee}.running{border-right-color:#ff9800;background:#fff3e0}.test-header{display:flex;justify-content:space-between;margin-bottom:10px}.test-name{font-weight:bold}.test-status{padding:3px 10px;border-radius:12px;font-size:.8rem}.status-pending{background:#fff9c4;color:#f57c00}.status-running{background:#bbdefb;color:#1565c0}.status-passed{background:#c8e6c9;color:#2e7d32}.status-failed{background:#ffcdd2;color:#c62828}button{background:#283593;color:#fff;border:none;padding:12px 25px;border-radius:8px;font-size:1rem;cursor:pointer;width:100%;margin-top:15px}button:hover{background:#1a237e}.console{background:#263238;color:#80cbc4;padding:15px;margin-top:20px;border-radius:8px;font-family:monospace;font-size:.9rem;max-height:200px;overflow-y:auto}.log{padding:5px 0;border-bottom:1px solid #37474f}
    </style>
</head>
<body>
    <div class="container">
        <header><h1>ğŸ—ƒï¸ ØªØ³Øª Ù¾Ø§ÛŒÙ‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ - CRUD + Migration</h1></header>
        <div class="test-section">
            <div class="test-item" id="test1">
                <div class="test-header"><div class="test-name">Û±. Ø³Ø§Ø®Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§ÙˆÙ„ÛŒÙ‡</div><div class="test-status status-pending" id="status1">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output1"></div>
            </div>
            <div class="test-item" id="test2">
                <div class="test-header"><div class="test-name">Û². CRUD Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div><div class="test-status status-pending" id="status2">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output2"></div>
            </div>
            <div class="test-item" id="test3">
                <div class="test-header"><div class="test-name">Û³. CRUD Ø¯Ø±Ø³â€ŒÙ‡Ø§</div><div class="test-status status-pending" id="status3">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output3"></div>
            </div>
            <div class="test-item" id="test4">
                <div class="test-header"><div class="test-name">Û´. Migration v1 â†’ v2</div><div class="test-status status-pending" id="status4">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output4"></div>
            </div>
            <div class="test-item" id="test5">
                <div class="test-header"><div class="test-name">Ûµ. Migration v2 â†’ v3</div><div class="test-status status-pending" id="status5">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output5"></div>
            </div>
            <button id="run-btn">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <div class="console" id="console">
                <div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øª Ù¾Ø§ÛŒÙ‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>
            </div>
        </div>
    </div>

<script>
// ========== Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Mock Ø³Ø§Ø¯Ù‡ ==========
const DB = {
    users: new Map(),
    lessons: new Map(),
    version: 1,
    nextUserId: 1,
    nextLessonId: 1,
    
    createUser(email, name) {
        const user = {
            id: this.nextUserId++,
            email,
            name,
            level: 1,
            coins: 100,
            createdAt: new Date()
        };
        this.users.set(user.id, user);
        this.log(`Ú©Ø§Ø±Ø¨Ø± "${name}" Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
        return user;
    },
    
    createLesson(title, language) {
        const lesson = {
            id: this.nextLessonId++,
            title,
            language,
            difficulty: 'beginner',
            price: 50,
            createdAt: new Date()
        };
        this.lessons.set(lesson.id, lesson);
        this.log(`Ø¯Ø±Ø³ "${title}" Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
        return lesson;
    },
    
    getUser(id) {
        return this.users.get(id);
    },
    
    getLesson(id) {
        return this.lessons.get(id);
    },
    
    migrateToVersion(version) {
        this.log(`Migration Ø§Ø² v${this.version} Ø¨Ù‡ v${version}`);
        
        if(version === 2 && this.version === 1) {
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ level Ø¨Ù‡ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            for(let user of this.users.values()) {
                user.level = user.level || 1;
            }
            this.version = 2;
            this.log("Migration Ø¨Ù‡ v2 Ù…ÙˆÙÙ‚ - ÙÛŒÙ„Ø¯ level Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯");
        }
        
        if(version === 3 && this.version <= 2) {
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ coins Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            for(let user of this.users.values()) {
                user.coins = user.coins || 100;
            }
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ price Ø¨Ù‡ Ø¯Ø±Ø³â€ŒÙ‡Ø§
            for(let lesson of this.lessons.values()) {
                lesson.price = lesson.price || 50;
            }
            this.version = 3;
            this.log("Migration Ø¨Ù‡ v3 Ù…ÙˆÙÙ‚ - ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ coins/price Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù†Ø¯");
        }
        
        return true;
    },
    
    log(message) {
        console.log(`[DB] ${message}`);
        const consoleEl = document.getElementById('console');
        const logEntry = document.createElement('div');
        logEntry.className = 'log';
        logEntry.textContent = `[Ø¯ÛŒØªØ§Ø¨ÛŒØ³] ${message}`;
        consoleEl.appendChild(logEntry);
        consoleEl.scrollTop = consoleEl.scrollHeight;
    },
    
    clear() {
        this.users.clear();
        this.lessons.clear();
        this.nextUserId = 1;
        this.nextLessonId = 1;
        this.version = 1;
        this.log("Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù¾Ø§Ú© Ø´Ø¯");
    }
};

// ========== Ù…Ø¯ÛŒØ±ÛŒØª ØªØ³Øªâ€ŒÙ‡Ø§ ==========
const tests = [
    {
        id: 'test1',
        name: 'Ø³Ø§Ø®Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§ÙˆÙ„ÛŒÙ‡',
        run: async () => {
            DB.clear();
            if(DB.version !== 1) throw new Error('Ù†Ø³Ø®Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ÛŒØ¯ Û± Ø¨Ø§Ø´Ø¯');
            if(DB.users.size !== 0) throw new Error('Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¨Ø§ÛŒØ¯ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯');
            return 'âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯';
        }
    },
    {
        id: 'test2',
        name: 'CRUD Ú©Ø§Ø±Ø¨Ø±Ø§Ù†',
        run: async () => {
            // Create
            const user = DB.createUser('test@vakamova.com', 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª');
            if(!user.id) throw new Error('Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯');
            
            // Read
            const fetchedUser = DB.getUser(user.id);
            if(!fetchedUser) throw new Error('Ø®ÙˆØ§Ù†Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ù…ÙˆÙÙ‚');
            
            // Update
            fetchedUser.level = 2;
            if(fetchedUser.level !== 2) throw new Error('Ø¢Ù¾Ø¯ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ù…ÙˆÙÙ‚');
            
            return `âœ… Ú©Ø§Ø±Ø¨Ø± "${user.name}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¯`;
        }
    },
    {
        id: 'test3',
        name: 'CRUD Ø¯Ø±Ø³â€ŒÙ‡Ø§',
        run: async () => {
            const lesson = DB.createLesson('Ù…Ú©Ø§Ù„Ù…Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ', 'english');
            if(!lesson.id) throw new Error('Ø¯Ø±Ø³ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯');
            
            const fetchedLesson = DB.getLesson(lesson.id);
            if(!fetchedLesson) throw new Error('Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø±Ø³ Ù†Ø§Ù…ÙˆÙÙ‚');
            
            if(fetchedLesson.price !== 50) throw new Error('Ù‚ÛŒÙ…Øª Ø¯Ø±Ø³ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
            
            return `âœ… Ø¯Ø±Ø³ "${lesson.title}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¯`;
        }
    },
    {
        id: 'test4',
        name: 'Migration v1 â†’ v2',
        run: async () => {
            // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„ Ø§Ø² migration
            const user = DB.createUser('migrate@test.com', 'Ú©Ø§Ø±Ø¨Ø± Migration');
            
            // Ø§Ø¬Ø±Ø§ÛŒ migration
            const result = DB.migrateToVersion(2);
            if(!result) throw new Error('Migration Ù†Ø§Ù…ÙˆÙÙ‚');
            if(DB.version !== 2) throw new Error('Ù†Ø³Ø®Ù‡ Ø¨Ø§ÛŒØ¯ Û² Ø¨Ø§Ø´Ø¯');
            
            // Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯
            const migratedUser = DB.getUser(user.id);
            if(migratedUser.level === undefined) throw new Error('ÙÛŒÙ„Ø¯ level Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯');
            
            return 'âœ… Migration Ø¨Ù‡ v2 Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯';
        }
    },
    {
        id: 'test5',
        name: 'Migration v2 â†’ v3',
        run: async () => {
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù†Ø³Ø®Ù‡ Û²
            DB.version = 2;
            
            // Ø§Ø¬Ø±Ø§ÛŒ migration
            const result = DB.migrateToVersion(3);
            if(!result) throw new Error('Migration Ù†Ø§Ù…ÙˆÙÙ‚');
            if(DB.version !== 3) throw new Error('Ù†Ø³Ø®Ù‡ Ø¨Ø§ÛŒØ¯ Û³ Ø¨Ø§Ø´Ø¯');
            
            // Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
            for(let user of DB.users.values()) {
                if(user.coins === undefined) throw new Error('ÙÛŒÙ„Ø¯ coins Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯');
            }
            for(let lesson of DB.lessons.values()) {
                if(lesson.price === undefined) throw new Error('ÙÛŒÙ„Ø¯ price Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯');
            }
            
            return 'âœ… Migration Ø¨Ù‡ v3 Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯';
        }
    }
];

// ========== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ==========
async function runAllTests() {
    const btn = document.getElementById('run-btn');
    btn.disabled = true;
    btn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...';
    
    let passed = 0;
    
    for(let i = 0; i < tests.length; i++) {
        const test = tests[i];
        const testEl = document.getElementById(test.id);
        const statusEl = document.getElementById(`status${i+1}`);
        const outputEl = document.getElementById(`output${i+1}`);
        
        // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§
        testEl.className = 'test-item running';
        statusEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
        statusEl.className = 'test-status status-running';
        outputEl.innerHTML = '<span style="color:#666">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</span>';
        
        try {
            const result = await test.run();
            
            // ØªØ³Øª Ù…ÙˆÙÙ‚
            testEl.className = 'test-item passed';
            statusEl.textContent = 'Ù…ÙˆÙÙ‚';
            statusEl.className = 'test-status status-passed';
            outputEl.innerHTML = `<div style="color:#2e7d32">${result}</div>`;
            passed++;
            
        } catch(error) {
            // ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚
            testEl.className = 'test-item failed';
            statusEl.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
            statusEl.className = 'test-status status-failed';
            outputEl.innerHTML = `<div style="color:#c62828">âŒ ${error.message}</div>`;
        }
        
        // ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    btn.disabled = false;
    btn.textContent = `ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ (${passed}/${tests.length} Ù…ÙˆÙÙ‚)`;
    
    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
    DB.log(`Ù†ØªØ§ÛŒØ¬ ØªØ³Øª: ${passed} Ø§Ø² ${tests.length} ØªØ³Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯`);
    if(passed === tests.length) {
        DB.log("ğŸ‰ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø´Øª Ø³Ø± Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯Ù†Ø¯!");
    }
}

// ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ==========
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('run-btn').addEventListener('click', runAllTests);
    DB.log("Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.");
});
</script>
</body>
  </html>
