<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª - Vakamova</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #db2777 0%, #7c3aed 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        .security-badge {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }
        .test-container {
            padding: 25px;
        }
        .test-section {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
        }
        .test-section h2 {
            color: #db2777;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #e2e8f0;
            transition: all 0.3s;
        }
        .test-item.passed {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .test-item.failed {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .test-item.security {
            border-left-color: #8b5cf6;
            background: #f5f3ff;
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-title {
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }
        .test-security {
            font-size: 0.8rem;
            background: #8b5cf6;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 10px;
        }
        .test-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .status-passed {
            background: #d1fae5;
            color: #065f46;
        }
        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }
        .test-output {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 25px;
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        #run-tests {
            background: linear-gradient(135deg, #db2777 0%, #7c3aed 100%);
            color: white;
        }
        #run-tests:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(219, 39, 119, 0.4);
        }
        #run-tests:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #clear-results, #export-results {
            background: #6b7280;
            color: white;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
            background: #f1f5f9;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .stat-box {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
        }
        .success { color: #10b981; }
        .failure { color: #ef4444; }
        .pending { color: #f59e0b; }
        .security-color { color: #8b5cf6; }
        
        .auth-simulator {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .auth-simulator h3 {
            color: #7c3aed;
            margin-bottom: 15px;
        }
        .sim-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-group label {
            font-weight: 500;
            color: #4b5563;
        }
        .form-group input {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }
        .sim-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .sim-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 0.9rem;
        }
        @media (max-width: 768px) {
            .test-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .controls {
                flex-direction: column;
            }
            button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ” ØªØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª - Vakamova</h1>
            <p>Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø§Ù…Ø¹ AuthenticationØŒ Session Management Ùˆ Security</p>
            <div class="security-badge">Ø§Ù…Ù†ÛŒØª Ø³Ø·Ø­ Ø¨Ø§Ù„Ø§</div>
        </header>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-value success" id="passed-count">0</div>
                <div class="stat-label">Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-box">
                <div class="stat-value failure" id="failed-count">0</div>
                <div class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-box">
                <div class="stat-value security-color" id="security-count">0</div>
                <div class="stat-label">ØªØ³Øª Ø§Ù…Ù†ÛŒØªÛŒ</div>
            </div>
            <div class="stat-box">
                <div class="stat-value pending" id="pending-count">0</div>
                <div class="stat-label">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
            </div>
        </div>
        
        <div class="auth-simulator">
            <h3>ğŸ® Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª</h3>
            <div class="sim-form">
                <div class="form-group">
                    <label>Ø§ÛŒÙ…ÛŒÙ„:</label>
                    <input type="email" id="sim-email" placeholder="user@vakamova.com" value="test@vakamova.com">
                </div>
                <div class="form-group">
                    <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
                    <input type="password" id="sim-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value="Test@1234">
                </div>
                <div class="sim-buttons">
                    <button onclick="simulateLogin()" style="background: #10b981;">ÙˆØ±ÙˆØ¯</button>
                    <button onclick="simulateRegister()" style="background: #3b82f6;">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
                    <button onclick="simulateLogout()" style="background: #6b7280;">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
            <div id="sim-result" style="margin-top: 15px; font-family: monospace;"></div>
        </div>
        
        <div class="test-container" id="test-container">
            <!-- ØªØ³Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        
        <div class="controls">
            <button id="run-tests">
                <span>ğŸš€</span>
                Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§
            </button>
            <button id="security-tests">
                <span>ğŸ›¡ï¸</span>
                ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
            </button>
            <button id="export-results">
                <span>ğŸ’¾</span>
                Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬
            </button>
            <button id="clear-results">
                <span>ğŸ”„</span>
                Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬
            </button>
        </div>
    </div>

    <script>
        // ============ Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª Ù„Ø§Ú¯ Ø§Ù…Ù† ============
        class SecurityLogger {
            constructor() {
                this.logs = [];
                this.sensitiveFields = ['password', 'token', 'secret', 'key'];
            }
            
            safeLog(message, data = null) {
                // Ø­Ø°Ù ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø­Ø³Ø§Ø³ Ù‚Ø¨Ù„ Ø§Ø² Ù„Ø§Ú¯
                let safeData = data;
                if (data && typeof data === 'object') {
                    safeData = { ...data };
                    this.sensitiveFields.forEach(field => {
                        if (safeData[field]) {
                            safeData[field] = '***REDACTED***';
                        }
                    });
                }
                
                const entry = {
                    time: new Date().toISOString(),
                    message,
                    data: safeData,
                    type: 'info',
                    security: false
                };
                
                this.logs.push(entry);
                console.log(`[Auth Test] ${message}`, safeData || '');
                return entry;
            }
            
            securityLog(message, data = null) {
                const entry = {
                    time: new Date().toISOString(),
                    message,
                    data: this.redactSensitive(data),
                    type: 'security',
                    security: true
                };
                
                this.logs.push(entry);
                console.log(`%c[Auth Security] ${message}`, 'color: #8b5cf6; font-weight: bold;', data || '');
                return entry;
            }
            
            error(message, error) {
                const entry = {
                    time: new Date().toISOString(),
                    message,
                    error: error?.message || error,
                    stack: error?.stack,
                    type: 'error',
                    security: false
                };
                
                this.logs.push(entry);
                console.error(`[Auth Test] ${message}:`, error);
                return entry;
            }
            
            redactSensitive(data) {
                if (!data || typeof data !== 'object') return data;
                
                const redacted = { ...data };
                this.sensitiveFields.forEach(field => {
                    if (redacted[field]) {
                        redacted[field] = '***SECURE***';
                    }
                });
                return redacted;
            }
            
            getStats() {
                const securityLogs = this.logs.filter(l => l.security);
                return {
                    total: this.logs.length,
                    security: securityLogs.length,
                    errors: this.logs.filter(l => l.type === 'error').length
                };
            }
        }

        // ============ Mock Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ============
        class MockAuthSystem {
            constructor() {
                this.users = new Map();
                this.sessions = new Map();
                this.tokens = new Map();
                this.failedAttempts = new Map();
                this.MAX_ATTEMPTS = 3;
                this.LOCKOUT_TIME = 5 * 60 * 1000; // 5 Ø¯Ù‚ÛŒÙ‚Ù‡
            }
            
            async register(email, password, userData = {}) {
                await this.simulateNetworkDelay();
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                if (!this.isValidEmail(email)) {
                    throw new Error('Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                }
                
                if (!this.isStrongPassword(password)) {
                    throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 8 Ú©Ø§Ø±Ø§Ú©ØªØ± Ùˆ Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯ Ùˆ Ú©ÙˆÚ†Ú© Ùˆ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯');
                }
                
                if (this.users.has(email)) {
                    throw new Error('Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª');
                }
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±
                const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const hashedPassword = this.hashPassword(password);
                
                this.users.set(email, {
                    id: userId,
                    email,
                    passwordHash: hashedPassword,
                    createdAt: new Date().toISOString(),
                    ...userData,
                    verified: false,
                    role: 'user'
                });
                
                return {
                    success: true,
                    userId,
                    message: 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯',
                    verificationRequired: true
                };
            }
            
            async login(email, password) {
                await this.simulateNetworkDelay();
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù‚ÙÙ„ Ø´Ø¯Ù† Ø­Ø³Ø§Ø¨
                if (this.isAccountLocked(email)) {
                    throw new Error('Ø­Ø³Ø§Ø¨ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ ÙˆØ±ÙˆØ¯Ù‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ Ù…ØªØ¹Ø¯Ø¯ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª');
                }
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                if (!this.users.has(email)) {
                    this.recordFailedAttempt(email);
                    throw new Error('Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª');
                }
                
                const user = this.users.get(email);
                const isValid = this.verifyPassword(password, user.passwordHash);
                
                if (!isValid) {
                    this.recordFailedAttempt(email);
                    throw new Error('Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª');
                }
                
                // Ø±ÛŒØ³Øª ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚
                this.failedAttempts.delete(email);
                
                // Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù†
                const token = this.generateToken(user.id);
                const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 12)}`;
                
                const session = {
                    sessionId,
                    userId: user.id,
                    token,
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // 24 Ø³Ø§Ø¹Øª
                    ip: '192.168.1.1', // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
                    userAgent: 'Mozilla/5.0 (Test)'
                };
                
                this.sessions.set(sessionId, session);
                this.tokens.set(token, sessionId);
                
                return {
                    success: true,
                    token,
                    sessionId,
                    user: {
                        id: user.id,
                        email: user.email,
                        role: user.role,
                        verified: user.verified
                    },
                    expiresAt: session.expiresAt
                };
            }
            
            async logout(token) {
                await this.simulateNetworkDelay();
                
                const sessionId = this.tokens.get(token);
                if (!sessionId) {
                    throw new Error('ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                }
                
                this.sessions.delete(sessionId);
                this.tokens.delete(token);
                
                return {
                    success: true,
                    message: 'Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯'
                };
            }
            
            async verifyToken(token) {
                await this.simulateNetworkDelay();
                
                const sessionId = this.tokens.get(token);
                if (!sessionId) {
                    return { valid: false, reason: 'ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                }
                
                const session = this.sessions.get(sessionId);
                if (!session) {
                    return { valid: false, reason: 'Ø³Ø´Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯' };
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§
                if (new Date(session.expiresAt) < new Date()) {
                    this.sessions.delete(sessionId);
                    this.tokens.delete(token);
                    return { valid: false, reason: 'ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡' };
                }
                
                // ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ú¯Ø± Ù†Ø²Ø¯ÛŒÚ© Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ø§Ø´Ø¯
                const shouldRefresh = new Date(session.expiresAt) - Date.now() < 60 * 60 * 1000; // Ú©Ù…ØªØ± Ø§Ø² 1 Ø³Ø§Ø¹Øª
                if (shouldRefresh) {
                    session.expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();
                }
                
                return {
                    valid: true,
                    session,
                    user: this.getUserById(session.userId),
                    refreshed: shouldRefresh
                };
            }
            
            async changePassword(email, oldPassword, newPassword) {
                await this.simulateNetworkDelay();
                
                if (!this.users.has(email)) {
                    throw new Error('Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }
                
                const user = this.users.get(email);
                const isValid = this.verifyPassword(oldPassword, user.passwordHash);
                
                if (!isValid) {
                    throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÙØ¹Ù„ÛŒ Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª');
                }
                
                if (!this.isStrongPassword(newPassword)) {
                    throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 8 Ú©Ø§Ø±Ø§Ú©ØªØ± Ùˆ Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯ Ùˆ Ú©ÙˆÚ†Ú© Ùˆ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯');
                }
                
                user.passwordHash = this.hashPassword(newPassword);
                user.passwordChangedAt = new Date().toISOString();
                
                // Ø¨Ø§Ø·Ù„ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø³Ø´Ù†â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
                for (const [sessionId, session] of this.sessions.entries()) {
                    if (session.userId === user.id) {
                        this.tokens.delete(session.token);
                        this.sessions.delete(sessionId);
                    }
                }
                
                return {
                    success: true,
                    message: 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯'
                };
            }
            
            // ============ Ù…ØªØ¯Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ============
            
            isValidEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }
            
            isStrongPassword(password) {
                return password.length >= 8 &&
                       /[A-Z]/.test(password) &&
                       /[a-z]/.test(password) &&
                       /[0-9]/.test(password);
            }
            
            hashPassword(password) {
                // Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§Ø² bcrypt ÛŒØ§ similar Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                return `hashed_${btoa(password)}_${Date.now()}`;
            }
            
            verifyPassword(password, hash) {
                const testHash = `hashed_${btoa(password)}`;
                return hash.startsWith(testHash);
            }
            
            generateToken(userId) {
                return `token_${userId}_${Date.now()}_${Math.random().toString(36).substr(2, 16)}`;
            }
            
            getUserById(userId) {
                for (const user of this.users.values()) {
                    if (user.id === userId) {
                        const { passwordHash, ...safeUser } = user;
                        return safeUser;
                    }
                }
                return null;
            }
            
            recordFailedAttempt(email) {
                const attempts = this.failedAttempts.get(email) || { count: 0, firstAttempt: Date.now() };
                attempts.count++;
                
                if (attempts.count >= this.MAX_ATTEMPTS) {
                    attempts.lockedUntil = Date.now() + this.LOCKOUT_TIME;
                }
                
                this.failedAttempts.set(email, attempts);
            }
            
            isAccountLocked(email) {
                const attempts = this.failedAttempts.get(email);
                if (!attempts || !attempts.lockedUntil) return false;
                
                if (Date.now() < attempts.lockedUntil) {
                    return true;
                } else {
                    // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù‚ÙÙ„ Ù¾Ø³ Ø§Ø² Ú¯Ø°Ø´Øª Ø²Ù…Ø§Ù†
                    this.failedAttempts.delete(email);
                    return false;
                }
            }
            
            simulateNetworkDelay() {
                return new Promise(resolve => 
                    setTimeout(resolve, Math.random() * 100 + 50)
                );
            }
        }

        // ============ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ============
        const AUTH_TEST_SUITES = [
            {
                id: 'auth-core',
                name: 'Ù‡Ø³ØªÙ‡ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª',
                icon: 'ğŸ”',
                tests: [
                    {
                        id: 'auth-register',
                        name: 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø¹ØªØ¨Ø±',
                        security: false,
                        run: async () => {
                            const auth = new MockAuthSystem();
                            const result = await auth.register(
                                'test.user@vakamova.com',
                                'StrongPass123',
                                { name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª' }
                            );
                            
                            if (!result.success) throw new Error('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø§Ù…ÙˆÙÙ‚');
                            if (!result.userId) throw new Error('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯');
                            
                            return `âœ… Ú©Ø§Ø±Ø¨Ø± ${result.userId} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯`;
                        }
                    },
                    {
                        id: 'auth-login',
                        name: 'ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ø¢ÛŒÙ†Ø¯ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø§Ø¹ØªØ¨Ø§Ø± Ù…Ø¹ØªØ¨Ø±',
                        security: false,
                        run: async () => {
                            const auth = new MockAuthSystem();
                            
                            // Ø§ÙˆÙ„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
                            await auth.register('login.test@vakamova.com', 'TestPass123');
                            
                            // Ø³Ù¾Ø³ ÙˆØ±ÙˆØ¯
                            const result = await auth.login('login.test@vakamova.com', 'TestPass123');
                            
                            if (!result.success) throw new Error('ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚');
                            if (!result.token) throw new Error('ØªÙˆÚ©Ù† Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯');
                            if (!result.user) throw new Error('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ù†Ø´Ø¯');
                            
                            return `âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚. ØªÙˆÚ©Ù†: ${result.token.substring(0, 20)}...`;
                        }
                    },
                    {
                        id: 'auth-logout',
                        name: 'Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø·Ù„ Ø´Ø¯Ù† Ø³Ø´Ù† Ù¾Ø³ Ø§Ø² Ø®Ø±ÙˆØ¬',
                        security: true,
                        run: async () => {
                            const auth = new MockAuthSystem();
                            
                            // Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯
                            await auth.register('logout.test@vakamova.com', 'TestPass123');
                            const loginResult = await auth.login('logout.test@vakamova.com', 'TestPass123');
                            
                            // Ø®Ø±ÙˆØ¬
                            const logoutResult = await auth.logout(loginResult.token);
                            
                            if (!logoutResult.success) throw new Error('Ø®Ø±ÙˆØ¬ Ù†Ø§Ù…ÙˆÙÙ‚');
                            
                            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ ØªÙˆÚ©Ù† Ø¯ÛŒÚ¯Ø± Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª
                            const verifyResult = await auth.verifyToken(loginResult.token);
                            if (verifyResult.valid) throw new Error('ØªÙˆÚ©Ù† Ù¾Ø³ Ø§Ø² Ø®Ø±ÙˆØ¬ Ù‡Ù†ÙˆØ² Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                            
                            return 'âœ… Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚ Ùˆ ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø·Ù„ Ø´Ø¯';
                        }
                    }
                ]
            },
            {
                id: 'auth-security',
                name: 'ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ',
                icon: 'ğŸ›¡ï¸',
                tests: [
                    {
                        id: 'auth-bruteforce',
                        name: 'Ù…Ø­Ø§ÙØ¸Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø­Ù…Ù„Ù‡ Brute Force',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ù‚ÙÙ„ Ø´Ø¯Ù† Ø­Ø³Ø§Ø¨ Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯Ù‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ Ù…ØªØ¹Ø¯Ø¯',
                        security: true,
                        run: async () => {
                            const auth = new MockAuthSystem();
                            const email = 'bruteforce.test@vakamova.com';
                            
                            // Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±
                            await auth.register(email, 'CorrectPass123');
                            
                            // ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ Ù…ØªØ¹Ø¯Ø¯
                            const errors = [];
                            for (let i = 0; i < 5; i++) {
                                try {
                                    await auth.login(email, 'WrongPassword');
                                } catch (error) {
                                    errors.push(error.message);
                                }
                            }
                            
                            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø±Ù…Ø² Ø¯Ø±Ø³Øª (Ø¨Ø§ÛŒØ¯ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
                            try {
                                await auth.login(email, 'CorrectPass123');
                                throw new Error('Ø­Ø³Ø§Ø¨ Ù¾Ø³ Ø§Ø² Ûµ ØªÙ„Ø§Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ù‚ÙÙ„ Ù†Ø´Ø¯');
                            } catch (error) {
                                if (!error.message.includes('Ù‚ÙÙ„ Ø´Ø¯Ù‡')) {
                                    throw new Error('Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯');
                                }
                            }
                            
                            return 'âœ… Ø³ÛŒØ³ØªÙ… Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø­Ù…Ù„Ù‡ Brute Force Ù…Ø­Ø§ÙØ¸Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯';
                        }
                    },
                    {
                        id: 'auth-password-strength',
                        name: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù‚Ø¯Ø±Øª Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø±Ø¯ Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ø¶Ø¹ÛŒÙ',
                        security: true,
                        run: async () => {
                            const auth = new MockAuthSystem();
                            const weakPasswords = [
                                '123',           // Ú©ÙˆØªØ§Ù‡
                                'password',      // ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ú©ÙˆÚ†Ú©
                                'PASSWORD',      // ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯
                                '12345678',      // ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯
                                'weakpass'       // Ø¨Ø¯ÙˆÙ† Ø¹Ø¯Ø¯
                            ];
                            
                            for (const weakPass of weakPasswords) {
                                try {
                                    await auth.register('test@example.com', weakPass);
                                    throw new Error(`Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¶Ø¹ÛŒÙ "${weakPass}" Ø¨Ø§ÛŒØ¯ Ø±Ø¯ Ù…ÛŒâ€ŒØ´Ø¯`);
                                } catch (error) {
                                    if (!error.message.includes('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯')) {
                                        throw new Error(`Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ "${weakPass}": ${error.message}`);
                                    }
                                }
                            }
                            
                            // ØªØ³Øª Ø±Ù…Ø² Ù‚ÙˆÛŒ
                            const strongResult = await auth.register(
                                'strong.pass@vakamova.com',
                                'StrongPass123'
                            );
                            
                            if (!strongResult.success) throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù‚ÙˆÛŒ Ø±Ø¯ Ø´Ø¯');
                            
                            return 'âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù‚Ø¯Ø±Øª Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯';
                        }
                    },
                    {
                        id: 'auth-token-expiry',
                        name: 'Ø§Ù†Ù‚Ø¶Ø§ÛŒ ØªÙˆÚ©Ù†',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø·Ù„ Ø´Ø¯Ù† ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡',
                        security: true,
                        run: async () => {
                            const auth = new MockAuthSystem();
                            
                            // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø³Ø´Ù† Ø¨Ø§ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡
                            const user = await auth.register('expiry.test@vakamova.com', 'TestPass123');
                            const loginResult = await auth.login('expiry.test@vakamova.com', 'TestPass123');
                            
                            // Ø¯Ø³ØªÚ©Ø§Ø±ÛŒ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ Ø¯Ø± Mock (Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª ØªÙˆØ³Ø· Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯)
                            const sessionId = auth.tokens.get(loginResult.token);
                            const session = auth.sessions.get(sessionId);
                            session.expiresAt = new Date(Date.now() - 1000).toISOString(); // Ø²Ù…Ø§Ù† Ú¯Ø°Ø´ØªÙ‡
                            
                            // Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÚ©Ù†
                            const verifyResult = await auth.verifyToken(loginResult.token);
                            
                            if (verifyResult.valid) {
                                throw new Error('ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ù‡Ù†ÙˆØ² Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                            }
                            
                            if (!verifyResult.reason.includes('Ù…Ù†Ù‚Ø¶ÛŒ')) {
                                throw new Error('Ø¯Ù„ÛŒÙ„ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø±Ø§Ø¦Ù‡ Ù†Ø´Ø¯');
                            }
                            
                            return 'âœ… ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø¨Ø§Ø·Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯';
                        }
                    }
                ]
            },
            {
                id: 'auth-validation',
                name: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙˆØ±ÙˆØ¯ÛŒ',
                icon: 'âœ…',
                tests: [
                    {
                        id: 'auth-email-validation',
                        name: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§ÛŒÙ…ÛŒÙ„',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø±Ø¯ Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±',
                        security: false,
                        run: async () => {
                            const auth = new MockAuthSystem();
                            const invalidEmails = [
                                'invalid',
                                'invalid@',
                                '@invalid.com',
                                'invalid@.com',
                                'invalid@com.'
                            ];
                            
                            for (const email of invalidEmails) {
                                try {
                                    await auth.register(email, 'ValidPass123');
                                    throw new Error(`Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± "${email}" Ø¨Ø§ÛŒØ¯ Ø±Ø¯ Ù…ÛŒâ€ŒØ´Ø¯`);
                                } catch (error) {
                                    if (!error.message.includes('Ø§ÛŒÙ…ÛŒÙ„')) {
                                        throw new Error(`Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ "${email}": ${error.message}`);
                                    }
                                }
                            }
                            
                            return 'âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯';
                        }
                    },
                    {
                        id: 'auth-duplicate-email',
                        name: 'Ø§ÛŒÙ…ÛŒÙ„ ØªÚ©Ø±Ø§Ø±ÛŒ',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¯Ù… Ù¾Ø°ÛŒØ±Ø´ Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ',
                        security: false,
                        run: async () => {
                            const auth = new MockAuthSystem();
                            const email = 'duplicate@vakamova.com';
                            
                            // Ø§ÙˆÙ„ÛŒÙ† Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
                            await auth.register(email, 'FirstPass123');
                            
                            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…Ø¬Ø¯Ø¯
                            try {
                                await auth.register(email, 'SecondPass123');
                                throw new Error('Ø§ÛŒÙ…ÛŒÙ„ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨Ø§ÛŒØ¯ Ø±Ø¯ Ù…ÛŒâ€ŒØ´Ø¯');
                            } catch (error) {
                                if (!error.message.includes('Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…')) {
                                    throw new Error(`Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ù†Ø§Ø³Ø¨: ${error.message}`);
                                }
                            }
                            
                            return 'âœ… Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯';
                        }
                    }
                ]
            },
            {
                id: 'auth-advanced',
                name: 'ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡',
                icon: 'ğŸš€',
                tests: [
                    {
                        id: 'auth-token-refresh',
                        name: 'ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙˆÚ©Ù†',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªÙˆÚ©Ù† Ù†Ø²Ø¯ÛŒÚ© Ø§Ù†Ù‚Ø¶Ø§',
                        security: true,
                        run: async () => {
                            const auth = new MockAuthSystem();
                            
                            const email = 'refresh.test@vakamova.com';
                            await auth.register(email, 'TestPass123');
                            const loginResult = await auth.login(email, 'TestPass123');
                            
                            // Ø¯Ø³ØªÚ©Ø§Ø±ÛŒ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ù‡ Ù†Ø²Ø¯ÛŒÚ© Ø§Ù†Ù‚Ø¶Ø§
                            const sessionId = auth.tokens.get(loginResult.token);
                            const session = auth.sessions.get(sessionId);
                            const nearExpiry = new Date(Date.now() + 30 * 60 * 1000); // 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø±
                            session.expiresAt = nearExpiry.toISOString();
                            
                            // Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÚ©Ù† (Ø¨Ø§ÛŒØ¯ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´ÙˆØ¯)
                            const verifyResult = await auth.verifyToken(loginResult.token);
                            
                            if (!verifyResult.valid) throw new Error('ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯');
                            if (!verifyResult.refreshed) throw new Error('ØªÙˆÚ©Ù† Ù†Ø²Ø¯ÛŒÚ© Ø§Ù†Ù‚Ø¶Ø§ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø´Ø¯');
                            
                            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯Ù‡
                            const newExpiry = new Date(session.expiresAt);
                            const timeDiff = newExpiry - nearExpiry;
                            
                            if (timeDiff < 23 * 60 * 60 * 1000) { // Ø¨Ø§ÛŒØ¯ Ø­Ø¯ÙˆØ¯ 24 Ø³Ø§Ø¹Øª ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                                throw new Error('Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ØªÙ…Ø¯ÛŒØ¯ Ù†Ø´Ø¯');
                            }
                            
                            return 'âœ… ØªÙˆÚ©Ù† Ù†Ø²Ø¯ÛŒÚ© Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯';
                        }
                    },
                    {
                        id: 'auth-password-change',
                        name: 'ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
                        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…Ù†ÛŒØª ÙØ±Ø¢ÛŒÙ†Ø¯ ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
                        security: true,
                        run: async () => {
                            const auth = new MockAuthSystem();
                            
                            const email = 'changepass.test@vakamova.com';
                            await auth.register(email, 'OldPass123');
                            await auth.login(email, 'OldPass123');
                            
                            // ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
                            const changeResult = await auth.changePassword(
                                email,
                                'OldPass123',
                                'NewStrongPass456'
                            );
                            
                            if (!changeResult.success) throw new Error('ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ù…ÙˆÙÙ‚');
                            
                            // ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯
                            const loginResult = await auth.login(email, 'NewStrongPass456');
                            if (!loginResult.success) throw new Error('ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ù†Ø§Ù…ÙˆÙÙ‚');
                            
                            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø±Ù…Ø² Ù‚Ø¯ÛŒÙ…ÛŒ
                            try {
                                await auth.login(email, 'OldPass123');
                                throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ø§ÛŒØ¯ Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ø±Ø¯');
                            } catch (error) {
                                // Ù…ÙˆÙÙ‚ÛŒØª: Ø±Ù…Ø² Ù‚Ø¯ÛŒÙ…ÛŒ Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                            }
                            
                            return 'âœ… ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ø§Ù…Ù†ÛŒØª Ú©Ø§Ù…Ù„ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯';
                        }
                    }
                ]
            }
        ];

        // ============ Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ØªØ³Øªâ€ŒÙ‡Ø§ ============
        class AuthTestManager {
            constructor() {
                this.logger = new SecurityLogger();
                this.authSystem = new MockAuthSystem();
                this.results = new Map();
                this.totalTests = 0;
                this.completedTests = 0;
                this.securityTests = 0;
                
                this.calculateStats();
                this.renderTests();
                this.setupEventListeners();
                this.updateDisplay();
            }
            
            calculateStats() {
                this.totalTests = AUTH_TEST_SUITES.reduce(
                    (sum, suite) => sum + suite.tests.length, 0
                );
                this.securityTests = AUTH_TEST_SUITES.reduce(
                    (sum, suite) => sum + suite.tests.filter(t => t.security).length, 0
                );
            }
            
            renderTests() {
                const container = document.getElementById('test-container');
                container.innerHTML = '';
                
                AUTH_TEST_SUITES.forEach(suite => {
                    const section = document.createElement('div');
                    section.className = 'test-section';
                    section.innerHTML = `
                        <h2><span>${suite.icon}</span> ${suite.name}</h2>
                        <div id="suite-${suite.id}">
                            ${suite.tests.map(test => `
                                <div class="test-item ${test.security ? 'security' : ''}" id="test-${test.id}">
                                    <div class="test-header">
                                        <div class="test-title">
                                            ${test.name}
                                            ${test.security ? '<span class="test-security">Ø§Ù…Ù†ÛŒØªÛŒ</span>' : ''}
                                        </div>
                                        <div class="test-status status-pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 8px;">
                                        ${test.description}
                                    </div>
                                    <div class="test-output" id="output-${test.id}" style="display: none;"></div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                });
            }
            
            setupEventListeners() {
                document.getElementById('run-tests').addEventListener('click', () => {
                    this.runAllTests();
                });
                
                document.getElementById('security-tests').addEventListener('click', () => {
                    this.runSecurityTests();
                });
                
                document.getElementById('clear-results').addEventListener('click', () => {
                    if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                        this.clearResults();
                    }
                });
                
                document.getElementById('export-results').addEventListener('click', () => {
                    this.exportResults();
                });
            }
            
            async runAllTests() {
                const runButton = document.getElementById('run-tests');
                runButton.disabled = true;
                runButton.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
                
                this.logger.securityLog('Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª');
                
                for (const suite of AUTH_TEST_SUITES) {
                    this.logger.safeLog(`Ø´Ø±ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ${suite.name}`);
                    for (const test of suite.tests) {
                        await this.runSingleTest(test);
                    }
                }
                
                runButton.disabled = false;
                runButton.innerHTML = '<span>ğŸš€</span> Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§';
                
                this.showSummary();
            }
            
            async runSecurityTests() {
                const securityButton = document.getElementById('security-tests');
                securityButton.disabled = true;
                securityButton.innerHTML = '<span class="loading"></span> ØªØ³Øª Ø§Ù…Ù†ÛŒØªÛŒ...';
                
                this.logger.securityLog('Ø´Ø±ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ ÙˆÛŒÚ˜Ù‡');
                
                for (const suite of AUTH_TEST_SUITES) {
                    for (const test of suite.tests.filter(t => t.security)) {
                        await this.runSingleTest(test);
                    }
                }
                
                securityButton.disabled = false;
                securityButton.innerHTML = '<span>ğŸ›¡ï¸</span> ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ';
            }
            
            async runSingleTest(test) {
                const testElement = document.getElementById(`test-${test.id}`);
                const statusElement = testElement.querySelector('.test-status');
                const outputElement = document.getElementById(`output-${test.id}`);
                
                // Ø±ÛŒØ³Øª ÙˆØ¶Ø¹ÛŒØª
                testElement.className = `test-item ${test.security ? 'security' : ''}`;
                statusElement.className = 'test-status status-pending';
                statusElement.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
                outputElement.style.display = 'none';
                
                try {
                    const startTime = performance.now();
                    const result = await test.run();
                    const duration = performance.now() - startTime;
                    
                    // Ù…ÙˆÙÙ‚
                    testElement.classList.add('passed');
                    statusElement.className = 'test-status status-passed';
                    statusElement.textContent = `Ù…ÙˆÙÙ‚ (${duration.toFixed(0)}ms)`;
                    outputElement.textContent = result;
                    outputElement.style.display = 'block';
                    
                    this.results.set(test.id, { 
                        success: true, 
                        result,
                        duration,
                        security: test.security 
                    });
                    
                    if (test.security) {
                        this.logger.securityLog(`ØªØ³Øª Ø§Ù…Ù†ÛŒØªÛŒ "${test.name}" Ù…ÙˆÙÙ‚`, { duration: `${duration.toFixed(0)}ms` });
                    } else {
                        this.logger.safeLog(`ØªØ³Øª "${test.name}" Ù…ÙˆÙÙ‚`, { duration: `${duration.toFixed(0)}ms` });
                    }
                    
                } catch (error) {
                    // Ø´Ú©Ø³Øª
                    testElement.classList.add('failed');
                    statusElement.className = 'test-status status-failed';
                    statusElement.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
                    outputElement.textContent = `Ø®Ø·Ø§: ${error.message}\n${error.stack || ''}`;
                    outputElement.style.display = 'block';
                    
                    this.results.set(test.id, { 
                        success: false, 
                        error: error.message,
                        security: test.security 
                    });
                    
                    if (test.security) {
                        this.logger.securityLog(`ØªØ³Øª Ø§Ù…Ù†ÛŒØªÛŒ "${test.name}" Ù†Ø§Ù…ÙˆÙÙ‚`, error);
                    } else {
                        this.logger.error(`ØªØ³Øª "${test.name}" Ù†Ø§Ù…ÙˆÙÙ‚`, error);
                    }
                }
                
                this.completedTests++;
                this.updateDisplay();
            }
            
            updateDisplay() {
                const passed = Array.from(this.results.values()).filter(r => r.success).length;
                const failed = Array.from(this.results.values()).filter(r => !r.success).length;
                const securityPassed = Array.from(this.results.values())
                    .filter(r => r.security && r.success).length;
                const pending = this.totalTests - this.completedTests;
                
                document.getElementById('passed-count').textContent = passed;
                document.getElementById('failed-count').textContent = failed;
                document.getElementById('security-count').textContent = securityPassed;
                document.getElementById('pending-count').textContent = pending;
            }
            
            clearResults() {
                this.results.clear();
                this.completedTests = 0;
                this.renderTests();
                this.updateDisplay();
                this.logger.securityLog('Ù†ØªØ§ÛŒØ¬ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªÛŒØ¬Ù‡ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²
                document.getElementById('sim-result').textContent = '';
            }
            
            exportResults() {
                const results = {
                    timestamp: new Date().toISOString(),
                    system: 'Authentication System',
                    totalTests: this.totalTests,
                    completedTests: this.completedTests,
                    securityTests: this.securityTests,
                    results: Object.fromEntries(this.results),
                    logs: this.logger.logs,
                    stats: this.logger.getStats()
                };
                
                const dataStr = JSON.stringify(results, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `vakamova-auth-test-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                this.logger.securityLog('Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
            }
            
            showSummary() {
                const passed = Array.from(this.results.values()).filter(r => r.success).length;
                const failed = this.completedTests - passed;
                const securityPassed = Array.from(this.results.values())
                    .filter(r => r.security && r.success).length;
                const successRate = ((passed / this.totalTests) * 100).toFixed(1);
                
                const summary = `
ğŸ¯ Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬ ØªØ³Øª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª:
âœ… Ù…ÙˆÙÙ‚: ${passed} Ø§Ø² ${this.totalTests}
âŒ Ù†Ø§Ù…ÙˆÙÙ‚: ${failed}
ğŸ›¡ï¸ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ: ${securityPassed} Ø§Ø² ${this.securityTests}
ğŸ“Š Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª: ${successRate}%
â±ï¸ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: ${this.completedTests}
                `.trim();
                
                this.logger.securityLog(summary);
                
                // Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ù„Ø§Ù†
                if (failed === 0 && securityPassed === this.securityTests) {
                    alert(`ğŸ‰ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ø§Ù…Ù„!\n${summary}`);
                } else if (failed > 0) {
                    alert(`âš ï¸ ${failed} ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¯Ø§Ø´ØªÛŒÙ….\n${summary}`);
                }
            }
            
            // Ù…ØªØ¯Ù‡Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²
            async simulateLogin() {
                const email = document.getElementById('sim-email').value;
                const password = document.getElementById('sim-password').value;
                const resultEl = document.getElementById('sim-result');
                
                try {
                    resultEl.innerHTML = '<span style="color: #f59e0b;">â³ Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...</span>';
                    
                    const result = await this.authSystem.login(email, password);
                    
                    resultEl.innerHTML = `
                        <span style="color: #10b981;">âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚</span><br>
                        <small>Ú©Ø§Ø±Ø¨Ø±: ${result.user.email}</small><br>
                        <small>ØªÙˆÚ©Ù†: ${result.token.substring(0, 30)}...</small><br>
                        <small>Ø§Ù†Ù‚Ø¶Ø§: ${new Date(result.expiresAt).toLocaleString('fa-IR')}</small>
                    `;
                    
                    this.logger.safeLog('ÙˆØ±ÙˆØ¯ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ù…ÙˆÙÙ‚', { email });
                    
                } catch (error) {
                    resultEl.innerHTML = `<span style="color: #ef4444;">âŒ Ø®Ø·Ø§: ${error.message}</span>`;
                    this.logger.error('ÙˆØ±ÙˆØ¯ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚', error);
                }
            }
            
            async simulateRegister() {
                const email = document.getElementById('sim-email').value;
                const password = document.getElementById('sim-password').value;
                const resultEl = document.getElementById('sim-result');
                
                try {
                    resultEl.innerHTML = '<span style="color: #f59e0b;">â³ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...</span>';
                    
                    const result = await this.authSystem.register(
                        email, 
                        password, 
                        { name: 'Ú©Ø§Ø±Ø¨Ø± Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²' }
                    );
                    
                    resultEl.innerHTML = `
                        <span style="color: #10b981;">âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚</span><br>
                        <small>Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: ${result.userId}</small><br>
                        <small>${result.message}</small>
                    `;
                    
                    this.logger.safeLog('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ù…ÙˆÙÙ‚', { email });
                    
                } catch (error) {
                    resultEl.innerHTML = `<span style="color: #ef4444;">âŒ Ø®Ø·Ø§: ${error.message}</span>`;
                    this.logger.error('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚', error);
                }
            }
            
            async simulateLogout() {
                const resultEl = document.getElementById('sim-result');
                
                // Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø¨Ø§ÛŒØ¯ ØªÙˆÚ©Ù† ÙØ¹Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                // Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒØŒ ÛŒÚ© Ù¾ÛŒØ§Ù… Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
                resultEl.innerHTML = `
                    <span style="color: #3b82f6;">â„¹ï¸ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ú©Ø§Ù…Ù„ Ø®Ø±ÙˆØ¬ØŒ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</span><br>
                    <small>Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‚Ø¹ÛŒØŒ ØªÙˆÚ©Ù† Ø¬Ù„Ø³Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯</small>
                `;
                
                this.logger.safeLog('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø±ÙˆØ¬ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡');
            }
        }

        // ============ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ùˆ ØªÙˆØ§Ø¨Ø¹ Ø¹Ù…ÙˆÙ…ÛŒ ============
        let authTestManager;

        document.addEventListener('DOMContentLoaded', () => {
            authTestManager = new AuthTestManager();
            console.log('âœ… Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Vakamova Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª');
        });

        // ØªÙˆØ§Ø¨Ø¹ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ HTML
        window.simulateLogin = () => authTestManager.simulateLogin();
        window.simulateRegister = () => authTestManager.simulateRegister();
        window.simulateLogout = () => authTestManager.simulateLogout();
    </script>
</body>
  </html>
