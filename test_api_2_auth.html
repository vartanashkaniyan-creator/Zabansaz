<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª API - Ø¨Ø®Ø´ 2: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª</title>
    <style>
        body { font-family: Tahoma; padding: 20px; background: #f8f9fa; }
        .test { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 10px; 
            border-left: 5px solid #007bff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .test.error-test { border-left-color: #dc3545; }
        .test.auth-test { border-left-color: #28a745; }
        h1 { color: #2c3e50; text-align: center; }
        h3 { color: #34495e; margin-top: 0; }
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold;
            margin: 5px;
        }
        button:hover { background: #2980b9; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        .success { 
            color: #27ae60; 
            margin-top: 15px; 
            padding: 12px; 
            background: #d5f4e6; 
            border-radius: 5px; 
            border: 1px solid #2ecc71;
        }
        .error { 
            color: #c0392b; 
            margin-top: 15px; 
            padding: 12px; 
            background: #fadbd8; 
            border-radius: 5px; 
            border: 1px solid #e74c3c;
        }
        .loading { 
            display: inline-block; 
            width: 18px; 
            height: 18px; 
            border: 3px solid #ecf0f1; 
            border-top-color: #3498db; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .stats {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
            font-size: 18px;
        }
        .code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            font-size: 13px;
            direction: ltr;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ØªØ³Øª API - Ø¨Ø®Ø´ 2: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§</h1>
    
    <div class="test auth-test">
        <h3>ØªØ³Øª 1: ØªÙ†Ø¸ÛŒÙ… Ùˆ Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù†</h3>
        <div class="code">client.setToken('token_123') â†’ client.getToken()</div>
        <button onclick="runTest1()">Ø§Ø¬Ø±Ø§</button>
        <div id="result1"></div>
    </div>
    
    <div class="test auth-test">
        <h3>ØªØ³Øª 2: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø±</h3>
        <div class="code">GET /profile Ø¨Ø§ Authorization header</div>
        <button onclick="runTest2()">Ø§Ø¬Ø±Ø§</button>
        <div id="result2"></div>
    </div>
    
    <div class="test error-test">
        <h3>ØªØ³Øª 3: Ø®Ø·Ø§ÛŒ ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±</h3>
        <div class="code">ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ â†’ Ø®Ø·Ø§ÛŒ 401</div>
        <button onclick="runTest3()">Ø§Ø¬Ø±Ø§</button>
        <div id="result3"></div>
    </div>
    
    <div class="test error-test">
        <h3>ØªØ³Øª 4: Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ (Timeout)</h3>
        <div class="code">Ø¯Ø±Ø®ÙˆØ§Ø³Øª 3 Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ â†’ Timeout Ø¨Ø¹Ø¯ Ø§Ø² 1 Ø«Ø§Ù†ÛŒÙ‡</div>
        <button onclick="runTest4()">Ø§Ø¬Ø±Ø§</button>
        <div id="result4"></div>
    </div>
    
    <div style="text-align: center; margin: 30px 0;">
        <button onclick="runAllTests()" style="padding: 15px 30px; background: #9b59b6; font-size: 16px;">
            ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ 4 ØªØ³Øª
        </button>
        <button onclick="resetAll()" style="padding: 15px 30px; background: #7f8c8d; font-size: 16px;">
            ğŸ”„ Ø±ÛŒØ³Øª Ù‡Ù…Ù‡
        </button>
    </div>
    
    <div class="stats">
        <div>ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚: <span id="passed">0</span> | ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚: <span id="failed">0</span> | Ú©Ù„: 4</div>
    </div>

    <script>
        // ========== Auth Api Client Ù¾ÛŒØ´Ø±ÙØªÙ‡ ==========
        class AuthApiClient {
            constructor() {
                this.baseURL = 'https://api.vakamova.test';
                this.token = null;
                this.requestCount = 0;
            }
            
            setToken(token) {
                this.token = token;
                console.log('ØªÙˆÚ©Ù† ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯:', token.substring(0, 15) + '...');
                return true;
            }
            
            getToken() {
                return this.token;
            }
            
            async request(method, endpoint, data = null, timeout = 5000) {
                this.requestCount++;
                const requestId = this.requestCount;
                console.log(`Ø¯Ø±Ø®ÙˆØ§Ø³Øª #${requestId}: ${method} ${endpoint}`);
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ timeout
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error(`Timeout Ø¨Ø¹Ø¯ Ø§Ø² ${timeout}ms`)), timeout);
                });
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
                const requestPromise = new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // Ø®Ø·Ø§ÛŒ ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±
                        if (endpoint === '/profile' && this.token === 'expired_token') {
                            reject({ 
                                success: false, 
                                error: 'ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±', 
                                status: 401 
                            });
                            return;
                        }
                        
                        // Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡
                        if (endpoint === '/slow-endpoint') {
                            // Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡ÛŒÚ†ÙˆÙ‚Øª Ù¾Ø§Ø³Ø® Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ (Ø¨Ø±Ø§ÛŒ ØªØ³Øª timeout)
                            return;
                        }
                        
                        // Ù¾Ø§Ø³Ø® Ù…ÙˆÙÙ‚
                        resolve({
                            success: true,
                            data: {
                                user: { id: 1, name: 'Ú©Ø§Ø±Ø¨Ø± Ø§Ø­Ø±Ø§Ø² Ø´Ø¯Ù‡' },
                                endpoint: endpoint,
                                method: method,
                                hasToken: !!this.token
                            },
                            status: 200,
                            requestId: requestId
                        });
                    }, 300);
                });
                
                try {
                    const result = await Promise.race([requestPromise, timeoutPromise]);
                    console.log(`Ù¾Ø§Ø³Ø® #${requestId}: Ù…ÙˆÙÙ‚`);
                    return result;
                } catch (error) {
                    console.error(`Ù¾Ø§Ø³Ø® #${requestId}: Ø®Ø·Ø§ -`, error.message);
                    throw error;
                }
            }
            
            async getProfile() {
                if (!this.token) {
                    throw new Error('ØªÙˆÚ©Ù† ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                }
                return this.request('GET', '/profile');
            }
            
            async getSlowEndpoint() {
                return this.request('GET', '/slow-endpoint', null, 1000); // timeout Ú©ÙˆØªØ§Ù‡
            }
        }

        // ========== Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ØªØ³Øª ==========
        let passedTests = 0;
        let failedTests = 0;
        const client = new AuthApiClient();

        // ========== ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ==========
        function updateStats() {
            document.getElementById('passed').textContent = passedTests;
            document.getElementById('failed').textContent = failedTests;
        }
        
        function setLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
            } else {
                button.disabled = false;
                button.textContent = 'Ø§Ø¬Ø±Ø§';
            }
        }
        
        function showResult(elementId, success, message) {
            const div = document.getElementById(elementId);
            div.className = success ? 'success' : 'error';
            div.innerHTML = success ? 'âœ… ' + message : 'âŒ ' + message;
        }

        // ========== ØªØ³Øªâ€ŒÙ‡Ø§ ==========
        async function runTest1() {
            const btn = event.target;
            setLoading(btn, true);
            
            try {
                // ØªØ³Øª ØªÙ†Ø¸ÛŒÙ… ØªÙˆÚ©Ù†
                const token = 'valid_token_' + Date.now();
                client.setToken(token);
                
                // ØªØ³Øª Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù†
                const retrievedToken = client.getToken();
                
                if (!retrievedToken) {
                    throw new Error('ØªÙˆÚ©Ù† Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯');
                }
                
                if (retrievedToken !== token) {
                    throw new Error('ØªÙˆÚ©Ù† Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø´Ø¯');
                }
                
                showResult('result1', true, 
                    `ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ†Ø¸ÛŒÙ… Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯: ${token.substring(0, 20)}...`);
                passedTests++;
                
            } catch (error) {
                showResult('result1', false, 
                    `Ø®Ø·Ø§ Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†: ${error.message}`);
                failedTests++;
            }
            
            setLoading(btn, false);
            updateStats();
        }
        
        async function runTest2() {
            const btn = event.target;
            setLoading(btn, true);
            
            try {
                // ØªÙ†Ø¸ÛŒÙ… ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø±
                client.setToken('valid_token_' + Date.now());
                
                // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ ØªÙˆÚ©Ù†
                const result = await client.getProfile();
                
                if (!result.success) {
                    throw new Error('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
                }
                
                if (!result.data.hasToken) {
                    throw new Error('ØªÙˆÚ©Ù† Ø¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯');
                }
                
                showResult('result2', true, 
                    `Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø­Ø±Ø§Ø² Ø´Ø¯Ù‡ Ù…ÙˆÙÙ‚ - Ú©Ø§Ø±Ø¨Ø±: ${result.data.user.name}`);
                passedTests++;
                
            } catch (error) {
                showResult('result2', false, 
                    `Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø­Ø±Ø§Ø² Ø´Ø¯Ù‡: ${error.message}`);
                failedTests++;
            }
            
            setLoading(btn, false);
            updateStats();
        }
        
        async function runTest3() {
            const btn = event.target;
            setLoading(btn, true);
            
            try {
                // ØªÙ†Ø¸ÛŒÙ… ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡
                client.setToken('expired_token');
                
                // Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø¨Ø¯Ù‡Ø¯
                await client.getProfile();
                
                // Ø§Ú¯Ø± Ø¨Ù‡ Ø§ÛŒÙ† Ø®Ø· Ø±Ø³ÛŒØ¯ÛŒÙ… ÛŒØ¹Ù†ÛŒ Ø®Ø·Ø§ Ù†Ø¯Ø§Ø¯ (Ú©Ù‡ Ø¨Ø¯ Ø§Ø³Øª)
                throw new Error('Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ÛŒ 401 Ù…ÛŒâ€ŒØ¯Ø§Ø¯ Ø§Ù…Ø§ Ù†Ø¯Ø§Ø¯!');
                
            } catch (error) {
                // Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ Ø®Ø·Ø§
                if (error.status === 401 || error.message.includes('Ù†Ø§Ù…Ø¹ØªØ¨Ø±')) {
                    showResult('result3', true, 
                        `Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ÛŒ ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± ØµØ­ÛŒØ­ Ú©Ø§Ø± Ú©Ø±Ø¯: ${error.error || error.message}`);
                    passedTests++;
                } else {
                    showResult('result3', false, 
                        `Ø®Ø·Ø§ÛŒ Ù†Ø§Ø¯Ø±Ø³Øª: ${error.message}`);
                    failedTests++;
                }
            }
            
            setLoading(btn, false);
            updateStats();
        }
        
        async function runTest4() {
            const btn = event.target;
            setLoading(btn, true);
            
            try {
                // Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ÛŒØ¯ timeout Ø¨Ø®ÙˆØ±Ø¯
                await client.getSlowEndpoint();
                
                // Ø§Ú¯Ø± Ø¨Ù‡ Ø§ÛŒÙ† Ø®Ø· Ø±Ø³ÛŒØ¯ÛŒÙ… ÛŒØ¹Ù†ÛŒ timeout Ù†Ø®ÙˆØ±Ø¯ (Ú©Ù‡ Ø¨Ø¯ Ø§Ø³Øª)
                throw new Error('Ø¨Ø§ÛŒØ¯ timeout Ù…ÛŒâ€ŒØ®ÙˆØ±Ø¯ Ø§Ù…Ø§ Ù†Ø¯Ø§Ø¯!');
                
            } catch (error) {
                // Ø¨Ø±Ø±Ø³ÛŒ timeout
                if (error.message.includes('Timeout')) {
                    showResult('result4', true, 
                        `Ù…Ø¯ÛŒØ±ÛŒØª timeout ØµØ­ÛŒØ­ Ú©Ø§Ø± Ú©Ø±Ø¯: ${error.message}`);
                    passedTests++;
                } else {
                    showResult('result4', false, 
                        `Ø®Ø·Ø§ÛŒ Ù†Ø§Ø¯Ø±Ø³Øª: ${error.message}`);
                    failedTests++;
                }
            }
            
            setLoading(btn, false);
            updateStats();
        }
        
        // ========== ØªÙˆØ§Ø¨Ø¹ Ú©Ù†ØªØ±Ù„ ==========
        async function runAllTests() {
            // Ø±ÛŒØ³Øª Ø¢Ù…Ø§Ø±
            passedTests = 0;
            failedTests = 0;
            updateStats();
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬ Ù‚Ø¨Ù„ÛŒ
            for (let i = 1; i <= 4; i++) {
                document.getElementById('result' + i).innerHTML = '';
                document.getElementById('result' + i).className = '';
            }
            
            // Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ ÙˆÙ‚ÙÙ‡
            await runTestWrapper(1);
            await delay(600);
            await runTestWrapper(2);
            await delay(600);
            await runTestWrapper(3);
            await delay(600);
            await runTestWrapper(4);
            
            console.log(`ğŸ¯ ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯: ${passedTests} Ù…ÙˆÙÙ‚ØŒ ${failedTests} Ù†Ø§Ù…ÙˆÙÙ‚`);
        }
        
        async function runTestWrapper(testNumber) {
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ ØªØ³Øª
            const event = { target: document.querySelector(`button[onclick="runTest${testNumber}()"]`) };
            window[`runTest${testNumber}`](event);
            await delay(800); // Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª
        }
        
        function resetAll() {
            // Ø±ÛŒØ³Øª Ú©Ù„Ø§ÛŒÙ†Øª
            client.token = null;
            client.requestCount = 0;
            
            // Ø±ÛŒØ³Øª Ù†ØªØ§ÛŒØ¬
            for (let i = 1; i <= 4; i++) {
                document.getElementById('result' + i).innerHTML = '';
                document.getElementById('result' + i).className = '';
            }
            
            // Ø±ÛŒØ³Øª Ø¢Ù…Ø§Ø±
            passedTests = 0;
            failedTests = 0;
            updateStats();
            
            console.log('â™»ï¸ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ø±ÛŒØ³Øª Ø´Ø¯Ù†Ø¯');
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ==========
        console.log('ğŸ” ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª API Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§');
        updateStats();
    </script>
</body>
</html>
