<!DOCTYPE html>
<html>
<head>
    <title>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Vakamova</title>
    <style>
        body { font-family: Tahoma; padding: 20px; }
        .scenario { background: #E3F2FD; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: #2E7D32; }
        .error { color: #C62828; }
        .warning { color: #F57C00; }
    </style>
</head>
<body>
    <h1>ğŸš€ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Vakamova</h1>
    
    <div id="log"></div>
    
    <div class="scenario">
        <h3>Ø³Ù†Ø§Ø±ÛŒÙˆ: Ú©Ø§Ø±Ø¨Ø± Ú©Ø§Ù…Ù„ Ø§Ø² Ù„Ø§Ú¯ÛŒÙ† ØªØ§ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</h3>
        <button onclick="runFullScenario()">Ø´Ø±ÙˆØ¹ Ø³Ù†Ø§Ø±ÛŒÙˆ Ú©Ø§Ù…Ù„</button>
    </div>

    <script>
        // Ù‡Ù…Ù‡ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± ÛŒÚ© ÙØ§ÛŒÙ„ ÙØ±Ø¶ÛŒ Ù…ÛŒâ€ŒØ¢ÙˆØ±ÛŒÙ…
        class IntegratedSystem {
            constructor() {
                this.log("ğŸ”§ Ø³ÛŒØ³ØªÙ… ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ...");
                this.components = {};
                this.testResults = {};
            }
            
            log(message, type = 'info') {
                const logEl = document.getElementById('log');
                const color = type === 'error' ? 'error' : 
                             type === 'success' ? 'success' : 
                             type === 'warning' ? 'warning' : 'black';
                logEl.innerHTML += `<div class="${color}">${message}</div>`;
                console.log(message);
            }
            
            async initializeAll() {
                try {
                    // 1. EventBus
                    this.log("1. ğŸ“¢ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ EventBus...");
                    this.components.eventBus = new EventBus();
                    
                    // 2. StateManager
                    this.log("2. ğŸ—„ï¸ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ StateManager...");
                    this.components.stateManager = new StateManager({
                        user: null,
                        lessons: [],
                        settings: { language: 'fa' }
                    });
                    
                    // 3. SessionManager
                    this.log("3. ğŸ” Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ SessionManager...");
                    this.components.sessionManager = new SessionManager(
                        this.components.eventBus,
                        this.components.stateManager,
                        { accessTokenTTL: 15000 }
                    );
                    
                    // 4. OfflineQueue
                    this.log("4. ğŸ“¦ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ OfflineQueue...");
                    this.components.offlineQueue = new OfflineQueue(
                        this.components.eventBus,
                        { maxQueueSize: 20 }
                    );
                    
                    // 5. RealTimeSync
                    this.log("5. ğŸ”„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ RealTimeSync...");
                    this.components.realTimeSync = new RealTimeSync(
                        this.components.eventBus,
                        this.components.stateManager,
                        { syncInterval: 10000 }
                    );
                    
                    this.log("âœ… ØªÙ…Ø§Ù… Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øªâ€ŒÙ‡Ø§ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯Ù†Ø¯!", "success");
                    return true;
                    
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ: ${error.message}`, "error");
                    return false;
                }
            }
            
            async runUserScenario() {
                this.log("\nğŸ¬ Ø´Ø±ÙˆØ¹ Ø³Ù†Ø§Ø±ÛŒÙˆ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ù‚Ø¹ÛŒ...");
                
                // Ù…Ø±Ø­Ù„Ù‡ Û±: Ù„Ø§Ú¯ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±
                this.log("\nğŸ” Ù…Ø±Ø­Ù„Ù‡ Û±: Ù„Ø§Ú¯ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±...");
                try {
                    const session = await this.components.sessionManager.login({
                        email: 'user@vakamova.com',
                        password: 'test123'
                    });
                    this.log(`âœ… Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯ÛŒÙ† Ú©Ø±Ø¯: ${session.userId}`, "success");
                    this.testResults.login = 'PASS';
                } catch (error) {
                    this.log(`âŒ Ù„Ø§Ú¯ÛŒÙ† Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯: ${error.message}`, "error");
                    this.testResults.login = 'FAIL';
                    return;
                }
                
                // Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³
                this.log("\nğŸ“š Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³...");
                this.components.stateManager.dispatch({
                    type: 'ADD_LESSON',
                    payload: {
                        id: 'lesson_intro',
                        title: 'Ù…Ø¹Ø±ÙÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡',
                        progress: 0
                    }
                });
                this.log("âœ… Ø¯Ø±Ø³ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯", "success");
                this.testResults.addLesson = 'PASS';
                
                // Ù…Ø±Ø­Ù„Ù‡ Û³: Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø± Ø¯Ø±Ø³
                this.log("\nğŸ“ˆ Ù…Ø±Ø­Ù„Ù‡ Û³: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´Ø±ÙØª...");
                this.components.stateManager.dispatch({
                    type: 'UPDATE_LESSON',
                    payload: { id: 'lesson_intro', progress: 50 }
                });
                this.log("âœ… Ù¾ÛŒØ´Ø±ÙØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯", "success");
                this.testResults.updateProgress = 'PASS';
                
                // Ù…Ø±Ø­Ù„Ù‡ Û´: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØµÙ Ø¢ÙÙ„Ø§ÛŒÙ†
                this.log("\nğŸ“¦ Ù…Ø±Ø­Ù„Ù‡ Û´: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØµÙ Ø¢ÙÙ„Ø§ÛŒÙ†...");
                try {
                    await this.components.offlineQueue.enqueue('SYNC_PROGRESS', {
                        lessonId: 'lesson_intro',
                        progress: 50,
                        userId: 'user_123'
                    }, { priority: 5 });
                    this.log("âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ù‡ ØµÙ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯", "success");
                    this.testResults.queueAdd = 'PASS';
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØµÙ: ${error.message}`, "error");
                    this.testResults.queueAdd = 'FAIL';
                }
                
                // Ù…Ø±Ø­Ù„Ù‡ Ûµ: Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ
                this.log("\nğŸ”„ Ù…Ø±Ø­Ù„Ù‡ Ûµ: Ø´Ø±ÙˆØ¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ...");
                try {
                    const syncResults = await this.components.realTimeSync.syncAll();
                    const successful = syncResults.filter(r => r.success).length;
                    this.log(`âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯: ${successful} Ù…ÙˆÙÙ‚`, "success");
                    this.testResults.sync = 'PASS';
                } catch (error) {
                    this.log(`âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ: ${error.message}`, "warning");
                    this.testResults.sync = 'PARTIAL';
                }
                
                // Ù…Ø±Ø­Ù„Ù‡ Û¶: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†
                this.log("\nğŸ“´ Ù…Ø±Ø­Ù„Ù‡ Û¶: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†...");
                this.components.offlineQueue.setOnline(false);
                this.log("âœ… Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† ÙØ¹Ø§Ù„ Ø´Ø¯", "warning");
                
                // Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†
                setTimeout(() => {
                    this.log("â• Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†...");
                    this.components.offlineQueue.enqueue('SYNC_SETTINGS', {
                        theme: 'dark',
                        language: 'fa'
                    }, { priority: 3 });
                    this.testResults.offlineOperation = 'PASS';
                    
                    // Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†
                    setTimeout(() => {
                        this.log("\nğŸŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¢Ù†Ù„Ø§ÛŒÙ†...");
                        this.components.offlineQueue.setOnline(true);
                        this.log("âœ… Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯ - ØµÙ Ø¨Ø§ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´ÙˆØ¯", "success");
                        this.testResults.onlineRecovery = 'PASS';
                        
                        // Ù…Ø±Ø­Ù„Ù‡ Û·: Ù„Ø§Ú¯Ø§ÙˆØª
                        setTimeout(async () => {
                            this.log("\nğŸ‘‹ Ù…Ø±Ø­Ù„Ù‡ Û·: Ù„Ø§Ú¯Ø§ÙˆØª Ú©Ø§Ø±Ø¨Ø±...");
                            await this.components.sessionManager.logout();
                            this.log("âœ… Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯Ø§ÙˆØª Ú©Ø±Ø¯", "success");
                            this.testResults.logout = 'PASS';
                            
                            // Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ
                            this.showFinalResults();
                        }, 2000);
                    }, 3000);
                }, 1000);
            }
            
            showFinalResults() {
                this.log("\n" + "=".repeat(50));
                this.log("ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡:", "success");
                
                Object.entries(this.testResults).forEach(([test, result]) => {
                    const icon = result === 'PASS' ? 'âœ…' : 
                                result === 'FAIL' ? 'âŒ' : 'âš ï¸';
                    this.log(`${icon} ${test}: ${result}`);
                });
                
                const allPassed = Object.values(this.testResults)
                    .every(r => r === 'PASS' || r === 'PARTIAL');
                
                if (allPassed) {
                    this.log("\nğŸ‰ Ø³ÛŒØ³ØªÙ… ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ³Øª Ø´Ø¯!", "success");
                    this.log("âœ… ØªÙ…Ø§Ù… Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ Ø¨Ø§ Ù‡Ù… Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯");
                    this.log("âœ… Ø³Ù†Ø§Ø±ÛŒÙˆ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø·ÙˆØ± Ú©Ø§Ù…Ù„ Ø§Ø¬Ø±Ø§ Ø´Ø¯");
                    this.log("âœ… Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ† Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯");
                    this.log("ğŸš€ Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§ØµÙ„ÛŒ!");
                } else {
                    this.log("\nâš ï¸ Ø¨Ø±Ø®ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø±Ù†Ø¯", "warning");
                }
            }
        }
        
        // ØªØ¹Ø±ÛŒÙ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ (Ù‡Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ ØªØ³Øª Ø´Ø¯Ù†Ø¯)
        class EventBus { /* Ú©Ø¯ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ */ }
        class StateManager { /* Ú©Ø¯ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ */ }
        class SessionManager { /* Ú©Ø¯ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ */ }
        class OfflineQueue { /* Ú©Ø¯ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ */ }
        class RealTimeSync { /* Ú©Ø¯ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ */ }
        
        // Ø§Ø¬Ø±Ø§ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆ
        async function runFullScenario() {
            const system = new IntegratedSystem();
            const initialized = await system.initializeAll();
            
            if (initialized) {
                await system.runUserScenario();
            }
        }
    </script>
</body>
</html>
