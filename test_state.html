<!DOCTYPE html>
<html>
<head>
    <title>ØªØ³Øª StateManager</title>
    <style>
        body { 
            font-family: Tahoma; 
            padding: 20px;
            text-align: center;
        }
        button {
            padding: 12px 25px;
            font-size: 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover { background: #0b7dda; }
        #result {
            margin: 20px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            min-height: 150px;
            font-family: monospace;
            text-align: left;
            background: #f9f9f9;
            max-height: 400px;
            overflow-y: auto;
        }
        .state-display {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        .step {
            margin: 8px 0;
            padding: 8px;
            border-left: 4px solid #4CAF50;
            background: white;
        }
        .error-step { border-left-color: #f44336; }
        .warning-step { border-left-color: #ff9800; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª StateManager + EventBus</h1>
    <p>ÙØ§Ø² Û²: Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡</p>
    
    <div>
        <button onclick="testStateManager()">ØªØ³Øª StateManager</button>
        <button onclick="clearLog()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
    </div>
    
    <div id="result">
        Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ ØªØ³Øª...
    </div>
    
    <div id="stateDisplay" class="state-display">
        State ÙØ¹Ù„ÛŒ: Ù…Ù†ØªØ¸Ø± ØªØ³Øª...
    </div>

    <script>
        // ==================== Û±. EventBus Ø³Ø§Ø¯Ù‡ (Ù‡Ù…Ø§Ù† Ù‚Ø¨Ù„ÛŒ) ====================
        class EventBus {
            constructor() {
                this.listeners = {};
            }
            
            on(eventName, callback) {
                if (!this.listeners[eventName]) {
                    this.listeners[eventName] = [];
                }
                this.listeners[eventName].push(callback);
                return () => this.off(eventName, callback);
            }
            
            off(eventName, callback) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName] = this.listeners[eventName].filter(cb => cb !== callback);
                }
            }
            
            emit(eventName, data) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName].forEach(callback => {
                        try {
                            callback(data);
                        } catch (error) {
                            console.error('Listener error:', error);
                        }
                    });
                }
            }
        }
        
        // ==================== Û². StateManager ====================
        class StateManager {
            constructor(initialState = {}) {
                this.state = { ...initialState };
                this.eventBus = new EventBus();
                this.history = [];
                this.maxHistory = 10;
                
                log("âœ… StateManager Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯");
                this.updateDisplay();
            }
            
            // Ø¯Ø±ÛŒØ§ÙØª state ÙØ¹Ù„ÛŒ
            getState() {
                return { ...this.state };
            }
            
            // ØªØºÛŒÛŒØ± state (dispatch action)
            dispatch(action) {
                const oldState = { ...this.state };
                
                log(`ğŸ”„ Dispatch action: ${action.type}`);
                console.log('Action:', action);
                
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ actionâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                switch (action.type) {
                    case 'SET_USER':
                        this.state.user = action.payload;
                        break;
                        
                    case 'UPDATE_SETTINGS':
                        this.state.settings = { 
                            ...this.state.settings, 
                            ...action.payload 
                        };
                        break;
                        
                    case 'ADD_LESSON':
                        if (!this.state.lessons) this.state.lessons = [];
                        this.state.lessons.push(action.payload);
                        break;
                        
                    case 'UPDATE_LESSON_PROGRESS':
                        if (this.state.lessons) {
                            const lesson = this.state.lessons.find(l => l.id === action.payload.id);
                            if (lesson) {
                                lesson.progress = action.payload.progress;
                            }
                        }
                        break;
                        
                    case 'CLEAR_DATA':
                        this.state = { settings: this.state.settings || {} };
                        break;
                        
                    default:
                        log(`âš ï¸ Action Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡: ${action.type}`, 'warning');
                        return;
                }
                
                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
                this.history.push({
                    action,
                    oldState,
                    newState: { ...this.state },
                    timestamp: Date.now()
                });
                
                // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡
                if (this.history.length > this.maxHistory) {
                    this.history.shift();
                }
                
                // Ø§Ù†ØªØ´Ø§Ø± event ØªØºÛŒÛŒØ± state
                this.eventBus.emit('state.changed', {
                    type: action.type,
                    payload: action.payload,
                    oldState,
                    newState: this.state,
                    timestamp: Date.now()
                });
                
                this.updateDisplay();
                log(`âœ… State Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯ Ø¨Ø§ action: ${action.type}`);
            }
            
            // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ù‚Ø¨Ù„ÛŒ (undo)
            undo() {
                if (this.history.length > 0) {
                    const lastChange = this.history.pop();
                    this.state = lastChange.oldState;
                    this.eventBus.emit('state.undo', lastChange);
                    this.updateDisplay();
                    log("â†©ï¸ Ø¹Ù…Ù„ÛŒØ§Øª undo Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯");
                    return true;
                }
                return false;
            }
            
            // Ø°Ø®ÛŒØ±Ù‡ state Ø¯Ø± localStorage
            save() {
                try {
                    localStorage.setItem('vakamova_state', JSON.stringify(this.state));
                    log("ğŸ’¾ State Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
                    return true;
                } catch (error) {
                    log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ: ${error.message}`, 'error');
                    return false;
                }
            }
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ state Ø§Ø² localStorage
            load() {
                try {
                    const saved = localStorage.getItem('vakamova_state');
                    if (saved) {
                        this.state = JSON.parse(saved);
                        this.updateDisplay();
                        log("ğŸ“‚ State Ø§Ø² localStorage Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯");
                        return true;
                    }
                } catch (error) {
                    log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ${error.message}`, 'error');
                }
                return false;
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ state
            updateDisplay() {
                const display = document.getElementById('stateDisplay');
                if (display) {
                    display.innerHTML = `
                        <strong>State ÙØ¹Ù„ÛŒ:</strong>
                        <pre>${JSON.stringify(this.state, null, 2)}</pre>
                        <small>ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${this.history.length} ØªØºÛŒÛŒØ±</small>
                    `;
                }
            }
        }
        
        // ==================== Û³. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
        function log(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const stepClass = type === 'error' ? 'error-step' : 
                            type === 'warning' ? 'warning-step' : 'step';
            
            resultDiv.innerHTML += `
                <div class="${stepClass}">
                    <strong>[${new Date().toLocaleTimeString()}]</strong> ${message}
                </div>
            `;
            resultDiv.scrollTop = resultDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('result').innerHTML = '';
        }
        
        // ==================== Û´. ØªØ³Øª Ø§ØµÙ„ÛŒ ====================
        let stateManager = null;
        
        function testStateManager() {
            clearLog();
            log("ğŸ¬ Ø´Ø±ÙˆØ¹ ØªØ³Øª StateManager...", "success");
            
            try {
                // Û±. Ø³Ø§Ø®Øª StateManager Ø¨Ø§ state Ø§ÙˆÙ„ÛŒÙ‡
                log("Ù…Ø±Ø­Ù„Ù‡ Û±: Ø³Ø§Ø®Øª StateManager...");
                stateManager = new StateManager({
                    user: null,
                    lessons: [],
                    settings: {
                        theme: 'light',
                        language: 'fa',
                        notifications: true
                    },
                    appState: 'idle'
                });
                
                // Û². Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª state
                log("Ù…Ø±Ø­Ù„Ù‡ Û²: Ø«Ø¨Øª listener Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±Ø§Øª state...");
                stateManager.eventBus.on('state.changed', (data) => {
                    log(`ğŸ“¢ State changed: ${data.type}`, "warning");
                });
                
                // Û³. ØªØºÛŒÛŒØ± stateâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                log("Ù…Ø±Ø­Ù„Ù‡ Û³: ØªØºÛŒÛŒØ± state (SET_USER)...");
                setTimeout(() => {
                    stateManager.dispatch({
                        type: 'SET_USER',
                        payload: {
                            id: 'user_001',
                            email: 'user@vakamova.com',
                            name: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ',
                            subscription: 'premium'
                        }
                    });
                }, 500);
                
                // Û´. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³
                log("Ù…Ø±Ø­Ù„Ù‡ Û´: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³...");
                setTimeout(() => {
                    stateManager.dispatch({
                        type: 'ADD_LESSON',
                        payload: {
                            id: 'lesson_001',
                            title: 'Ù…Ù‚Ø¯Ù…Ø§Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ',
                            level: 1,
                            progress: 0,
                            duration: '30 Ø¯Ù‚ÛŒÙ‚Ù‡'
                        }
                    });
                }, 1000);
                
                // Ûµ. Ø¢Ù¾Ø¯ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                log("Ù…Ø±Ø­Ù„Ù‡ Ûµ: ØªØºÛŒÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª...");
                setTimeout(() => {
                    stateManager.dispatch({
                        type: 'UPDATE_SETTINGS',
                        payload: {
                            theme: 'dark',
                            offlineMode: true
                        }
                    });
                }, 1500);
                
                // Û¶. Ø¢Ù¾Ø¯ÛŒØª Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³
                log("Ù…Ø±Ø­Ù„Ù‡ Û¶: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³...");
                setTimeout(() => {
                    stateManager.dispatch({
                        type: 'UPDATE_LESSON_PROGRESS',
                        payload: {
                            id: 'lesson_001',
                            progress: 75
                        }
                    });
                }, 2000);
                
                // Û·. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³ Ø¯ÛŒÚ¯Ø±
                setTimeout(() => {
                    stateManager.dispatch({
                        type: 'ADD_LESSON',
                        payload: {
                            id: 'lesson_002',
                            title: 'Ú¯Ø±Ø§Ù…Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡',
                            level: 3,
                            progress: 25,
                            duration: '45 Ø¯Ù‚ÛŒÙ‚Ù‡'
                        }
                    });
                }, 2500);
                
                // Û¸. ØªØ³Øª undo
                log("Ù…Ø±Ø­Ù„Ù‡ Û·: ØªØ³Øª undo...");
                setTimeout(() => {
                    const undone = stateManager.undo();
                    if (undone) {
                        log("âœ… Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ± undo Ø´Ø¯");
                    } else {
                        log("âš ï¸ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ undo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", "warning");
                    }
                }, 3000);
                
                // Û¹. ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ
                log("Ù…Ø±Ø­Ù„Ù‡ Û¸: ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± localStorage...");
                setTimeout(() => {
                    const saved = stateManager.save();
                    if (saved) {
                        log("âœ… State Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
                    }
                }, 3500);
                
                // Û±Û°. ØªØ³Øª action Ù†Ø§Ù…Ø¹ØªØ¨Ø±
                log("Ù…Ø±Ø­Ù„Ù‡ Û¹: ØªØ³Øª action Ù†Ø§Ù…Ø¹ØªØ¨Ø±...");
                setTimeout(() => {
                    stateManager.dispatch({
                        type: 'UNKNOWN_ACTION',
                        payload: {}
                    });
                }, 4000);
                
                // Û±Û±. Ù†Ù…Ø§ÛŒØ´ state Ù†Ù‡Ø§ÛŒÛŒ
                log("Ù…Ø±Ø­Ù„Ù‡ Û±Û°: Ù†Ù…Ø§ÛŒØ´ state Ù†Ù‡Ø§ÛŒÛŒ...");
                setTimeout(() => {
                    const finalState = stateManager.getState();
                    log("=".repeat(50));
                    log("ğŸ‰ ØªØ³Øª StateManager Ú©Ø§Ù…Ù„ Ø´Ø¯!", "success");
                    log(`âœ… Ú©Ø§Ø±Ø¨Ø±: ${finalState.user?.name || 'Ù‡ÛŒÚ†'}`);
                    log(`âœ… ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø³â€ŒÙ‡Ø§: ${finalState.lessons?.length || 0}`);
                    log(`âœ… ØªÙ…: ${finalState.settings?.theme}`);
                    log(`âœ… ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª: ${stateManager.history.length}`);
                    
                    // Ù†Ù…Ø§ÛŒØ´ state Ø¯Ø± console Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ
                    console.log('Final state:', finalState);
                }, 4500);
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª StateManager: ${error.message}`, "error");
                console.error("StateManager test error:", error);
            }
        }
        
        // ==================== Ûµ. ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ ====================
        window.onload = function() {
            log("ğŸ“± StateManager Test Ready");
            log("Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'ØªØ³Øª StateManager' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯");
        };
    </script>
</body>
</html>
