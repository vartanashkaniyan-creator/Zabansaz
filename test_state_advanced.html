<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Manager</title>
    <style>
        body { font-family: Tahoma; margin: 20px; }
        .test-section { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        #output { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Manager</h1>
    
    <div class="test-section">
        <h3>ğŸ§© Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ ØªØ³Øª</h3>
        <button onclick="runAllTests()">ğŸ¯ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
        <button onclick="testUndoRedo()">â†ªï¸ ØªØ³Øª Undo/Redo</button>
        <button onclick="testMiddleware()">ğŸ”Œ ØªØ³Øª Middleware</button>
        <button onclick="testSnapshot()">ğŸ“¸ ØªØ³Øª Snapshot</button>
        <button onclick="testPerformance()">âš¡ ØªØ³Øª Performance</button>
        <button onclick="testValidation()">âœ… ØªØ³Øª Validation</button>
    </div>
    
    <div id="output" class="test-section"></div>
    
    <script type="module">
        import StateManager from './core/state-manager.js';
        import StateValidator from './core/state-validator.js';
        
        const output = document.getElementById('output');
        let stateManager;
        
        function log(type, message) {
            const prefix = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            output.innerHTML += `<div class="${type}">${prefix} ${message}</div>`;
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }
        
        function createTestStateManager() {
            return new StateManager({
                user: {
                    id: null,
                    name: '',
                    email: '',
                    preferences: {
                        theme: 'light',
                        language: 'fa'
                    }
                },
                lessons: {
                    current: null,
                    progress: {},
                    completed: []
                },
                ui: {
                    sidebarOpen: true,
                    currentPage: 'dashboard'
                }
            });
        }
        
        // 1. ØªØ³Øª Undo/Redo Ù¾ÛŒØ´Ø±ÙØªÙ‡
        async function testUndoRedo() {
            clearOutput();
            log('info', 'Ø´Ø±ÙˆØ¹ ØªØ³Øª Undo/Redo...');
            
            try {
                stateManager = createTestStateManager();
                stateManager.setMaxHistory(5); // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ù‡ Ûµ Ù‚Ø¯Ù…
                
                // Ø§ÛŒØ¬Ø§Ø¯ ØªØºÛŒÛŒØ±Ø§Øª Ù…ØªÙˆØ§Ù„ÛŒ
                for (let i = 1; i <= 7; i++) {
                    stateManager.setState({
                        user: { name: `Ú©Ø§Ø±Ø¨Ø± ${i}` },
                        ui: { currentPage: `page_${i}` }
                    });
                    log('info', `ØªØºÛŒÛŒØ± ${i}: ${stateManager.getState().user.name}`);
                }
                
                // Undo
                log('info', '--- Ø§Ø¬Ø±Ø§ÛŒ Undo ---');
                for (let i = 0; i < 3; i++) {
                    const success = stateManager.undo();
                    if (success) {
                        const state = stateManager.getState();
                        log('info', `Undo ${i+1}: ${state.user.name} - ${state.ui.currentPage}`);
                    }
                }
                
                // Redo
                log('info', '--- Ø§Ø¬Ø±Ø§ÛŒ Redo ---');
                for (let i = 0; i < 2; i++) {
                    const success = stateManager.redo();
                    if (success) {
                        const state = stateManager.getState();
                        log('info', `Redo ${i+1}: ${state.user.name} - ${state.ui.currentPage}`);
                    }
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡
                const history = stateManager.getHistory();
                log('info', `ØªØ¹Ø¯Ø§Ø¯ Ù‚Ø¯Ù…â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${history.length} (Ø­Ø¯Ø§Ú©Ø«Ø±: 5)`);
                
                if (history.length === 5) {
                    log('success', 'âœ… Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯');
                } else {
                    log('error', 'âŒ Ù…Ø´Ú©Ù„ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡');
                }
                
                // ØªØ³Øª Clear History
                stateManager.clearHistory();
                const clearedHistory = stateManager.getHistory();
                if (clearedHistory.length === 0) {
                    log('success', 'âœ… ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯');
                }
                
            } catch (error) {
                log('error', `Ø®Ø·Ø§: ${error.message}`);
            }
        }
        
        // 2. ØªØ³Øª Middleware
        async function testMiddleware() {
            clearOutput();
            log('info', 'Ø´Ø±ÙˆØ¹ ØªØ³Øª Middleware...');
            
            try {
                stateManager = createTestStateManager();
                
                // Ø«Ø¨Øª Middleware Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ ØªØºÛŒÛŒØ±Ø§Øª
                const unsubscribeLog = stateManager.subscribe((newState, oldState, action) => {
                    log('info', `ğŸ“ Middleware Log: ${action} - ØªØºÛŒÛŒØ± Ø¯Ø± ${Object.keys(newState).join(', ')}`);
                });
                
                // Ø«Ø¨Øª Middleware Ø¨Ø±Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                const unsubscribeValidation = stateManager.subscribe((newState) => {
                    if (newState.user.name && newState.user.name.length > 50) {
                        throw new Error('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø®ÛŒÙ„ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª');
                    }
                });
                
                // ØªØºÛŒÛŒØ±Ø§Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ
                stateManager.setState({ user: { name: 'Ø¹Ù„ÛŒ' } }, 'UPDATE_USER');
                stateManager.setState({ ui: { sidebarOpen: false } }, 'TOGGLE_SIDEBAR');
                
                // ØªØ³Øª Middleware Ø®Ø·Ø§
                try {
                    stateManager.setState({ 
                        user: { name: 'Ø§ÛŒÙ† ÛŒÚ© Ù†Ø§Ù… Ø¨Ø³ÛŒØ§Ø± Ø¨Ø³ÛŒØ§Ø± Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ø¯' } 
                    }, 'UPDATE_LONG_NAME');
                    log('error', 'âŒ Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´Ø¯');
                } catch (error) {
                    log('success', `âœ… Middleware Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø§Ø± Ú©Ø±Ø¯: ${error.message}`);
                }
                
                // Ù„ØºÙˆ subscription
                unsubscribeLog();
                unsubscribeValidation();
                
                log('info', 'ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ø² unsubscribe...');
                stateManager.setState({ user: { name: 'Ø±Ø¶Ø§' } }, 'AFTER_UNSUBSCRIBE');
                
                log('success', 'âœ… ØªÙ…Ø§Ù… MiddlewareÙ‡Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ú©Ø±Ø¯Ù†Ø¯');
                
            } catch (error) {
                log('error', `Ø®Ø·Ø§: ${error.message}`);
            }
        }
        
        // 3. ØªØ³Øª Snapshot
        async function testSnapshot() {
            clearOutput();
            log('info', 'Ø´Ø±ÙˆØ¹ ØªØ³Øª Snapshot...');
            
            try {
                stateManager = createTestStateManager();
                
                // Ø§ÛŒØ¬Ø§Ø¯ ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡
                stateManager.setState({
                    user: { id: 1, name: 'Ù…Ø­Ù…Ø¯', email: 'mohammad@test.com' },
                    lessons: { current: 'lesson_1', progress: { lesson_1: 50 } }
                });
                
                // Ú¯Ø±ÙØªÙ† Snapshot
                const snapshot1 = stateManager.createSnapshot();
                log('info', `Snapshot 1 Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: ${JSON.stringify(snapshot1).substring(0, 100)}...`);
                
                // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª
                stateManager.setState({
                    user: { name: 'Ù…Ø­Ù…Ø¯ Ø±Ø¶Ø§' },
                    lessons: { current: 'lesson_2', progress: { lesson_1: 100, lesson_2: 25 } }
                });
                
                // Ú¯Ø±ÙØªÙ† Snapshot Ø¯ÙˆÙ…
                const snapshot2 = stateManager.createSnapshot();
                
                // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø¨Ù‡ Snapshot Ø§ÙˆÙ„
                stateManager.restoreSnapshot(snapshot1);
                const restoredState = stateManager.getState();
                
                if (restoredState.user.name === 'Ù…Ø­Ù…Ø¯' && restoredState.lessons.current === 'lesson_1') {
                    log('success', 'âœ… Snapshot Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø´Ø¯');
                } else {
                    log('error', 'âŒ Ù…Ø´Ú©Ù„ Ø¯Ø± Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Snapshot');
                }
                
                // ØªØ³Øª Serialization/Deserialization
                const serialized = JSON.stringify(snapshot1);
                const deserialized = JSON.parse(serialized);
                stateManager.restoreSnapshot(deserialized);
                
                log('success', 'âœ… Serialization/Deserialization Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                
            } catch (error) {
                log('error', `Ø®Ø·Ø§: ${error.message}`);
            }
        }
        
        // 4. ØªØ³Øª Performance
        async function testPerformance() {
            clearOutput();
            log('info', 'Ø´Ø±ÙˆØ¹ ØªØ³Øª Performance...');
            
            try {
                stateManager = createTestStateManager();
                const startTime = performance.now();
                const iterations = 1000;
                
                // ØªØºÛŒÛŒØ±Ø§Øª Ø³Ø±ÛŒØ¹
                for (let i = 0; i < iterations; i++) {
                    stateManager.setState({
                        ui: { currentPage: `page_${i % 10}` },
                        user: { name: `User_${i}` }
                    }, `UPDATE_${i}`);
                }
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                const opsPerSecond = (iterations / duration) * 1000;
                
                log('info', `â±ï¸ Performance Results:`);
                log('info', `  ØªØ¹Ø¯Ø§Ø¯ Ø¹Ù…Ù„ÛŒØ§Øª: ${iterations}`);
                log('info', `  Ø²Ù…Ø§Ù† Ú©Ù„: ${duration.toFixed(2)}ms`);
                log('info', `  Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø«Ø§Ù†ÛŒÙ‡: ${opsPerSecond.toFixed(2)}`);
                
                if (opsPerSecond > 100) {
                    log('success', 'âœ… Performance Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ø³Øª');
                } else {
                    log('warning', 'âš ï¸ Performance Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯ Ø¯Ø§Ø±Ø¯');
                }
                
                // ØªØ³Øª Memory
                const history = stateManager.getHistory();
                log('info', `ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${history.length}`);
                
                // Clear Ø¨Ø±Ø§ÛŒ Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÛŒ memory
                stateManager.clearHistory();
                log('success', 'âœ… Memory management Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                
            } catch (error) {
                log('error', `Ø®Ø·Ø§: ${error.message}`);
            }
        }
        
        // 5. ØªØ³Øª Validation
        async function testValidation() {
            clearOutput();
            log('info', 'Ø´Ø±ÙˆØ¹ ØªØ³Øª Validation...');
            
            try {
                stateManager = createTestStateManager();
                
                // ØªØ¹Ø±ÛŒÙ schema Ø¨Ø±Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                const schema = {
                    user: {
                        type: 'object',
                        required: ['id', 'name'],
                        properties: {
                            id: { type: 'number', min: 1 },
                            name: { type: 'string', minLength: 2, maxLength: 50 },
                            email: { type: 'string', format: 'email', optional: true }
                        }
                    },
                    lessons: {
                        type: 'object',
                        properties: {
                            current: { type: 'string' },
                            progress: { type: 'object' }
                        }
                    }
                };
                
                // ØªÙ†Ø¸ÛŒÙ… validator
                const validator = new StateValidator(schema);
                stateManager.setValidator(validator);
                
                // ÙˆØ¶Ø¹ÛŒØª Ù…Ø¹ØªØ¨Ø±
                try {
                    stateManager.setState({
                        user: { id: 1, name: 'Ø¹Ù„ÛŒ', email: 'ali@test.com' },
                        lessons: { current: 'lesson_1', progress: {} }
                    }, 'VALID_STATE');
                    log('success', 'âœ… ÙˆØ¶Ø¹ÛŒØª Ù…Ø¹ØªØ¨Ø± Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯');
                } catch (error) {
                    log('error', `âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ù…Ø¹ØªØ¨Ø±: ${error.message}`);
                }
                
                // ÙˆØ¶Ø¹ÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø±: id Ø§Ø´ØªØ¨Ø§Ù‡
                try {
                    stateManager.setState({
                        user: { id: 'not-a-number', name: 'Ø¹Ù„ÛŒ' }
                    }, 'INVALID_ID');
                    log('error', 'âŒ Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´Ø¯');
                } catch (error) {
                    log('success', `âœ… validation Ú©Ø§Ø± Ú©Ø±Ø¯: ${error.message}`);
                }
                
                // ÙˆØ¶Ø¹ÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø±: name Ú©ÙˆØªØ§Ù‡
                try {
                    stateManager.setState({
                        user: { id: 2, name: 'a' }
                    }, 'SHORT_NAME');
                    log('error', 'âŒ Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´Ø¯');
                } catch (error) {
                    log('success', `âœ… validation Ú©Ø§Ø± Ú©Ø±Ø¯: ${error.message}`);
                }
                
                // ÙˆØ¶Ø¹ÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø±: email Ù†Ø§Ø¯Ø±Ø³Øª
                try {
                    stateManager.setState({
                        user: { id: 3, name: 'Ø±Ø¶Ø§', email: 'invalid-email' }
                    }, 'INVALID_EMAIL');
                    log('error', 'âŒ Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´Ø¯');
                } catch (error) {
                    log('success', `âœ… validation Ú©Ø§Ø± Ú©Ø±Ø¯: ${error.message}`);
                }
                
                // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† validator
                stateManager.setValidator(null);
                try {
                    stateManager.setState({
                        user: { id: 'invalid' }
                    }, 'NO_VALIDATION');
                    log('success', 'âœ… validator ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯');
                } catch (error) {
                    log('error', `âŒ Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÛŒâ€ŒØ´Ø¯: ${error.message}`);
                }
                
            } catch (error) {
                log('error', `Ø®Ø·Ø§: ${error.message}`);
            }
        }
        
        // Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§
        async function runAllTests() {
            clearOutput();
            log('info', 'ğŸ¬ Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Manager...');
            
            await testUndoRedo();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testMiddleware();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testSnapshot();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testPerformance();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testValidation();
            
            log('success', 'ğŸ‰ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!');
        }
        
        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        log('info', 'ğŸš€ Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Manager Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.');
    </script>
</body>
</html>
