<!DOCTYPE html>
<html>
<head>
    <title>ØªØ³Øª Ø³Ø§Ø¯Ù‡ EventBus</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; }
        .success { color: green; }
        .error { color: red; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ØªØ³Øª Ø³Ø§Ø¯Ù‡ EventBus</h1>
    
    <button onclick="testEventBus()">Ø´Ø±ÙˆØ¹ ØªØ³Øª EventBus</button>
    <button onclick="clearLog()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
    
    <div id="log" class="log"></div>

    <script>
        // Ø§ÙˆÙ„ Ú©Ø¯ event-bus.js Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØ¢ÙˆØ±ÛŒÙ…
        // ==================== EVENT BUS CODE ====================
        class EventBus {
            constructor() {
                this.subscriptions = new Map();
                this.middlewares = [];
            }

            async publish(eventType, eventData, options = {}) {
                const subscribers = this.subscriptions.get(eventType) || [];
                
                console.log(`ğŸ“¢ Publishing: ${eventType}`, eventData);
                this.log(`ğŸ“¢ Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯: ${eventType}`);
                
                for (const subscriber of subscribers) {
                    try {
                        await subscriber(eventData, options);
                    } catch (error) {
                        console.error(`Error in subscriber:`, error);
                    }
                }
            }

            subscribe(eventType, callback) {
                if (!this.subscriptions.has(eventType)) {
                    this.subscriptions.set(eventType, []);
                }
                
                this.subscriptions.get(eventType).push(callback);
                this.log(`âœ… Ø«Ø¨Øª listener Ø¨Ø±Ø§ÛŒ: ${eventType}`);
                
                // Return unsubscribe function
                return () => {
                    const subscribers = this.subscriptions.get(eventType) || [];
                    const index = subscribers.indexOf(callback);
                    if (index > -1) {
                        subscribers.splice(index, 1);
                        this.log(`ğŸ—‘ï¸ Ø­Ø°Ù listener Ø¨Ø±Ø§ÛŒ: ${eventType}`);
                    }
                };
            }
            
            log(message) {
                const logEl = document.getElementById('log');
                logEl.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${message}</div>`;
            }
        }
        // ==================== END EVENT BUS ====================

        let eventBus = null;
        
        function testEventBus() {
            const logEl = document.getElementById('log');
            logEl.innerHTML = '<div>ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ³Øª EventBus...</div>';
            
            try {
                // 1. Ø³Ø§Ø®Øª EventBus
                eventBus = new EventBus();
                eventBus.log('âœ… EventBus Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯');
                
                // 2. Ø³Ø§Ø®Øª ÛŒÚ© listener Ø³Ø§Ø¯Ù‡
                const listener = (data, options) => {
                    eventBus.log(`ğŸ“© Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: ${JSON.stringify(data)}`);
                    console.log('Event received:', data);
                };
                
                // 3. Ø«Ø¨Øª listener
                const unsubscribe = eventBus.subscribe('user.login', listener);
                
                // 4. Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯
                setTimeout(() => {
                    eventBus.publish('user.login', {
                        userId: 'test123',
                        email: 'test@example.com'
                    }, { source: 'test' });
                }, 1000);
                
                // 5. ØªØ³Øª unsubscribe
                setTimeout(() => {
                    unsubscribe();
                    eventBus.log('âœ… listener Ø­Ø°Ù Ø´Ø¯');
                    
                    // Ø§Ù†ØªØ´Ø§Ø± Ø¯ÙˆØ¨Ø§Ø±Ù‡ (Ø¨Ø§ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´ÙˆØ¯)
                    setTimeout(() => {
                        eventBus.publish('user.login', {
                            userId: 'test456'
                        });
                        eventBus.log('âš ï¸ Ø§ÛŒÙ† Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø§ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´ÙˆØ¯ (listener Ø­Ø°Ù Ø´Ø¯Ù‡)');
                    }, 500);
                }, 2000);
                
                // 6. ØªØ³Øª Ú†Ù†Ø¯ listener
                const listener2 = (data) => {
                    eventBus.log(`ğŸ“© Listener 2 Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯: ${data.userId}`);
                };
                
                const listener3 = (data) => {
                    eventBus.log(`ğŸ“© Listener 3 Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯: ${data.userId}`);
                };
                
                eventBus.subscribe('user.update', listener2);
                eventBus.subscribe('user.update', listener3);
                
                setTimeout(() => {
                    eventBus.publish('user.update', {
                        userId: 'multi123',
                        name: 'John Doe'
                    });
                }, 3000);
                
                eventBus.log('ğŸ‰ ØªØ³Øª EventBus Ú©Ø§Ù…Ù„ Ø´Ø¯!');
                
            } catch (error) {
                logEl.innerHTML += `<div class="error">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
                console.error('Test error:', error);
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
    </script>
</body>
</html>
