<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ - Vakamova</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:tahoma;background:#0d47a1;color:#333;padding:20px}.container{max-width:800px;margin:auto;background:#fff;border-radius:10px;overflow:hidden}header{background:#1565c0;color:#fff;padding:20px;text-align:center}h1{font-size:1.5rem}.test-section{padding:20px}.test-item{background:#f5f5f5;border-radius:8px;padding:15px;margin-bottom:15px;border-right:5px solid #5c6bc0}.passed{border-right-color:#43a047;background:#e8f5e9}.failed{border-right-color:#e53935;background:#ffebee}.running{border-right-color:#fb8c00;background:#fff3e0}.test-header{display:flex;justify-content:space-between;margin-bottom:10px}.test-name{font-weight:bold}.test-status{padding:3px 10px;border-radius:12px;font-size:.8rem}.status-pending{background:#fff9c4;color:#f57c00}.status-running{background:#bbdefb;color:#1565c0}.status-passed{background:#c8e6c9;color:#2e7d32}.status-failed{background:#ffcdd2;color:#c62828}button{background:#1565c0;color:#fff;border:none;padding:12px 25px;border-radius:8px;font-size:1rem;cursor:pointer;width:100%;margin-top:15px}button:hover{background:#0d47a1}.console{background:#263238;color:#80cbc4;padding:15px;margin-top:20px;border-radius:8px;font-family:monospace;font-size:.9rem;max-height:200px;overflow-y:auto}.log{padding:5px 0;border-bottom:1px solid #37474f}.stats{display:flex;justify-content:space-around;background:#e3f2fd;padding:10px;border-radius:8px;margin-bottom:15px}.stat-item{text-align:center}.stat-value{font-size:1.2rem;font-weight:bold}.stat-label{font-size:.8rem;color:#546e7a}
    </style>
</head>
<body>
    <div class="container">
        <header><h1>âš¡ ØªØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ - Atomic Operations</h1></header>
        <div class="test-section">
            <div class="stats">
                <div class="stat-item"><div class="stat-value" id="stat-users">0</div><div class="stat-label">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div></div>
                <div class="stat-item"><div class="stat-value" id="stat-lessons">0</div><div class="stat-label">Ø¯Ø±Ø³â€ŒÙ‡Ø§</div></div>
                <div class="stat-item"><div class="stat-value" id="stat-transactions">0</div><div class="stat-label">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</div></div>
                <div class="stat-item"><div class="stat-value" id="stat-progress">0</div><div class="stat-label">Ù¾ÛŒØ´Ø±ÙØª</div></div>
            </div>
            
            <div class="test-item" id="test1">
                <div class="test-header"><div class="test-name">Û±. ØªØ±Ø§Ú©Ù†Ø´ Ø§ØªÙ…ÛŒ Ø®Ø±ÛŒØ¯ Ø¯Ø±Ø³</div><div class="test-status status-pending" id="status1">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output1"></div>
            </div>
            <div class="test-item" id="test2">
                <div class="test-header"><div class="test-name">Û². Rollback ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚</div><div class="test-status status-pending" id="status2">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output2"></div>
            </div>
            <div class="test-item" id="test3">
                <div class="test-header"><div class="test-name">Û³. CRUD Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±</div><div class="test-status status-pending" id="status3">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output3"></div>
            </div>
            <div class="test-item" id="test4">
                <div class="test-header"><div class="test-name">Û´. CRUD ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª</div><div class="test-status status-pending" id="status4">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output4"></div>
            </div>
            <div class="test-item" id="test5">
                <div class="test-header"><div class="test-name">Ûµ. ØªØ±Ø§Ú©Ù†Ø´ Ú†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ</div><div class="test-status status-pending" id="status5">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output5"></div>
            </div>
            
            <button id="run-btn">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button id="reset-btn" style="background:#546e7a;margin-top:10px">ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³</button>
            
            <div class="console" id="console">
                <div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§ØªÙ…ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>
            </div>
        </div>
    </div>

<script>
// ========== Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Mock Ø¨Ø±Ø§ÛŒ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ ==========
const TransactionDB = {
    users: new Map(),
    lessons: new Map(),
    progress: new Map(),
    transactions: new Map(),
    nextId: { users: 1, lessons: 1, transactions: 1 },
    
    // Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
    createUser(email, name, coins = 100) {
        const user = {
            id: this.nextId.users++,
            email,
            name,
            coins,
            level: 1,
            createdAt: new Date()
        };
        this.users.set(user.id, user);
        this.log(`ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± "${name}" Ø¨Ø§ ${coins} Ø³Ú©Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
        this.updateStats();
        return user;
    },
    
    // Ø³Ø§Ø®Øª Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯
    createLesson(title, language, price = 50) {
        const lesson = {
            id: this.nextId.lessons++,
            title,
            language,
            price,
            difficulty: 'beginner',
            createdAt: new Date()
        };
        this.lessons.set(lesson.id, lesson);
        this.log(`ğŸ“š Ø¯Ø±Ø³ "${title}" Ø¨Ø§ Ù‚ÛŒÙ…Øª ${price} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
        this.updateStats();
        return lesson;
    },
    
    // Ø³Ø§Ø®Øª Ø±Ú©ÙˆØ±Ø¯ Ù¾ÛŒØ´Ø±ÙØª
    createProgress(userId, lessonId, score = 0) {
        const key = `${userId}_${lessonId}`;
        const progress = {
            user_id: userId,
            lesson_id: lessonId,
            score,
            completed: score >= 80,
            time_spent: 0,
            updated_at: new Date()
        };
        this.progress.set(key, progress);
        this.log(`ğŸ“ˆ Ù¾ÛŒØ´Ø±ÙØª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± ${userId} Ùˆ Ø¯Ø±Ø³ ${lessonId} Ø«Ø¨Øª Ø´Ø¯`);
        this.updateStats();
        return progress;
    },
    
    // Ø³Ø§Ø®Øª ØªØ±Ø§Ú©Ù†Ø´ Ù¾Ø±Ø¯Ø§Ø®Øª
    createTransaction(userId, lessonId, amount) {
        const transaction = {
            id: this.nextId.transactions++,
            user_id: userId,
            lesson_id: lessonId,
            amount,
            status: 'completed',
            payment_method: 'zarinpal',
            created_at: new Date()
        };
        this.transactions.set(transaction.id, transaction);
        this.log(`ğŸ’³ ØªØ±Ø§Ú©Ù†Ø´ ${transaction.id} Ø¨Ø§ Ù…Ø¨Ù„Øº ${amount} Ø«Ø¨Øª Ø´Ø¯`);
        this.updateStats();
        return transaction;
    },
    
    // ========== Ù…Ù†Ø·Ù‚ ØªØ±Ø§Ú©Ù†Ø´ Ø§ØªÙ…ÛŒ ==========
    async purchaseLesson(userId, lessonId) {
        this.log(`ğŸ”„ Ø´Ø±ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ Ø®Ø±ÛŒØ¯: Ú©Ø§Ø±Ø¨Ø± ${userId} â†’ Ø¯Ø±Ø³ ${lessonId}`);
        
        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø¯Ø±Ø³
        const user = this.users.get(userId);
        const lesson = this.lessons.get(lessonId);
        
        if (!user) throw new Error('Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯');
        if (!lesson) throw new Error('Ø¯Ø±Ø³ ÛŒØ§ÙØª Ù†Ø´Ø¯');
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ
        if (user.coins < lesson.price) {
            throw new Error(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø§Ú©Ø§ÙÛŒ! Ú©Ø§Ø±Ø¨Ø± ${user.coins} Ø³Ú©Ù‡ Ø¯Ø§Ø±Ø¯ØŒ Ø§Ù…Ø§ Ø¯Ø±Ø³ ${lesson.price} Ø³Ú©Ù‡ Ù‚ÛŒÙ…Øª Ø¯Ø§Ø±Ø¯`);
        }
        
        // Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ú©Ø§Ù† rollback
        const originalCoins = user.coins;
        
        try {
            // Ù…Ø±Ø­Ù„Ù‡ Û±: Ú©Ø³Ø± Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø² Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±
            user.coins -= lesson.price;
            this.log(`ğŸ’° ${lesson.price} Ø³Ú©Ù‡ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ú©Ø³Ø± Ø´Ø¯. Ù…Ø§Ù†Ø¯Ù‡: ${user.coins}`);
            
            // Ù…Ø±Ø­Ù„Ù‡ Û²: Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ù¾Ø±Ø¯Ø§Ø®Øª
            const transaction = this.createTransaction(userId, lessonId, lesson.price);
            
            // Ù…Ø±Ø­Ù„Ù‡ Û³: Ø§ÛŒØ¬Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯ Ù¾ÛŒØ´Ø±ÙØª
            const progress = this.createProgress(userId, lessonId, 0);
            
            this.log(`âœ… ØªØ±Ø§Ú©Ù†Ø´ Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!`);
            return {
                success: true,
                user,
                lesson,
                transaction,
                progress
            };
            
        } catch (error) {
            // Rollback Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
            this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ±Ø§Ú©Ù†Ø´: ${error.message}`);
            user.coins = originalCoins; // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø³Ú©Ù‡â€ŒÙ‡Ø§
            this.log(`â†©ï¸ Rollback Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ ${originalCoins} Ø¨Ø§Ø²Ú¯Ø´Øª`);
            throw error;
        }
    },
    
    // ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³ Ùˆ Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²
    completeLesson(userId, lessonId, score, timeSpent = 3600) {
        const key = `${userId}_${lessonId}`;
        let progress = this.progress.get(key);
        
        if (!progress) {
            progress = this.createProgress(userId, lessonId, score);
        } else {
            progress.score = Math.max(progress.score, score);
            progress.completed = progress.score >= 80;
            progress.time_spent += timeSpent;
            progress.updated_at = new Date();
        }
        
        this.log(`ğŸ¯ Ø¯Ø±Ø³ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯! Ø§Ù…ØªÛŒØ§Ø²: ${progress.score} (${progress.completed ? 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡' : 'Ø¯Ø± Ø­Ø§Ù„ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ'})`);
        return progress;
    },
    
    // ========== Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ==========
    log(message) {
        console.log(`[TransactionDB] ${message}`);
        const consoleEl = document.getElementById('console');
        const logEntry = document.createElement('div');
        logEntry.className = 'log';
        logEntry.textContent = `${message}`;
        consoleEl.appendChild(logEntry);
        consoleEl.scrollTop = consoleEl.scrollHeight;
    },
    
    updateStats() {
        document.getElementById('stat-users').textContent = this.users.size;
        document.getElementById('stat-lessons').textContent = this.lessons.size;
        document.getElementById('stat-transactions').textContent = this.transactions.size;
        document.getElementById('stat-progress').textContent = this.progress.size;
    },
    
    reset() {
        this.users.clear();
        this.lessons.clear();
        this.progress.clear();
        this.transactions.clear();
        this.nextId = { users: 1, lessons: 1, transactions: 1 };
        this.log("â™»ï¸ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯");
        this.updateStats();
    }
};

// ========== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ØªØ±Ø§Ú©Ù†Ø´ ==========
const transactionTests = [
    {
        id: 'test1',
        name: 'ØªØ±Ø§Ú©Ù†Ø´ Ø§ØªÙ…ÛŒ Ø®Ø±ÛŒØ¯ Ø¯Ø±Ø³',
        description: 'Ú©Ø³Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ + Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ + Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´Ø±ÙØª',
        run: async () => {
            TransactionDB.reset();
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Øª
            const user = TransactionDB.createUser('buyer@vakamova.com', 'Ø®Ø±ÛŒØ¯Ø§Ø± ØªØ³Øª', 200);
            const lesson = TransactionDB.createLesson('Ú¯Ø±Ø§Ù…Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡', 'english', 150);
            
            // Ø§Ø¬Ø±Ø§ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ø®Ø±ÛŒØ¯
            const result = await TransactionDB.purchaseLesson(user.id, lesson.id);
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªØ§ÛŒØ¬
            if (!result.success) throw new Error('ØªØ±Ø§Ú©Ù†Ø´ Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯');
            if (user.coins !== 50) throw new Error(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ 50 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${user.coins} Ø§Ø³Øª`);
            if (!result.transaction) throw new Error('ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øª Ù†Ø´Ø¯');
            if (!result.progress) throw new Error('Ù¾ÛŒØ´Ø±ÙØª Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯');
            
            return `âœ… Ø®Ø±ÛŒØ¯ Ù…ÙˆÙÙ‚! ${user.coins} Ø³Ú©Ù‡ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡.`;
        }
    },
    {
        id: 'test2',
        name: 'Rollback ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚',
        description: 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ',
        run: async () => {
            TransactionDB.reset();
            
            const user = TransactionDB.createUser('poor@test.com', 'Ú©Ø§Ø±Ø¨Ø± Ú©Ù… Ù…ÙˆØ¬ÙˆØ¯ÛŒ', 50);
            const lesson = TransactionDB.createLesson('Ø¯Ø±Ø³ Ú¯Ø±Ø§Ù†', 'french', 100);
            
            const initialCoins = user.coins;
            
            try {
                await TransactionDB.purchaseLesson(user.id, lesson.id);
                throw new Error('Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ÛŒ "Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø§Ú©Ø§ÙÛŒ" Ù…ÛŒâ€ŒØ¯Ø§Ø¯!');
            } catch (error) {
                if (!error.message.includes('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø§Ú©Ø§ÙÛŒ')) {
                    throw new Error(`Ø®Ø·Ø§ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡: ${error.message}`);
                }
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ rollback
            if (user.coins !== initialCoins) {
                throw new Error(`Rollback Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯! Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø§ÛŒØ¯ ${initialCoins} Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${user.coins} Ø§Ø³Øª`);
            }
            
            return `âœ… Rollback Ù…ÙˆÙÙ‚! Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ù…Ø§Ù†Ø¯ (${user.coins} Ø³Ú©Ù‡)`;
        }
    },
    {
        id: 'test3',
        name: 'CRUD Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±',
        description: 'Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù',
        run: async () => {
            TransactionDB.reset();
            
            const user = TransactionDB.createUser('progress@test.com', 'Ú©Ø§Ø±Ø¨Ø± Ù¾Ø±ØªÙ„Ø§Ø´');
            const lesson1 = TransactionDB.createLesson('ÙˆØ§Ú˜Ú¯Ø§Ù†', 'persian', 30);
            const lesson2 = TransactionDB.createLesson('Ù…Ú©Ø§Ù„Ù…Ù‡', 'english', 40);
            
            // Ø®Ø±ÛŒØ¯ Ø¯Ùˆ Ø¯Ø±Ø³
            await TransactionDB.purchaseLesson(user.id, lesson1.id);
            await TransactionDB.purchaseLesson(user.id, lesson2.id);
            
            // ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø¨Ø§ Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
            const progress1 = TransactionDB.completeLesson(user.id, lesson1.id, 90);
            const progress2 = TransactionDB.completeLesson(user.id, lesson2.id, 70);
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªØ§ÛŒØ¬
            if (!progress1.completed) throw new Error('Ø¯Ø±Ø³ Ø§ÙˆÙ„ Ø¨Ø§ÛŒØ¯ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯');
            if (progress2.completed) throw new Error('Ø¯Ø±Ø³ Ø¯ÙˆÙ… Ù†Ø¨Ø§ÛŒØ¯ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ (Ø§Ù…ØªÛŒØ§Ø² 70)');
            if (progress1.score !== 90) throw new Error('Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø±Ø³ Ø§ÙˆÙ„ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
            
            return `âœ… Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØª Ù…ÙˆÙÙ‚! ${progress1.completed ? 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡' : 'Ø¯Ø± Ø­Ø§Ù„ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ'}`;
        }
    },
    {
        id: 'test4',
        name: 'CRUD ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª',
        description: 'Ø«Ø¨Øª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ',
        run: async () => {
            TransactionDB.reset();
            
            const user = TransactionDB.createUser('payer@test.com', 'Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡');
            const lesson = TransactionDB.createLesson('Ø¢Ù…ÙˆØ²Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ', 'german', 75);
            
            // Ø§ÛŒØ¬Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø³ØªÛŒ
            const transaction = TransactionDB.createTransaction(user.id, lesson.id, 75);
            
            // Ø¨Ø±Ø±Ø³ÛŒ ØªØ±Ø§Ú©Ù†Ø´
            if (transaction.status !== 'completed') throw new Error('ÙˆØ¶Ø¹ÛŒØª ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ÛŒØ¯ completed Ø¨Ø§Ø´Ø¯');
            if (transaction.amount !== 75) throw new Error('Ù…Ø¨Ù„Øº ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
            if (!transaction.created_at) throw new Error('ØªØ§Ø±ÛŒØ® ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øª Ù†Ø´Ø¯');
            
            // Ø´Ù…Ø§Ø±Ø´ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
            const transactionCount = TransactionDB.transactions.size;
            
            return `âœ… ØªØ±Ø§Ú©Ù†Ø´ ${transaction.id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ (Ù…Ø¬Ù…ÙˆØ¹: ${transactionCount} ØªØ±Ø§Ú©Ù†Ø´)`;
        }
    },
    {
        id: 'test5',
        name: 'ØªØ±Ø§Ú©Ù†Ø´ Ú†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ',
        description: 'Ø®Ø±ÛŒØ¯ Ú†Ù†Ø¯ Ø¯Ø±Ø³ + ØªÚ©Ù…ÛŒÙ„ + Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ',
        run: async () => {
            TransactionDB.reset();
            
            const user = TransactionDB.createUser('multi@test.com', 'Ú©Ø§Ø±Ø¨Ø± Ú†Ù†Ø¯Ø®Ø±ÛŒØ¯', 300);
            const lessons = [
                TransactionDB.createLesson('Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ', 'english', 50),
                TransactionDB.createLesson('Ù…ØªÙˆØ³Ø·', 'english', 75),
                TransactionDB.createLesson('Ù¾ÛŒØ´Ø±ÙØªÙ‡', 'english', 100)
            ];
            
            const initialCoins = user.coins;
            let totalSpent = 0;
            
            // Ø®Ø±ÛŒØ¯ Ù‡Ù…Ù‡ Ø¯Ø±Ø³â€ŒÙ‡Ø§
            for (const lesson of lessons) {
                await TransactionDB.purchaseLesson(user.id, lesson.id);
                totalSpent += lesson.price;
            }
            
            // ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³â€ŒÙ‡Ø§
            TransactionDB.completeLesson(user.id, lessons[0].id, 95);
            TransactionDB.completeLesson(user.id, lessons[1].id, 85);
            TransactionDB.completeLesson(user.id, lessons[2].id, 60);
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ
            const expectedCoins = initialCoins - totalSpent;
            if (user.coins !== expectedCoins) {
                throw new Error(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø´ØªØ¨Ø§Ù‡! Ø¨Ø§ÛŒØ¯ ${expectedCoins} Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${user.coins} Ø§Ø³Øª`);
            }
            
            const progressCount = TransactionDB.progress.size;
            if (progressCount !== 3) throw new Error(`Ø¨Ø§ÛŒØ¯ 3 Ø±Ú©ÙˆØ±Ø¯ Ù¾ÛŒØ´Ø±ÙØª Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${progressCount} Ø§Ø³Øª`);
            
            return `âœ… ${lessons.length} Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! ${user.coins} Ø³Ú©Ù‡ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡.`;
        }
    }
];

// ========== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ==========
async function runAllTransactionTests() {
    const btn = document.getElementById('run-btn');
    btn.disabled = true;
    btn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ØªØ±Ø§Ú©Ù†Ø´...';
    
    let passed = 0;
    
    for (let i = 0; i < transactionTests.length; i++) {
        const test = transactionTests[i];
        const testEl = document.getElementById(test.id);
        const statusEl = document.getElementById(`status${i+1}`);
        const outputEl = document.getElementById(`output${i+1}`);
        
        // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§
        testEl.className = 'test-item running';
        statusEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
        statusEl.className = 'test-status status-running';
        outputEl.innerHTML = '<span style="color:#666">Ø´Ø±ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´...</span>';
        
        try {
            const result = await test.run();
            
            // ØªØ³Øª Ù…ÙˆÙÙ‚
            testEl.className = 'test-item passed';
            statusEl.textContent = 'Ù…ÙˆÙÙ‚';
            statusEl.className = 'test-status status-passed';
            outputEl.innerHTML = `<div style="color:#2e7d32">${result}</div>`;
            passed++;
            
        } catch (error) {
            // ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚
            testEl.className = 'test-item failed';
            statusEl.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
            statusEl.className = 'test-status status-failed';
            outputEl.innerHTML = `<div style="color:#c62828">âŒ ${error.message}</div>`;
        }
        
        // ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
        await new Promise(resolve => setTimeout(resolve, 600));
    }
    
    btn.disabled = false;
    btn.textContent = `ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ (${passed}/${transactionTests.length} Ù…ÙˆÙÙ‚)`;
    
    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
    TransactionDB.log(`Ù†ØªØ§ÛŒØ¬ ØªØ³Øª ØªØ±Ø§Ú©Ù†Ø´: ${passed} Ø§Ø² ${transactionTests.length} ØªØ³Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯`);
    if (passed === transactionTests.length) {
        TransactionDB.log("ğŸ‰ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø´Øª Ø³Ø± Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯Ù†Ø¯!");
    }
}

// ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ==========
document.addEventListener('DOMContentLoaded', () => {
    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    document.getElementById('run-btn').addEventListener('click', runAllTransactionTests);
    document.getElementById('reset-btn').addEventListener('click', () => {
        TransactionDB.reset();
        // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª ØªØ³Øªâ€ŒÙ‡Ø§
        for (let i = 1; i <= 5; i++) {
            const testEl = document.getElementById(`test${i}`);
            const statusEl = document.getElementById(`status${i}`);
            const outputEl = document.getElementById(`output${i}`);
            
            testEl.className = 'test-item';
            statusEl.textContent = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
            statusEl.className = 'test-status status-pending';
            outputEl.innerHTML = '';
        }
        document.getElementById('run-btn').textContent = 'â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§';
    });
    
    TransactionDB.log("Ø³ÛŒØ³ØªÙ… ØªØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§ØªÙ…ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.");
    TransactionDB.log("Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.");
    TransactionDB.updateStats();
});
</script>
</body>
</html>
