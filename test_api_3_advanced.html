// ========== تست 4: Retry Logic ==========
async function runRetryTest() {
    const btn = event.target;
    const resultDiv = document.getElementById('result4');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> در حال اجرای تست Retry...';
    resultDiv.className = 'result';
    resultDiv.innerHTML = '';
    
    try {
        // فعال کردن خطای موقت برای ۲ بار اول
        api.simulateTemporaryFailure = true;
        api.failureCount = 0;
        
        const startTime = Date.now();
        const result = await api.getWithRetry('/unstable-endpoint', 3);
        const totalTime = Date.now() - startTime;
        
        // غیرفعال کردن خطای موقت
        api.simulateTemporaryFailure = false;
        
        // بررسی منطقی‌تر
        const expectedAttempts = 3; // باید ۳ بار تلاش کرده باشد
        const isSuccess = result.attempts === expectedAttempts;
        
        if (isSuccess) {
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `
                <strong>✅ تست Retry Logic کامل شد!</strong><br><br>
                <strong>نتایج:</strong><br>
                • تعداد تلاش‌ها: <strong>${result.attempts} بار</strong><br>
                • زمان کل: ${totalTime}ms<br>
                • خطاهای شبیه‌سازی شده: ${api.failureCount} بار<br>
                • Exponential Backoff اعمال شد<br><br>
                <small>✅ Retry Logic به درستی کار می‌کند</small>
            `;
            
            testResults.retry = { attempts: result.attempts, totalTime, success: true };
        } else {
            throw new Error(`تعداد تلاش‌ها ${result.attempts} است (انتظار: ${expectedAttempts})`);
        }
        
        updateGlobalStats();
        
    } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
            <strong>⚠️ تست Retry Logic نیاز به تنظیم دارد</strong><br><br>
            خطا: ${error.message}<br>
            • مشکل: تعداد خطاهای شبیه‌سازی شده کافی نبود<br>
            • راه حل: افزایش failureCount یا تنظیم logic<br><br>
            <small>برای رفع: api.failureCount = 0 را بعد از هر تست ریست کنید</small>
        `;
        
        testResults.retry = { success: false, error: error.message };
    }
    
    btn.disabled = false;
    btn.textContent = 'اجرای تست Retry';
}
